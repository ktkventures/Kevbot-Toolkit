# Alert Reliability Debug Log

## Goal
Iteratively identify and fix alert matching discrepancies until the system reliably matches streaming/intra-bar alerts to forward test trades with zero (or near-zero) false discrepancies.

## Architecture Reference
- **Streaming engine** (`realtime_engine.py`): fires alerts in real-time via trade stream + bar close
- **Alert storage** (`alerts.json`): each alert has `timestamp`, `bar_time`, `source`, `trigger`, `strategy_id`, `type` (entry_signal/exit_signal)
- **Trade storage** (`strategies.json` → `stored_trades`): generated by backtest pipeline (indicators → interpreters → triggers → generate_trades)
- **Matching** (`alerts.py:match_alerts_to_trades()`): pairs alerts to trades within a time window (`max(300, bar_period * 5)` seconds)
- **Discrepancies**: `missed_alert` = trade with no alert, `phantom_alert` = alert with no trade

## Key Timestamps
- Trades use **candle bar start time** (e.g., 20:16:00 for a 1-min bar)
- Bar-close alerts fire at **bar close + latency** (e.g., 20:17:00.2 for a 1-min bar starting at 20:16:00)
- Intra-bar alerts fire **within the candle** (e.g., 20:16:09 for a bar at 20:16:00)

## Strategies Under Test
| ID | Name | Timeframe | Symbol | Notes |
|----|------|-----------|--------|-------|
| 24 | SPY 1m crazy results (Copy) | 1Min | SPY | UT Bot, fast cycling |
| 28 | TSLA LONG - v2 S Cross | 1Min | TSLA | EMA cross |
| 31 | NVDA [I] Alert Test | 1Min | NVDA | UT Bot v2 |
| (others with alert_tracking_enabled) | | | | |

---

## Iteration 1: Initial Reset Bug
**Date:** 2026-02-25 ~20:15 UTC
**Observation:** After "Reset All Alerts", all strategies immediately showed dozens of missed alerts with entry times going back hours.
**Root Cause:** `alert_tracking_reset_at` was used to filter trades out of the matching algorithm. ALL trades before reset became invisible → old trades = missed alerts.
**Fix:** N/A (recognized quickly, moved to Iteration 2)

## Iteration 2: Reset Filter on Wrong Layer
**Date:** 2026-02-25 ~20:30 UTC
**Observation:** 12 phantom alerts across 3 strategies (SPY=6, TSLA=2, NVDA=4). All phantom, zero missed. Alerts firing correctly but couldn't find matching trades.
**Root Cause:** `alert_tracking_reset_at` filtered trades from the MATCHING step, preventing new alerts from matching old trades in `stored_trades`. New alert at 20:16 couldn't see trade at 20:13.
**Fix Applied:**
- Moved reset filter from trade selection → discrepancy detection only
- `alerts.py`: `ft_trades` now includes ALL forward test trades (no reset filter)
- `alerts.py`: Missed alerts skip trades before `_reset_dt`; phantom alerts skip alerts before `_reset_dt`
- `app.py`: Removed reset filter from `_compute_alert_analysis()` trade selection
- Cleared false-positive discrepancies on 3 strategies
**Status:** Fix deployed, monitoring for 15 minutes starting ~13:35 UTC (20:35 UTC)

## Iteration 3: Post-Fix Observation (20 min soak)
**Date:** 2026-02-25 ~21:00 UTC (20 min after fix)
**Observation:**
- 0 discrepancies across all 14 strategies (good — no false positives)
- 0 live_executions across all 14 strategies
- 85 alerts in alerts.json (41 entry, 44 exit across 6 strategies)
- Streaming engine healthy, running since 13:40 UTC, no recent errors
- Only 1 trade after reset across all strategies (Strategy 24)

**Key Insight:** `match_alerts_to_trades()` is ONLY called from `refresh_strategy_data()` in app.py — which runs when the user visits a strategy detail page or clicks "Update Data". The streaming engine only writes to alerts.json; it does NOT trigger reconciliation. So alerts accumulate but matching hasn't run yet.

**Alert counts by strategy:**
| Strategy | Entry | Exit | Total |
|----------|-------|------|-------|
| 24 (SPY Copy) | 9 | 9 | 18 |
| 28 (TSLA Cross) | 6 | 7 | 13 |
| 29 (GME UT Bot) | 8 | 8 | 16 |
| 30 (INTC Max) | 5 | 5 | 10 |
| 31 (NVDA Alert) | 7 | 8 | 15 |
| 32 (INTC Solid) | 6 | 7 | 13 |

**Status:** No false discrepancies generated — reset filter is working. Need user to visit strategy detail pages (or click Update Data) to trigger reconciliation and see if matching works correctly.

## Iteration 4: [Pending — after user triggers reconciliation]
**Goal:** Check if alerts correctly match to trades once reconciliation runs
**Data to collect:**
- [ ] live_executions count and timing deltas after visiting strategy detail pages
- [ ] Any new discrepancies (missed or phantom) after reconciliation
- [ ] Quality of matched trades (timing deltas)
**Root Cause:** TBD
**Fix:** TBD

---

## Analysis Checklist (run each iteration)
1. `strategies.json`: count live_executions and discrepancies per strategy
2. `alerts.json`: count alerts grouped by strategy_id and type
3. `streaming_engine.log`: last 200 lines for errors/warnings
4. Cross-reference: do phantom alerts have a plausible matching trade nearby?
5. Cross-reference: do missed trades have a plausible matching alert nearby?
6. Check timing: entry deltas and exit deltas on matched trades
