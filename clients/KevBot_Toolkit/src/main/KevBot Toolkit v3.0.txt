// KevBot Toolkit v3.0 – AND/OR Confluence Architecture
//
// V3 ARCHITECTURE OVERVIEW:
//   • Direction-specific: User selects Long OR Short at top (not both)
//   • AND/OR Groups: Conditions assigned to AND, OR1, OR2, or OR3 groups
//   • Centralized Triggers: Single Entry Trigger and Exit Trigger dropdown
//   • Per-Condition-Per-TF: Each condition on each TF can be assigned to a group
//   • Auto-Ordered Side Table: Libraries appear in order they're enabled
//   • No Grades: Removed threshold-based scoring entirely
//
// ENTRY LOGIC:
//   Entry Valid = (AND Group ALL true)
//                 AND (OR1 meets minimum)
//                 AND (OR2 meets minimum)
//                 AND (OR3 meets minimum)
//                 AND (Entry Trigger fires)
//
// See docs/KevBot_Toolkit_v3_Vision.md for detailed architecture documentation.

//──────────────────────────────────────────────────────────────────────────────
// KevBot Toolkit v3.0 – AND/OR CONFLUENCE ARCHITECTURE
//──────────────────────────────────────────────────────────────────────────────

//@version=6
indicator("KevBot Toolkit v3.0 – AND/OR Confluence", overlay = true, max_labels_count = 500)
plot(na, title="placeholder", display=display.none)

import yamigushi/KevBot_TimeUtils/1 as tu
import yamigushi/KevBot_TF_EMA_Stack/7 as tfEMAStack       // v7 uses buildOutput() hybrid approach
import yamigushi/KevBot_TF_RVOL/1 as tfRVOL
import yamigushi/KevBot_TF_UTBot/1 as tfUTBot
import yamigushi/KevBot_TF_Swing123/1 as tfSwing123
import yamigushi/KevBot_TF_MACD_Line/1 as tfMACDLine
import yamigushi/KevBot_TF_MACD_Histogram/1 as tfMACDHistogram
import yamigushi/KevBot_TF_MACD_Simple/1 as tfMACDSimple
import yamigushi/KevBot_TF_VWAP/1 as tfVWAP


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 1. GLOBAL TOOLKIT SETTINGS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

string GRP_GLOBAL = "1. Global Toolkit Settings"
string positionDirection = input.string("Long", "Position Direction", options = ["Long", "Short"], group = GRP_GLOBAL, tooltip = "Select whether this toolkit trades Long or Short positions. For both directions, run two separate toolkits.")
bool   enableTopTable    = input.bool(true,  "Enable Top Table",      group = GRP_GLOBAL, tooltip = "Show or hide the top-of-chart table displaying confluence status.")
bool   enableSideTable   = input.bool(true,  "Enable Side Table",     group = GRP_GLOBAL, tooltip = "Show or hide the right-side multi-timeframe table.")
bool   useDarkTheme      = input.bool(true,  "Use Dark Theme Colors", group = GRP_GLOBAL, tooltip = "Enable the KevBot Toolkit dark color theme.")

// Derived direction flags
bool isLongDirection  = positionDirection == "Long"
bool isShortDirection = positionDirection == "Short"

//──────────────────────────────────────────────────────────────────────────────
// 1.1 Timeframe Configuration
//──────────────────────────────────────────────────────────────────────────────

string GRP_TF = "1.1 Timeframe Configuration"

bool   tf1_enabled = input.bool(true, "TF 1", group = GRP_TF, inline = "tf_row1", tooltip = "Enable this timeframe for confluence evaluation.")
string tf1         = input.timeframe("1", "", group = GRP_TF, inline = "tf_row1")

bool   tf2_enabled = input.bool(true, "TF 2", group = GRP_TF, inline = "tf_row1")
string tf2         = input.timeframe("5", "", group = GRP_TF, inline = "tf_row1")

bool   tf3_enabled = input.bool(true, "TF 3", group = GRP_TF, inline = "tf_row2")
string tf3         = input.timeframe("15", "", group = GRP_TF, inline = "tf_row2")

bool   tf4_enabled = input.bool(true, "TF 4", group = GRP_TF, inline = "tf_row2")
string tf4         = input.timeframe("60", "", group = GRP_TF, inline = "tf_row2")

bool   tf5_enabled = input.bool(true, "TF 5", group = GRP_TF, inline = "tf_row3")
string tf5         = input.timeframe("240", "", group = GRP_TF, inline = "tf_row3")

bool   tf6_enabled = input.bool(true, "TF 6", group = GRP_TF, inline = "tf_row3")
string tf6         = input.timeframe("D", "", group = GRP_TF, inline = "tf_row3")

//──────────────────────────────────────────────────────────────────────────────
// 1.2 Confluence Group Settings
//──────────────────────────────────────────────────────────────────────────────

string GRP_CONF = "1.2 Confluence Group Settings"
int    conf_or1_min = input.int(1, "OR1: Minimum Required", minval = 1, maxval = 20, group = GRP_CONF, tooltip = "Minimum number of OR1 conditions that must be true.")
int    conf_or2_min = input.int(1, "OR2: Minimum Required", minval = 1, maxval = 20, group = GRP_CONF, tooltip = "Minimum number of OR2 conditions that must be true.")
int    conf_or3_min = input.int(1, "OR3: Minimum Required", minval = 1, maxval = 20, group = GRP_CONF, tooltip = "Minimum number of OR3 conditions that must be true.")


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 2. ENTRY/EXIT CONFIGURATION (Centralized)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

string GRP_ENTRY = "2. Entry/Exit Configuration"

// Master trigger dropdowns - options populated based on all available library triggers
string entryTrigger = input.string("UT Bot: Buy", "Entry Trigger", options = [
    "None",
    "───── EMA Stack ─────",
    "EMA: S > M Cross",
    "EMA: S < M Cross",
    "EMA: S > L Cross",
    "EMA: S < L Cross",
    "EMA: M > L Cross",
    "EMA: M < L Cross",
    "───── UT Bot ─────",
    "UT Bot: Buy",
    "UT Bot: Sell",
    "───── RVOL ─────",
    "RVOL: Volume Spike",
    "RVOL: Volume Extreme",
    "RVOL: Volume Fade",
    "───── Swing 123 ─────",
    "Swing: BC2",
    "Swing: BC3",
    "Swing: XC2",
    "Swing: XC3",
    "───── MACD Line ─────",
    "MACD Line: Bullish Cross",
    "MACD Line: Bearish Cross",
    "MACD Line: Zero Cross Up",
    "MACD Line: Zero Cross Down",
    "───── MACD Histogram ─────",
    "MACD Hist: Flip Bullish",
    "MACD Hist: Flip Bearish",
    "MACD Hist: Shift Up",
    "MACD Hist: Shift Down",
    "───── Simple MACD ─────",
    "Simple MACD: Bullish Cross",
    "Simple MACD: Bearish Cross"
    ], group = GRP_ENTRY, tooltip = "Select the trigger that will initiate position entries when confluence conditions are met.")

string exitTrigger = input.string("UT Bot: Sell", "Exit Trigger", options = [
    "None",
    "───── EMA Stack ─────",
    "EMA: S > M Cross",
    "EMA: S < M Cross",
    "EMA: S > L Cross",
    "EMA: S < L Cross",
    "EMA: M > L Cross",
    "EMA: M < L Cross",
    "───── UT Bot ─────",
    "UT Bot: Buy",
    "UT Bot: Sell",
    "───── RVOL ─────",
    "RVOL: Volume Spike",
    "RVOL: Volume Extreme",
    "RVOL: Volume Fade",
    "───── Swing 123 ─────",
    "Swing: BC2",
    "Swing: BC3",
    "Swing: XC2",
    "Swing: XC3",
    "───── MACD Line ─────",
    "MACD Line: Bullish Cross",
    "MACD Line: Bearish Cross",
    "MACD Line: Zero Cross Up",
    "MACD Line: Zero Cross Down",
    "───── MACD Histogram ─────",
    "MACD Hist: Flip Bullish",
    "MACD Hist: Flip Bearish",
    "MACD Hist: Shift Up",
    "MACD Hist: Shift Down",
    "───── Simple MACD ─────",
    "Simple MACD: Bullish Cross",
    "Simple MACD: Bearish Cross"
    ], group = GRP_ENTRY, tooltip = "Select the trigger that will initiate position exits.")

bool   showRawEntryMarks = input.bool(true,  "Show Raw Entry Marks", group = GRP_ENTRY, tooltip = "Display chart marks when entry trigger fires (regardless of confluence).")
bool   showRawExitMarks  = input.bool(false, "Show Raw Exit Marks",  group = GRP_ENTRY, tooltip = "Display chart marks when exit trigger fires.")


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 3. POSITION SIZING MODULE
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

string GRP_POS = "3. Position Sizing Module"
bool   showSizer  = input.bool(true, "Show Position Sizing Module", group = GRP_POS, inline = "ps_row", tooltip = "Displays this module in the Top Table.")
string sizerName  = input.string("", "Custom Name", group = GRP_POS, inline = "ps_row")

//──────────────────────────────────────────────────────────────────────────────
// 3.1 Safety Stop Loss
//──────────────────────────────────────────────────────────────────────────────

string GRP_POS_SL = "3.1 Safety Stop Loss"
string sl_method  = input.string("ATR", "SL Method", options = ["ATR", "Fixed Dollar", "Percentage", "Candle Wicks", "Library Custom"], group = GRP_POS_SL, inline = "slrow", tooltip = "Safety stop-loss method.")
bool   sl_show    = input.bool(false, "Show SL on chart", group = GRP_POS_SL, inline = "slrow")
int    sl_atrPer  = input.int(14, "ATR Period", group = GRP_POS_SL)
float  sl_atrMult = input.float(2.0, "ATR Multiplier", group = GRP_POS_SL)
float  sl_fixed   = input.float(1.0, "Fixed Dollar Stop", group = GRP_POS_SL)
float  sl_pct     = input.float(1.0, "Percentage Stop", group = GRP_POS_SL)
int    sl_lookback = input.int(1, "Lo/Hi Lookback Bars", group = GRP_POS_SL)
float  sl_pad     = input.float(0.1, "Lo/Hi Padding", group = GRP_POS_SL)

//──────────────────────────────────────────────────────────────────────────────
// 3.2 Safety Take Profit
//──────────────────────────────────────────────────────────────────────────────

string GRP_POS_TP = "3.2 Safety Take Profit"
string tp_method  = input.string("Risk:Reward Target", "TP Method", options = ["Risk:Reward Target", "ATR", "Fixed Dollar", "Percentage", "Candle Wicks"], group = GRP_POS_TP, inline = "tprow")
bool   tp_show    = input.bool(false, "Show TP on chart", group = GRP_POS_TP, inline = "tprow")
float  tp_rr      = input.float(2.0, "R:R Target", group = GRP_POS_TP)
int    tp_atrPer  = input.int(14, "ATR Period", group = GRP_POS_TP)
float  tp_atrMult = input.float(2.0, "ATR Multiplier", group = GRP_POS_TP)
float  tp_fixed   = input.float(1.0, "Fixed Dollar Target", group = GRP_POS_TP)
float  tp_pct     = input.float(1.0, "Percentage Target", group = GRP_POS_TP)
int    tp_lookback = input.int(1, "Lo/Hi Lookback Bars", group = GRP_POS_TP)
float  tp_pad     = input.float(0.1, "Lo/Hi Padding", group = GRP_POS_TP)

//──────────────────────────────────────────────────────────────────────────────
// 3.3 Account & Risk
//──────────────────────────────────────────────────────────────────────────────

string GRP_POS_ACC = "3.3 Account / Risk Configuration"
float  acctSize    = input.float(25000, "Account Size", group = GRP_POS_ACC)
string riskMode    = input.string("Fixed $ Risk", "Risk Mode", options = ["Share Qty", "Fixed $ Risk", "Percentage Risk"], group = GRP_POS_ACC)
int    defShares   = input.int(100, "Default Share Qty", group = GRP_POS_ACC)
float  defRisk     = input.float(100, "Default Risk Value (Fixed)", group = GRP_POS_ACC)
float  defRiskPct  = input.float(1.0, "Default Risk Value (Percent)", group = GRP_POS_ACC)

//──────────────────────────────────────────────────────────────────────────────
// 3.4 Position Labels
//──────────────────────────────────────────────────────────────────────────────

string GRP_POS_LBL = "3.4 Position Labels"
bool   lbl_trigger = input.bool(true, "Show Trigger Label", group = GRP_POS_LBL, tooltip = "Display the trigger name on position entry labels.")
bool   lbl_qty     = input.bool(true, "Show Qty", group = GRP_POS_LBL, tooltip = "Show position size on entry labels.")
bool   lbl_risk    = input.bool(true, "Show $Risk", group = GRP_POS_LBL, tooltip = "Show dollar risk on entry labels.")
bool   lbl_pnl     = input.bool(true, "Show PNL on Exit", group = GRP_POS_LBL, tooltip = "Show profit/loss amount on exit labels.")


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 4. BACKTESTING MODULE
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

string GRP_BACK = "4. Backtesting Module"
bool   showBack  = input.bool(true, "Show Backtest KPI Module", group = GRP_BACK, inline = "back_row")
string backName  = input.string("", "Custom Name", group = GRP_BACK, inline = "back_row")

//──────────────────────────────────────────────────────────────────────────────
// 4.1 Data & Lookback Config
//──────────────────────────────────────────────────────────────────────────────

string GRP_BACK_DATA = "4.1 Data & Lookback Config"
string backWindow    = input.string("Entire Chart", "Backtest Window", options = ["Entire Chart", "Fixed Bars", "Date Range"], group = GRP_BACK_DATA)
int    backBars      = input.int(2000, "Window (Bars)", minval = 1, group = GRP_BACK_DATA)
const int BACK_START_DEF = 1577836800000 // 2020-01-01 00:00 UTC
int    backStartDate = input.time(BACK_START_DEF, "Window (Start Date)", group = GRP_BACK_DATA, inline = "wstart")
bool   backUseEnd    = input.bool(false, "Window (End)", group = GRP_BACK_DATA, inline = "wend")
const int BACK_END_DEF = 1893456000000 // 2030-01-01 00:00 UTC
int    backEndDate   = input.time(BACK_END_DEF, "End Date", group = GRP_BACK_DATA, inline = "wend")

//──────────────────────────────────────────────────────────────────────────────
// 4.2 Backtest Filters
//──────────────────────────────────────────────────────────────────────────────

string GRP_BACK_FILT = "4.2 Backtest Filters"
string backSession   = input.session("0000-2359", "Time of Day Filter", group = GRP_BACK_FILT)
bool   backUseDOW_M  = input.bool(true,  "Mon",   group = GRP_BACK_FILT, inline = "dow1")
bool   backUseDOW_T  = input.bool(true,  "Tues",  group = GRP_BACK_FILT, inline = "dow1")
bool   backUseDOW_W  = input.bool(true,  "Weds",  group = GRP_BACK_FILT, inline = "dow1")
bool   backUseDOW_Th = input.bool(true,  "Thurs", group = GRP_BACK_FILT, inline = "dow1")
bool   backUseDOW_F  = input.bool(true,  "Fri",   group = GRP_BACK_FILT, inline = "dow1")
bool   backUseDOW_Sa = input.bool(false, "Sat",   group = GRP_BACK_FILT, inline = "dow1")
bool   backUseDOW_Su = input.bool(false, "Sun",   group = GRP_BACK_FILT, inline = "dow1")


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 5. TOP TABLE INTERPRETERS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 5-1. VWAP (TOP TABLE CONFLUENCE INTERPRETER)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//
// Displays Daily, Weekly, and Monthly anchored VWAP zones in the Top Table.
// Each zone condition can be assigned to AND, OR1, OR2, or OR3 groups.
//
// Zone Labels: >+2σ, >+1σ, >V, @V, <V, <-1σ, <-2σ
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

string GRP_TOP_VWAP = "5-1. VWAP"
bool   lib_vwap_enabled = input.bool(true, "Enable", group = GRP_TOP_VWAP, tooltip = "Enable VWAP interpreter showing Daily, Weekly, and Monthly anchored VWAP zones.")
string lib_vwap_name    = input.string("VWAP", "Display Name", group = GRP_TOP_VWAP)

//──────────────────────────────────────────────────────────────────────────────
// 5-1.1 VWAP Parameters
//──────────────────────────────────────────────────────────────────────────────

string GRP_TOP_VWAP_PARAMS = "5-1.1 VWAP – Parameters"
float  lib_vwap_band1 = input.float(1.0, "Band 1 Multiplier (σ)", minval = 0.1, group = GRP_TOP_VWAP_PARAMS, tooltip = "Standard deviation multiplier for inner bands.")
float  lib_vwap_band2 = input.float(2.0, "Band 2 Multiplier (σ)", minval = 0.1, group = GRP_TOP_VWAP_PARAMS, tooltip = "Standard deviation multiplier for outer bands.")

//──────────────────────────────────────────────────────────────────────────────
// 5-1.2 Daily VWAP Conditions (Sigma-Based Zones)
// Each zone is a distinct sigma range from the VWAP
//──────────────────────────────────────────────────────────────────────────────

string GRP_VWAP_D = "5-1.2 VWAP – Daily Conditions"
string lib_vwap_D_above2s  = input.string("None", ">+2σ (Extreme High)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_D)
string lib_vwap_D_1to2s    = input.string("None", "+1σ to +2σ",            options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_D)
string lib_vwap_D_0to1s    = input.string("None", "0 to +1σ",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_D)
string lib_vwap_D_atV      = input.string("None", "@V (At VWAP)",          options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_D)
string lib_vwap_D_n1to0    = input.string("None", "-1σ to 0",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_D)
string lib_vwap_D_n2ton1   = input.string("None", "-2σ to -1σ",            options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_D)
string lib_vwap_D_below2s  = input.string("None", "<-2σ (Extreme Low)",    options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_D)

//──────────────────────────────────────────────────────────────────────────────
// 5-1.3 Weekly VWAP Conditions (Sigma-Based Zones)
//──────────────────────────────────────────────────────────────────────────────

string GRP_VWAP_W = "5-1.3 VWAP – Weekly Conditions"
string lib_vwap_W_above2s  = input.string("None", ">+2σ (Extreme High)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_W)
string lib_vwap_W_1to2s    = input.string("None", "+1σ to +2σ",            options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_W)
string lib_vwap_W_0to1s    = input.string("None", "0 to +1σ",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_W)
string lib_vwap_W_atV      = input.string("None", "@V (At VWAP)",          options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_W)
string lib_vwap_W_n1to0    = input.string("None", "-1σ to 0",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_W)
string lib_vwap_W_n2ton1   = input.string("None", "-2σ to -1σ",            options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_W)
string lib_vwap_W_below2s  = input.string("None", "<-2σ (Extreme Low)",    options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_W)

//──────────────────────────────────────────────────────────────────────────────
// 5-1.4 Monthly VWAP Conditions (Sigma-Based Zones)
//──────────────────────────────────────────────────────────────────────────────

string GRP_VWAP_M = "5-1.4 VWAP – Monthly Conditions"
string lib_vwap_M_above2s  = input.string("None", ">+2σ (Extreme High)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_M)
string lib_vwap_M_1to2s    = input.string("None", "+1σ to +2σ",            options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_M)
string lib_vwap_M_0to1s    = input.string("None", "0 to +1σ",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_M)
string lib_vwap_M_atV      = input.string("None", "@V (At VWAP)",          options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_M)
string lib_vwap_M_n1to0    = input.string("None", "-1σ to 0",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_M)
string lib_vwap_M_n2ton1   = input.string("None", "-2σ to -1σ",            options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_M)
string lib_vwap_M_below2s  = input.string("None", "<-2σ (Extreme Low)",    options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_VWAP_M)


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 6. SIDE TABLE INTERPRETERS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Side table rows are auto-ordered by enable sequence (first enabled = row 1)


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 6-1. EMA STACK (SIDE TABLE INTERPRETER)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//
// Conditions: SML (Bull), LMS (Bear), SLM, MSL, MLS, LSM
// Each condition × each TF = separate group assignment
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

string GRP_EMA = "6-1. EMA Stack"
bool   lib_ema_enabled = input.bool(true, "Enable", group = GRP_EMA, tooltip = "Enable EMA Stack interpreter for confluence analysis.")
string lib_ema_name    = input.string("EMA Stack", "Display Name", group = GRP_EMA)

//──────────────────────────────────────────────────────────────────────────────
// 6-1.1 EMA Stack Parameters
//──────────────────────────────────────────────────────────────────────────────

string GRP_EMA_PARAMS = "6-1.1 EMA Stack – Parameters"
int    lib_ema_short  = input.int(10, "Short EMA Length", minval = 1, group = GRP_EMA_PARAMS)
int    lib_ema_medium = input.int(20, "Medium EMA Length", minval = 1, group = GRP_EMA_PARAMS)
int    lib_ema_long   = input.int(50, "Long EMA Length", minval = 1, group = GRP_EMA_PARAMS)

//──────────────────────────────────────────────────────────────────────────────
// 6-1.2 EMA Stack – TF1 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_EMA_TF1 = "6-1.2 EMA Stack – TF1 Conditions"
string lib_ema_TF1_SML = input.string("None", "SML (Bull Stack)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF1)
string lib_ema_TF1_LMS = input.string("None", "LMS (Bear Stack)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF1)
string lib_ema_TF1_SLM = input.string("None", "SLM",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF1)
string lib_ema_TF1_MSL = input.string("None", "MSL",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF1)
string lib_ema_TF1_MLS = input.string("None", "MLS",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF1)
string lib_ema_TF1_LSM = input.string("None", "LSM",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF1)

//──────────────────────────────────────────────────────────────────────────────
// 6-1.3 EMA Stack – TF2 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_EMA_TF2 = "6-1.3 EMA Stack – TF2 Conditions"
string lib_ema_TF2_SML = input.string("None", "SML (Bull Stack)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF2)
string lib_ema_TF2_LMS = input.string("None", "LMS (Bear Stack)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF2)
string lib_ema_TF2_SLM = input.string("None", "SLM",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF2)
string lib_ema_TF2_MSL = input.string("None", "MSL",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF2)
string lib_ema_TF2_MLS = input.string("None", "MLS",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF2)
string lib_ema_TF2_LSM = input.string("None", "LSM",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF2)

//──────────────────────────────────────────────────────────────────────────────
// 6-1.4 EMA Stack – TF3 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_EMA_TF3 = "6-1.4 EMA Stack – TF3 Conditions"
string lib_ema_TF3_SML = input.string("None", "SML (Bull Stack)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF3)
string lib_ema_TF3_LMS = input.string("None", "LMS (Bear Stack)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF3)
string lib_ema_TF3_SLM = input.string("None", "SLM",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF3)
string lib_ema_TF3_MSL = input.string("None", "MSL",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF3)
string lib_ema_TF3_MLS = input.string("None", "MLS",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF3)
string lib_ema_TF3_LSM = input.string("None", "LSM",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF3)

//──────────────────────────────────────────────────────────────────────────────
// 6-1.5 EMA Stack – TF4 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_EMA_TF4 = "6-1.5 EMA Stack – TF4 Conditions"
string lib_ema_TF4_SML = input.string("None", "SML (Bull Stack)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF4)
string lib_ema_TF4_LMS = input.string("None", "LMS (Bear Stack)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF4)
string lib_ema_TF4_SLM = input.string("None", "SLM",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF4)
string lib_ema_TF4_MSL = input.string("None", "MSL",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF4)
string lib_ema_TF4_MLS = input.string("None", "MLS",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF4)
string lib_ema_TF4_LSM = input.string("None", "LSM",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF4)

//──────────────────────────────────────────────────────────────────────────────
// 6-1.6 EMA Stack – TF5 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_EMA_TF5 = "6-1.6 EMA Stack – TF5 Conditions"
string lib_ema_TF5_SML = input.string("None", "SML (Bull Stack)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF5)
string lib_ema_TF5_LMS = input.string("None", "LMS (Bear Stack)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF5)
string lib_ema_TF5_SLM = input.string("None", "SLM",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF5)
string lib_ema_TF5_MSL = input.string("None", "MSL",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF5)
string lib_ema_TF5_MLS = input.string("None", "MLS",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF5)
string lib_ema_TF5_LSM = input.string("None", "LSM",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF5)

//──────────────────────────────────────────────────────────────────────────────
// 6-1.7 EMA Stack – TF6 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_EMA_TF6 = "6-1.7 EMA Stack – TF6 Conditions"
string lib_ema_TF6_SML = input.string("None", "SML (Bull Stack)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF6)
string lib_ema_TF6_LMS = input.string("None", "LMS (Bear Stack)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF6)
string lib_ema_TF6_SLM = input.string("None", "SLM",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF6)
string lib_ema_TF6_MSL = input.string("None", "MSL",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF6)
string lib_ema_TF6_MLS = input.string("None", "MLS",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF6)
string lib_ema_TF6_LSM = input.string("None", "LSM",              options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_EMA_TF6)


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 6-2. RVOL (SIDE TABLE INTERPRETER)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//
// Conditions: RV! (Extreme), RV++ (Very High), RV+ (Elevated), RV= (Normal), RV- (Low)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

string GRP_RVOL = "6-2. RVOL"
bool   lib_rvol_enabled = input.bool(false, "Enable", group = GRP_RVOL, tooltip = "Enable RVOL interpreter for confluence analysis.")
string lib_rvol_name    = input.string("RVOL", "Display Name", group = GRP_RVOL)

//──────────────────────────────────────────────────────────────────────────────
// 6-2.1 RVOL Parameters
//──────────────────────────────────────────────────────────────────────────────

string GRP_RVOL_PARAMS = "6-2.1 RVOL – Parameters"
int    lib_rvol_lookback   = input.int(20, "Lookback Period", minval = 1, group = GRP_RVOL_PARAMS)
float  lib_rvol_highTh     = input.float(1.5, "High Threshold", minval = 0.1, step = 0.1, group = GRP_RVOL_PARAMS)
float  lib_rvol_veryHighTh = input.float(2.0, "Very High Threshold", minval = 0.1, step = 0.1, group = GRP_RVOL_PARAMS)
float  lib_rvol_extremeTh  = input.float(3.0, "Extreme Threshold", minval = 0.1, step = 0.1, group = GRP_RVOL_PARAMS)

//──────────────────────────────────────────────────────────────────────────────
// 6-2.2 RVOL – TF1 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_RVOL_TF1 = "6-2.2 RVOL – TF1 Conditions"
string lib_rvol_TF1_extreme  = input.string("None", "RV! (Extreme)",    options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF1)
string lib_rvol_TF1_veryHigh = input.string("None", "RV++ (Very High)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF1)
string lib_rvol_TF1_elevated = input.string("None", "RV+ (Elevated)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF1)
string lib_rvol_TF1_normal   = input.string("None", "RV= (Normal)",     options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF1)
string lib_rvol_TF1_low      = input.string("None", "RV- (Low)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF1)

//──────────────────────────────────────────────────────────────────────────────
// 6-2.3 RVOL – TF2 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_RVOL_TF2 = "6-2.3 RVOL – TF2 Conditions"
string lib_rvol_TF2_extreme  = input.string("None", "RV! (Extreme)",    options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF2)
string lib_rvol_TF2_veryHigh = input.string("None", "RV++ (Very High)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF2)
string lib_rvol_TF2_elevated = input.string("None", "RV+ (Elevated)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF2)
string lib_rvol_TF2_normal   = input.string("None", "RV= (Normal)",     options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF2)
string lib_rvol_TF2_low      = input.string("None", "RV- (Low)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF2)

//──────────────────────────────────────────────────────────────────────────────
// 6-2.4 RVOL – TF3 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_RVOL_TF3 = "6-2.4 RVOL – TF3 Conditions"
string lib_rvol_TF3_extreme  = input.string("None", "RV! (Extreme)",    options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF3)
string lib_rvol_TF3_veryHigh = input.string("None", "RV++ (Very High)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF3)
string lib_rvol_TF3_elevated = input.string("None", "RV+ (Elevated)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF3)
string lib_rvol_TF3_normal   = input.string("None", "RV= (Normal)",     options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF3)
string lib_rvol_TF3_low      = input.string("None", "RV- (Low)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF3)

//──────────────────────────────────────────────────────────────────────────────
// 6-2.5 RVOL – TF4 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_RVOL_TF4 = "6-2.5 RVOL – TF4 Conditions"
string lib_rvol_TF4_extreme  = input.string("None", "RV! (Extreme)",    options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF4)
string lib_rvol_TF4_veryHigh = input.string("None", "RV++ (Very High)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF4)
string lib_rvol_TF4_elevated = input.string("None", "RV+ (Elevated)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF4)
string lib_rvol_TF4_normal   = input.string("None", "RV= (Normal)",     options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF4)
string lib_rvol_TF4_low      = input.string("None", "RV- (Low)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF4)

//──────────────────────────────────────────────────────────────────────────────
// 6-2.6 RVOL – TF5 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_RVOL_TF5 = "6-2.6 RVOL – TF5 Conditions"
string lib_rvol_TF5_extreme  = input.string("None", "RV! (Extreme)",    options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF5)
string lib_rvol_TF5_veryHigh = input.string("None", "RV++ (Very High)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF5)
string lib_rvol_TF5_elevated = input.string("None", "RV+ (Elevated)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF5)
string lib_rvol_TF5_normal   = input.string("None", "RV= (Normal)",     options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF5)
string lib_rvol_TF5_low      = input.string("None", "RV- (Low)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF5)

//──────────────────────────────────────────────────────────────────────────────
// 6-2.7 RVOL – TF6 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_RVOL_TF6 = "6-2.7 RVOL – TF6 Conditions"
string lib_rvol_TF6_extreme  = input.string("None", "RV! (Extreme)",    options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF6)
string lib_rvol_TF6_veryHigh = input.string("None", "RV++ (Very High)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF6)
string lib_rvol_TF6_elevated = input.string("None", "RV+ (Elevated)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF6)
string lib_rvol_TF6_normal   = input.string("None", "RV= (Normal)",     options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF6)
string lib_rvol_TF6_low      = input.string("None", "RV- (Low)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_RVOL_TF6)


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 6-3. UT BOT (SIDE TABLE INTERPRETER)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//
// Conditions: Bull (Above Stop), Bear (Below Stop)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

string GRP_UTBOT = "6-3. UT Bot"
bool   lib_utbot_enabled = input.bool(true, "Enable", group = GRP_UTBOT, tooltip = "Enable UT Bot ATR trailing stop interpreter.")
string lib_utbot_name    = input.string("UT Bot", "Display Name", group = GRP_UTBOT)

//──────────────────────────────────────────────────────────────────────────────
// 6-3.1 UT Bot Parameters
//──────────────────────────────────────────────────────────────────────────────

string GRP_UTBOT_PARAMS = "6-3.1 UT Bot – Parameters"
float  lib_utbot_keyval = input.float(1.0, "Key Value (ATR Mult)", minval = 0.1, step = 0.1, group = GRP_UTBOT_PARAMS)
int    lib_utbot_atrlen = input.int(10, "ATR Period", minval = 1, group = GRP_UTBOT_PARAMS)
bool   lib_utbot_useHA  = input.bool(false, "Use Heikin Ashi", group = GRP_UTBOT_PARAMS)

//──────────────────────────────────────────────────────────────────────────────
// 6-3.2 UT Bot – TF1 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_UTBOT_TF1 = "6-3.2 UT Bot – TF1 Conditions"
string lib_utbot_TF1_bull = input.string("None", "Bull (Above Stop)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_UTBOT_TF1)
string lib_utbot_TF1_bear = input.string("None", "Bear (Below Stop)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_UTBOT_TF1)

//──────────────────────────────────────────────────────────────────────────────
// 6-3.3 UT Bot – TF2 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_UTBOT_TF2 = "6-3.3 UT Bot – TF2 Conditions"
string lib_utbot_TF2_bull = input.string("None", "Bull (Above Stop)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_UTBOT_TF2)
string lib_utbot_TF2_bear = input.string("None", "Bear (Below Stop)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_UTBOT_TF2)

//──────────────────────────────────────────────────────────────────────────────
// 6-3.4 UT Bot – TF3 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_UTBOT_TF3 = "6-3.4 UT Bot – TF3 Conditions"
string lib_utbot_TF3_bull = input.string("None", "Bull (Above Stop)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_UTBOT_TF3)
string lib_utbot_TF3_bear = input.string("None", "Bear (Below Stop)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_UTBOT_TF3)

//──────────────────────────────────────────────────────────────────────────────
// 6-3.5 UT Bot – TF4 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_UTBOT_TF4 = "6-3.5 UT Bot – TF4 Conditions"
string lib_utbot_TF4_bull = input.string("None", "Bull (Above Stop)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_UTBOT_TF4)
string lib_utbot_TF4_bear = input.string("None", "Bear (Below Stop)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_UTBOT_TF4)

//──────────────────────────────────────────────────────────────────────────────
// 6-3.6 UT Bot – TF5 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_UTBOT_TF5 = "6-3.6 UT Bot – TF5 Conditions"
string lib_utbot_TF5_bull = input.string("None", "Bull (Above Stop)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_UTBOT_TF5)
string lib_utbot_TF5_bear = input.string("None", "Bear (Below Stop)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_UTBOT_TF5)

//──────────────────────────────────────────────────────────────────────────────
// 6-3.7 UT Bot – TF6 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_UTBOT_TF6 = "6-3.7 UT Bot – TF6 Conditions"
string lib_utbot_TF6_bull = input.string("None", "Bull (Above Stop)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_UTBOT_TF6)
string lib_utbot_TF6_bear = input.string("None", "Bear (Below Stop)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_UTBOT_TF6)


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 6-4. SWING 123 (SIDE TABLE INTERPRETER)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//
// Conditions: BC2, BC3, XC2, XC3, B↑ (Recent Bull), X↓ (Recent Bear)
// No parameters - pure price action
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

string GRP_SWING = "6-4. Swing 123"
bool   lib_swing_enabled = input.bool(false, "Enable", group = GRP_SWING, tooltip = "Enable Swing 123 pattern interpreter.")
string lib_swing_name    = input.string("Swing 123", "Display Name", group = GRP_SWING)

//──────────────────────────────────────────────────────────────────────────────
// 6-4.1 Swing 123 – TF1 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_SWING_TF1 = "6-4.1 Swing 123 – TF1 Conditions"
string lib_swing_TF1_BC2  = input.string("None", "BC2 (Bullish C2)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF1)
string lib_swing_TF1_BC3  = input.string("None", "BC3 (Bullish C3)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF1)
string lib_swing_TF1_XC2  = input.string("None", "XC2 (Bearish C2)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF1)
string lib_swing_TF1_XC3  = input.string("None", "XC3 (Bearish C3)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF1)
string lib_swing_TF1_Bup  = input.string("None", "B↑ (Recent Bull Setup)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF1)
string lib_swing_TF1_Xdn  = input.string("None", "X↓ (Recent Bear Setup)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF1)

//──────────────────────────────────────────────────────────────────────────────
// 6-4.2 Swing 123 – TF2 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_SWING_TF2 = "6-4.2 Swing 123 – TF2 Conditions"
string lib_swing_TF2_BC2  = input.string("None", "BC2 (Bullish C2)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF2)
string lib_swing_TF2_BC3  = input.string("None", "BC3 (Bullish C3)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF2)
string lib_swing_TF2_XC2  = input.string("None", "XC2 (Bearish C2)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF2)
string lib_swing_TF2_XC3  = input.string("None", "XC3 (Bearish C3)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF2)
string lib_swing_TF2_Bup  = input.string("None", "B↑ (Recent Bull Setup)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF2)
string lib_swing_TF2_Xdn  = input.string("None", "X↓ (Recent Bear Setup)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF2)

//──────────────────────────────────────────────────────────────────────────────
// 6-4.3 Swing 123 – TF3 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_SWING_TF3 = "6-4.3 Swing 123 – TF3 Conditions"
string lib_swing_TF3_BC2  = input.string("None", "BC2 (Bullish C2)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF3)
string lib_swing_TF3_BC3  = input.string("None", "BC3 (Bullish C3)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF3)
string lib_swing_TF3_XC2  = input.string("None", "XC2 (Bearish C2)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF3)
string lib_swing_TF3_XC3  = input.string("None", "XC3 (Bearish C3)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF3)
string lib_swing_TF3_Bup  = input.string("None", "B↑ (Recent Bull Setup)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF3)
string lib_swing_TF3_Xdn  = input.string("None", "X↓ (Recent Bear Setup)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF3)

//──────────────────────────────────────────────────────────────────────────────
// 6-4.4 Swing 123 – TF4 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_SWING_TF4 = "6-4.4 Swing 123 – TF4 Conditions"
string lib_swing_TF4_BC2  = input.string("None", "BC2 (Bullish C2)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF4)
string lib_swing_TF4_BC3  = input.string("None", "BC3 (Bullish C3)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF4)
string lib_swing_TF4_XC2  = input.string("None", "XC2 (Bearish C2)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF4)
string lib_swing_TF4_XC3  = input.string("None", "XC3 (Bearish C3)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF4)
string lib_swing_TF4_Bup  = input.string("None", "B↑ (Recent Bull Setup)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF4)
string lib_swing_TF4_Xdn  = input.string("None", "X↓ (Recent Bear Setup)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF4)

//──────────────────────────────────────────────────────────────────────────────
// 6-4.5 Swing 123 – TF5 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_SWING_TF5 = "6-4.5 Swing 123 – TF5 Conditions"
string lib_swing_TF5_BC2  = input.string("None", "BC2 (Bullish C2)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF5)
string lib_swing_TF5_BC3  = input.string("None", "BC3 (Bullish C3)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF5)
string lib_swing_TF5_XC2  = input.string("None", "XC2 (Bearish C2)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF5)
string lib_swing_TF5_XC3  = input.string("None", "XC3 (Bearish C3)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF5)
string lib_swing_TF5_Bup  = input.string("None", "B↑ (Recent Bull Setup)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF5)
string lib_swing_TF5_Xdn  = input.string("None", "X↓ (Recent Bear Setup)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF5)

//──────────────────────────────────────────────────────────────────────────────
// 6-4.6 Swing 123 – TF6 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_SWING_TF6 = "6-4.6 Swing 123 – TF6 Conditions"
string lib_swing_TF6_BC2  = input.string("None", "BC2 (Bullish C2)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF6)
string lib_swing_TF6_BC3  = input.string("None", "BC3 (Bullish C3)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF6)
string lib_swing_TF6_XC2  = input.string("None", "XC2 (Bearish C2)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF6)
string lib_swing_TF6_XC3  = input.string("None", "XC3 (Bearish C3)",        options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF6)
string lib_swing_TF6_Bup  = input.string("None", "B↑ (Recent Bull Setup)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF6)
string lib_swing_TF6_Xdn  = input.string("None", "X↓ (Recent Bear Setup)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_SWING_TF6)


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 6-5. MACD LINE (SIDE TABLE INTERPRETER)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//
// Conditions: M>S+ (Above, Rising), M>S- (Above, Falling), M<S- (Below, Falling), M<S+ (Below, Rising)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

string GRP_MACDL = "6-5. MACD Line"
bool   lib_macdl_enabled = input.bool(false, "Enable", group = GRP_MACDL, tooltip = "Enable MACD Line interpreter.")
string lib_macdl_name    = input.string("MACD Line", "Display Name", group = GRP_MACDL)

//──────────────────────────────────────────────────────────────────────────────
// 6-5.1 MACD Line Parameters
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDL_PARAMS = "6-5.1 MACD Line – Parameters"
int    lib_macdl_fast   = input.int(12, "Fast Length", minval = 1, group = GRP_MACDL_PARAMS)
int    lib_macdl_slow   = input.int(26, "Slow Length", minval = 1, group = GRP_MACDL_PARAMS)
int    lib_macdl_signal = input.int(9, "Signal Length", minval = 1, group = GRP_MACDL_PARAMS)

//──────────────────────────────────────────────────────────────────────────────
// 6-5.2 MACD Line – TF1 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDL_TF1 = "6-5.2 MACD Line – TF1 Conditions"
string lib_macdl_TF1_aboveRising  = input.string("None", "M>S+ (Above, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF1)
string lib_macdl_TF1_aboveFalling = input.string("None", "M>S- (Above, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF1)
string lib_macdl_TF1_belowFalling = input.string("None", "M<S- (Below, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF1)
string lib_macdl_TF1_belowRising  = input.string("None", "M<S+ (Below, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF1)

//──────────────────────────────────────────────────────────────────────────────
// 6-5.3 MACD Line – TF2 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDL_TF2 = "6-5.3 MACD Line – TF2 Conditions"
string lib_macdl_TF2_aboveRising  = input.string("None", "M>S+ (Above, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF2)
string lib_macdl_TF2_aboveFalling = input.string("None", "M>S- (Above, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF2)
string lib_macdl_TF2_belowFalling = input.string("None", "M<S- (Below, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF2)
string lib_macdl_TF2_belowRising  = input.string("None", "M<S+ (Below, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF2)

//──────────────────────────────────────────────────────────────────────────────
// 6-5.4 MACD Line – TF3 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDL_TF3 = "6-5.4 MACD Line – TF3 Conditions"
string lib_macdl_TF3_aboveRising  = input.string("None", "M>S+ (Above, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF3)
string lib_macdl_TF3_aboveFalling = input.string("None", "M>S- (Above, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF3)
string lib_macdl_TF3_belowFalling = input.string("None", "M<S- (Below, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF3)
string lib_macdl_TF3_belowRising  = input.string("None", "M<S+ (Below, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF3)

//──────────────────────────────────────────────────────────────────────────────
// 6-5.5 MACD Line – TF4 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDL_TF4 = "6-5.5 MACD Line – TF4 Conditions"
string lib_macdl_TF4_aboveRising  = input.string("None", "M>S+ (Above, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF4)
string lib_macdl_TF4_aboveFalling = input.string("None", "M>S- (Above, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF4)
string lib_macdl_TF4_belowFalling = input.string("None", "M<S- (Below, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF4)
string lib_macdl_TF4_belowRising  = input.string("None", "M<S+ (Below, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF4)

//──────────────────────────────────────────────────────────────────────────────
// 6-5.6 MACD Line – TF5 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDL_TF5 = "6-5.6 MACD Line – TF5 Conditions"
string lib_macdl_TF5_aboveRising  = input.string("None", "M>S+ (Above, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF5)
string lib_macdl_TF5_aboveFalling = input.string("None", "M>S- (Above, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF5)
string lib_macdl_TF5_belowFalling = input.string("None", "M<S- (Below, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF5)
string lib_macdl_TF5_belowRising  = input.string("None", "M<S+ (Below, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF5)

//──────────────────────────────────────────────────────────────────────────────
// 6-5.7 MACD Line – TF6 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDL_TF6 = "6-5.7 MACD Line – TF6 Conditions"
string lib_macdl_TF6_aboveRising  = input.string("None", "M>S+ (Above, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF6)
string lib_macdl_TF6_aboveFalling = input.string("None", "M>S- (Above, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF6)
string lib_macdl_TF6_belowFalling = input.string("None", "M<S- (Below, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF6)
string lib_macdl_TF6_belowRising  = input.string("None", "M<S+ (Below, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDL_TF6)


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 6-6. MACD HISTOGRAM (SIDE TABLE INTERPRETER)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//
// Conditions: H+↑ (Positive, Rising), H+↓ (Positive, Falling), H-↓ (Negative, Falling), H-↑ (Negative, Rising)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

string GRP_MACDH = "6-6. MACD Histogram"
bool   lib_macdh_enabled = input.bool(false, "Enable", group = GRP_MACDH, tooltip = "Enable MACD Histogram interpreter.")
string lib_macdh_name    = input.string("MACD Hist", "Display Name", group = GRP_MACDH)

//──────────────────────────────────────────────────────────────────────────────
// 6-6.1 MACD Histogram Parameters
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDH_PARAMS = "6-6.1 MACD Histogram – Parameters"
int    lib_macdh_fast   = input.int(12, "Fast Length", minval = 1, group = GRP_MACDH_PARAMS)
int    lib_macdh_slow   = input.int(26, "Slow Length", minval = 1, group = GRP_MACDH_PARAMS)
int    lib_macdh_signal = input.int(9, "Signal Length", minval = 1, group = GRP_MACDH_PARAMS)

//──────────────────────────────────────────────────────────────────────────────
// 6-6.2 MACD Histogram – TF1 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDH_TF1 = "6-6.2 MACD Histogram – TF1 Conditions"
string lib_macdh_TF1_posRising  = input.string("None", "H+↑ (Positive, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF1)
string lib_macdh_TF1_posFalling = input.string("None", "H+↓ (Positive, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF1)
string lib_macdh_TF1_negFalling = input.string("None", "H-↓ (Negative, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF1)
string lib_macdh_TF1_negRising  = input.string("None", "H-↑ (Negative, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF1)

//──────────────────────────────────────────────────────────────────────────────
// 6-6.3 MACD Histogram – TF2 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDH_TF2 = "6-6.3 MACD Histogram – TF2 Conditions"
string lib_macdh_TF2_posRising  = input.string("None", "H+↑ (Positive, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF2)
string lib_macdh_TF2_posFalling = input.string("None", "H+↓ (Positive, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF2)
string lib_macdh_TF2_negFalling = input.string("None", "H-↓ (Negative, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF2)
string lib_macdh_TF2_negRising  = input.string("None", "H-↑ (Negative, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF2)

//──────────────────────────────────────────────────────────────────────────────
// 6-6.4 MACD Histogram – TF3 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDH_TF3 = "6-6.4 MACD Histogram – TF3 Conditions"
string lib_macdh_TF3_posRising  = input.string("None", "H+↑ (Positive, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF3)
string lib_macdh_TF3_posFalling = input.string("None", "H+↓ (Positive, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF3)
string lib_macdh_TF3_negFalling = input.string("None", "H-↓ (Negative, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF3)
string lib_macdh_TF3_negRising  = input.string("None", "H-↑ (Negative, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF3)

//──────────────────────────────────────────────────────────────────────────────
// 6-6.5 MACD Histogram – TF4 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDH_TF4 = "6-6.5 MACD Histogram – TF4 Conditions"
string lib_macdh_TF4_posRising  = input.string("None", "H+↑ (Positive, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF4)
string lib_macdh_TF4_posFalling = input.string("None", "H+↓ (Positive, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF4)
string lib_macdh_TF4_negFalling = input.string("None", "H-↓ (Negative, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF4)
string lib_macdh_TF4_negRising  = input.string("None", "H-↑ (Negative, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF4)

//──────────────────────────────────────────────────────────────────────────────
// 6-6.6 MACD Histogram – TF5 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDH_TF5 = "6-6.6 MACD Histogram – TF5 Conditions"
string lib_macdh_TF5_posRising  = input.string("None", "H+↑ (Positive, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF5)
string lib_macdh_TF5_posFalling = input.string("None", "H+↓ (Positive, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF5)
string lib_macdh_TF5_negFalling = input.string("None", "H-↓ (Negative, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF5)
string lib_macdh_TF5_negRising  = input.string("None", "H-↑ (Negative, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF5)

//──────────────────────────────────────────────────────────────────────────────
// 6-6.7 MACD Histogram – TF6 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDH_TF6 = "6-6.7 MACD Histogram – TF6 Conditions"
string lib_macdh_TF6_posRising  = input.string("None", "H+↑ (Positive, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF6)
string lib_macdh_TF6_posFalling = input.string("None", "H+↓ (Positive, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF6)
string lib_macdh_TF6_negFalling = input.string("None", "H-↓ (Negative, Falling)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF6)
string lib_macdh_TF6_negRising  = input.string("None", "H-↑ (Negative, Rising)",  options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDH_TF6)


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 6-7. SIMPLE MACD (SIDE TABLE INTERPRETER)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//
// Conditions: M>S↑ (Above, Just Crossed), M>S↓ (Above, Was Above), M<S↓ (Below, Just Crossed), M<S↑ (Below, Was Below)
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

string GRP_MACDS = "6-7. Simple MACD"
bool   lib_macds_enabled = input.bool(false, "Enable", group = GRP_MACDS, tooltip = "Enable Simple MACD interpreter.")
string lib_macds_name    = input.string("Simple MACD", "Display Name", group = GRP_MACDS)

//──────────────────────────────────────────────────────────────────────────────
// 6-7.1 Simple MACD Parameters
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDS_PARAMS = "6-7.1 Simple MACD – Parameters"
int    lib_macds_fast   = input.int(12, "Fast Length", minval = 1, group = GRP_MACDS_PARAMS)
int    lib_macds_slow   = input.int(26, "Slow Length", minval = 1, group = GRP_MACDS_PARAMS)
int    lib_macds_signal = input.int(9, "Signal Length", minval = 1, group = GRP_MACDS_PARAMS)

//──────────────────────────────────────────────────────────────────────────────
// 6-7.2 Simple MACD – TF1 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDS_TF1 = "6-7.2 Simple MACD – TF1 Conditions"
string lib_macds_TF1_aboveCrossUp   = input.string("None", "M>S↑ (Above, Crossed Up)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF1)
string lib_macds_TF1_aboveCrossDown = input.string("None", "M>S↓ (Above, Crossed Down)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF1)
string lib_macds_TF1_belowCrossDown = input.string("None", "M<S↓ (Below, Crossed Down)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF1)
string lib_macds_TF1_belowCrossUp   = input.string("None", "M<S↑ (Below, Crossed Up)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF1)

//──────────────────────────────────────────────────────────────────────────────
// 6-7.3 Simple MACD – TF2 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDS_TF2 = "6-7.3 Simple MACD – TF2 Conditions"
string lib_macds_TF2_aboveCrossUp   = input.string("None", "M>S↑ (Above, Crossed Up)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF2)
string lib_macds_TF2_aboveCrossDown = input.string("None", "M>S↓ (Above, Crossed Down)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF2)
string lib_macds_TF2_belowCrossDown = input.string("None", "M<S↓ (Below, Crossed Down)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF2)
string lib_macds_TF2_belowCrossUp   = input.string("None", "M<S↑ (Below, Crossed Up)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF2)

//──────────────────────────────────────────────────────────────────────────────
// 6-7.4 Simple MACD – TF3 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDS_TF3 = "6-7.4 Simple MACD – TF3 Conditions"
string lib_macds_TF3_aboveCrossUp   = input.string("None", "M>S↑ (Above, Crossed Up)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF3)
string lib_macds_TF3_aboveCrossDown = input.string("None", "M>S↓ (Above, Crossed Down)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF3)
string lib_macds_TF3_belowCrossDown = input.string("None", "M<S↓ (Below, Crossed Down)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF3)
string lib_macds_TF3_belowCrossUp   = input.string("None", "M<S↑ (Below, Crossed Up)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF3)

//──────────────────────────────────────────────────────────────────────────────
// 6-7.5 Simple MACD – TF4 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDS_TF4 = "6-7.5 Simple MACD – TF4 Conditions"
string lib_macds_TF4_aboveCrossUp   = input.string("None", "M>S↑ (Above, Crossed Up)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF4)
string lib_macds_TF4_aboveCrossDown = input.string("None", "M>S↓ (Above, Crossed Down)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF4)
string lib_macds_TF4_belowCrossDown = input.string("None", "M<S↓ (Below, Crossed Down)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF4)
string lib_macds_TF4_belowCrossUp   = input.string("None", "M<S↑ (Below, Crossed Up)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF4)

//──────────────────────────────────────────────────────────────────────────────
// 6-7.6 Simple MACD – TF5 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDS_TF5 = "6-7.6 Simple MACD – TF5 Conditions"
string lib_macds_TF5_aboveCrossUp   = input.string("None", "M>S↑ (Above, Crossed Up)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF5)
string lib_macds_TF5_aboveCrossDown = input.string("None", "M>S↓ (Above, Crossed Down)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF5)
string lib_macds_TF5_belowCrossDown = input.string("None", "M<S↓ (Below, Crossed Down)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF5)
string lib_macds_TF5_belowCrossUp   = input.string("None", "M<S↑ (Below, Crossed Up)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF5)

//──────────────────────────────────────────────────────────────────────────────
// 6-7.7 Simple MACD – TF6 Conditions
//──────────────────────────────────────────────────────────────────────────────

string GRP_MACDS_TF6 = "6-7.7 Simple MACD – TF6 Conditions"
string lib_macds_TF6_aboveCrossUp   = input.string("None", "M>S↑ (Above, Crossed Up)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF6)
string lib_macds_TF6_aboveCrossDown = input.string("None", "M>S↓ (Above, Crossed Down)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF6)
string lib_macds_TF6_belowCrossDown = input.string("None", "M<S↓ (Below, Crossed Down)", options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF6)
string lib_macds_TF6_belowCrossUp   = input.string("None", "M<S↑ (Below, Crossed Up)",   options = ["None", "AND", "OR1", "OR2", "OR3"], group = GRP_MACDS_TF6)


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// END OF INPUT SECTIONS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//
// TODO: Implement the following sections:
// - 7. Internal Types & Helper Functions
// - 8. Library Loaders (EMA Stack, RVOL, UT Bot, Swing 123, MACD Line, MACD Hist, Simple MACD, VWAP)
// - 9. Centralized Trigger Routing
// - 10. AND/OR Confluence Engine
// - 11. Position Engine
// - 12. Backtest Engine
// - 13. Top Table Renderer
// - 14. Side Table Renderer
// - 15. Data Export Plots
//
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 7. INTERNAL TYPES & HELPER FUNCTIONS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

// Normalized output structure for all TF libraries
type KB_TF_Out_V2
    // TF state labels
    string tf1_label
    string tf2_label
    string tf3_label
    string tf4_label
    string tf5_label
    string tf6_label
    // Conditions A-J per TF (60 total)
    bool condA_tf1
    bool condA_tf2
    bool condA_tf3
    bool condA_tf4
    bool condA_tf5
    bool condA_tf6
    bool condB_tf1
    bool condB_tf2
    bool condB_tf3
    bool condB_tf4
    bool condB_tf5
    bool condB_tf6
    bool condC_tf1
    bool condC_tf2
    bool condC_tf3
    bool condC_tf4
    bool condC_tf5
    bool condC_tf6
    bool condD_tf1
    bool condD_tf2
    bool condD_tf3
    bool condD_tf4
    bool condD_tf5
    bool condD_tf6
    bool condE_tf1
    bool condE_tf2
    bool condE_tf3
    bool condE_tf4
    bool condE_tf5
    bool condE_tf6
    bool condF_tf1
    bool condF_tf2
    bool condF_tf3
    bool condF_tf4
    bool condF_tf5
    bool condF_tf6
    bool condG_tf1
    bool condG_tf2
    bool condG_tf3
    bool condG_tf4
    bool condG_tf5
    bool condG_tf6
    bool condH_tf1
    bool condH_tf2
    bool condH_tf3
    bool condH_tf4
    bool condH_tf5
    bool condH_tf6
    bool condI_tf1
    bool condI_tf2
    bool condI_tf3
    bool condI_tf4
    bool condI_tf5
    bool condI_tf6
    bool condJ_tf1
    bool condJ_tf2
    bool condJ_tf3
    bool condJ_tf4
    bool condJ_tf5
    bool condJ_tf6
    // Triggers A-J
    bool trigA
    bool trigB
    bool trigC
    bool trigD
    bool trigE
    bool trigF
    bool trigG
    bool trigH
    bool trigI
    bool trigJ
    // Trigger metadata
    float trigger_price
    string trigger_label

// Helper: resolve timeframe string for request.security
_tf_res_v2(simple string tf) => tf == "" ? timeframe.period : tf

//──────────────────────────────────────────────────────────────────────────────
// VWAP HELPER FUNCTIONS (must be at global scope)
//──────────────────────────────────────────────────────────────────────────────

// Daily anchored VWAP with standard deviation
_kb_calcVWAP() =>
    bool _newSession = ta.change(time("D")) != 0
    float _sumPV = 0.0
    float _sumV = 0.0
    float _sumPV2 = 0.0
    if bar_index == 0 or _newSession
        _sumPV := close * volume
        _sumV := volume
        _sumPV2 := close * close * volume
    else
        _sumPV := nz(_sumPV[1]) + close * volume
        _sumV := nz(_sumV[1]) + volume
        _sumPV2 := nz(_sumPV2[1]) + close * close * volume
    float _vwap = _sumV > 0 ? _sumPV / _sumV : close
    float _variance = _sumV > 0 ? (_sumPV2 / _sumV) - (_vwap * _vwap) : 0.0
    float _sd = math.sqrt(math.max(_variance, 0))
    [_vwap, _sd]

// Weekly anchored VWAP with standard deviation
_kb_calcVWAP_W() =>
    bool _newSession = ta.change(time("W")) != 0
    float _sumPV = 0.0
    float _sumV = 0.0
    float _sumPV2 = 0.0
    if bar_index == 0 or _newSession
        _sumPV := close * volume
        _sumV := volume
        _sumPV2 := close * close * volume
    else
        _sumPV := nz(_sumPV[1]) + close * volume
        _sumV := nz(_sumV[1]) + volume
        _sumPV2 := nz(_sumPV2[1]) + close * close * volume
    float _vwap = _sumV > 0 ? _sumPV / _sumV : close
    float _variance = _sumV > 0 ? (_sumPV2 / _sumV) - (_vwap * _vwap) : 0.0
    float _sd = math.sqrt(math.max(_variance, 0))
    [_vwap, _sd]

// Monthly anchored VWAP with standard deviation
_kb_calcVWAP_M() =>
    bool _newSession = ta.change(time("M")) != 0
    float _sumPV = 0.0
    float _sumV = 0.0
    float _sumPV2 = 0.0
    if bar_index == 0 or _newSession
        _sumPV := close * volume
        _sumV := volume
        _sumPV2 := close * close * volume
    else
        _sumPV := nz(_sumPV[1]) + close * volume
        _sumV := nz(_sumV[1]) + volume
        _sumPV2 := nz(_sumPV2[1]) + close * close * volume
    float _vwap = _sumV > 0 ? _sumPV / _sumV : close
    float _variance = _sumV > 0 ? (_sumPV2 / _sumV) - (_vwap * _vwap) : 0.0
    float _sd = math.sqrt(math.max(_variance, 0))
    [_vwap, _sd]

// VWAP zone label helper
_kb_vwapZoneLabel(float price, float vwap, float sd, float sd1Mult, float sd2Mult) =>
    string lab = "na"
    if not na(price) and not na(vwap) and not na(sd) and sd > 0
        float upperBand2 = vwap + (sd2Mult * sd)
        float upperBand1 = vwap + (sd1Mult * sd)
        float atVwapUpper = vwap + (0.5 * sd)
        float atVwapLower = vwap - (0.5 * sd)
        float lowerBand1 = vwap - (sd1Mult * sd)
        float lowerBand2 = vwap - (sd2Mult * sd)
        if price > upperBand2
            lab := ">+2σ"
        else if price > upperBand1
            lab := ">+1σ"
        else if price > atVwapUpper
            lab := ">V"
        else if price >= atVwapLower
            lab := "@V"
        else if price >= lowerBand1
            lab := "<V"
        else if price >= lowerBand2
            lab := "<-1σ"
        else
            lab := "<-2σ"
    lab

//──────────────────────────────────────────────────────────────────────────────
// SWING 123 PATTERN FUNCTIONS (must be at global scope for request.security)
//──────────────────────────────────────────────────────────────────────────────

// BC2: Lower low BUT closes above prior close
_sw_bc2() => low < low[1] and close > close[1]
// BC3: After BC2, closes above prior high
_sw_bc3() => low[1] < low[2] and close[1] > close[2] and close > high[1]
// XC2: Higher high BUT closes below prior close
_sw_xc2() => high > high[1] and close < close[1]
// XC3: After XC2, closes below prior low
_sw_xc3() => high[1] > high[2] and close[1] < close[2] and close < low[1]
// Recent bullish: BC2 or BC3 within last 3 bars
_sw_rbull() => _sw_bc2() or _sw_bc2()[1] or _sw_bc2()[2] or _sw_bc3() or _sw_bc3()[1] or _sw_bc3()[2]
// Recent bearish: XC2 or XC3 within last 3 bars
_sw_rbear() => _sw_xc2() or _sw_xc2()[1] or _sw_xc2()[2] or _sw_xc3() or _sw_xc3()[1] or _sw_xc3()[2]

//──────────────────────────────────────────────────────────────────────────────
// UT BOT TRAILING STOP FUNCTION (must be at global scope)
//──────────────────────────────────────────────────────────────────────────────

_utbot_stop(float src, float atr, float keyVal, float prevStop, int prevDir) =>
    float nLoss = keyVal * atr
    int dir = prevDir
    float stop = prevStop
    if src > nz(prevStop, src)
        stop := math.max(nz(prevStop, src - nLoss), src - nLoss)
        dir := 1
    else
        stop := math.min(nz(prevStop, src + nLoss), src + nLoss)
        dir := -1
    [stop, dir]


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 8. LIBRARY LOADERS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


//──────────────────────────────────────────────────────────────────────────────
// 8-1. EMA STACK LOADER
// Only executes request.security() calls if lib_ema_enabled is true
//──────────────────────────────────────────────────────────────────────────────

var KB_TF_Out_V2 lib_ema_v2 = KB_TF_Out_V2.new()

if lib_ema_enabled
    // Fetch HTF EMAs for each of the 6 timeframes
    [_ema_eS1, _ema_eM1, _ema_eL1] = request.security(syminfo.tickerid, _tf_res_v2(tf1),
        [ta.ema(close, lib_ema_short), ta.ema(close, lib_ema_medium), ta.ema(close, lib_ema_long)],
        barmerge.gaps_off, barmerge.lookahead_off)
    [_ema_eS2, _ema_eM2, _ema_eL2] = request.security(syminfo.tickerid, _tf_res_v2(tf2),
        [ta.ema(close, lib_ema_short), ta.ema(close, lib_ema_medium), ta.ema(close, lib_ema_long)],
        barmerge.gaps_off, barmerge.lookahead_off)
    [_ema_eS3, _ema_eM3, _ema_eL3] = request.security(syminfo.tickerid, _tf_res_v2(tf3),
        [ta.ema(close, lib_ema_short), ta.ema(close, lib_ema_medium), ta.ema(close, lib_ema_long)],
        barmerge.gaps_off, barmerge.lookahead_off)
    [_ema_eS4, _ema_eM4, _ema_eL4] = request.security(syminfo.tickerid, _tf_res_v2(tf4),
        [ta.ema(close, lib_ema_short), ta.ema(close, lib_ema_medium), ta.ema(close, lib_ema_long)],
        barmerge.gaps_off, barmerge.lookahead_off)
    [_ema_eS5, _ema_eM5, _ema_eL5] = request.security(syminfo.tickerid, _tf_res_v2(tf5),
        [ta.ema(close, lib_ema_short), ta.ema(close, lib_ema_medium), ta.ema(close, lib_ema_long)],
        barmerge.gaps_off, barmerge.lookahead_off)
    [_ema_eS6, _ema_eM6, _ema_eL6] = request.security(syminfo.tickerid, _tf_res_v2(tf6),
        [ta.ema(close, lib_ema_short), ta.ema(close, lib_ema_medium), ta.ema(close, lib_ema_long)],
        barmerge.gaps_off, barmerge.lookahead_off)

    // Chart timeframe EMAs (for trigger detection)
    float _ema_eS_chart = ta.ema(close, lib_ema_short)
    float _ema_eM_chart = ta.ema(close, lib_ema_medium)
    float _ema_eL_chart = ta.ema(close, lib_ema_long)
    float _ema_eS_prev = _ema_eS_chart[1]
    float _ema_eM_prev = _ema_eM_chart[1]

    // Call library's builder function
    tfEMAStack.TFModuleOutput _emaOut = tfEMAStack.buildOutput(
        _ema_eS1, _ema_eM1, _ema_eL1,
        _ema_eS2, _ema_eM2, _ema_eL2,
        _ema_eS3, _ema_eM3, _ema_eL3,
        _ema_eS4, _ema_eM4, _ema_eL4,
        _ema_eS5, _ema_eM5, _ema_eL5,
        _ema_eS6, _ema_eM6, _ema_eL6,
        _ema_eS_chart, _ema_eM_chart, _ema_eL_chart,
        _ema_eS_prev, _ema_eM_prev, _ema_eL_chart[1],
        close
    )

    // Map to normalized V2 output
    lib_ema_v2 := KB_TF_Out_V2.new(
        _emaOut.tf1_label, _emaOut.tf2_label, _emaOut.tf3_label,
        _emaOut.tf4_label, _emaOut.tf5_label, _emaOut.tf6_label,
        _emaOut.condA_tf1, _emaOut.condA_tf2, _emaOut.condA_tf3,
        _emaOut.condA_tf4, _emaOut.condA_tf5, _emaOut.condA_tf6,
        _emaOut.condB_tf1, _emaOut.condB_tf2, _emaOut.condB_tf3,
        _emaOut.condB_tf4, _emaOut.condB_tf5, _emaOut.condB_tf6,
        _emaOut.condC_tf1, _emaOut.condC_tf2, _emaOut.condC_tf3,
        _emaOut.condC_tf4, _emaOut.condC_tf5, _emaOut.condC_tf6,
        _emaOut.condD_tf1, _emaOut.condD_tf2, _emaOut.condD_tf3,
        _emaOut.condD_tf4, _emaOut.condD_tf5, _emaOut.condD_tf6,
        _emaOut.condE_tf1, _emaOut.condE_tf2, _emaOut.condE_tf3,
        _emaOut.condE_tf4, _emaOut.condE_tf5, _emaOut.condE_tf6,
        _emaOut.condF_tf1, _emaOut.condF_tf2, _emaOut.condF_tf3,
        _emaOut.condF_tf4, _emaOut.condF_tf5, _emaOut.condF_tf6,
        _emaOut.condG_tf1, _emaOut.condG_tf2, _emaOut.condG_tf3,
        _emaOut.condG_tf4, _emaOut.condG_tf5, _emaOut.condG_tf6,
        _emaOut.condH_tf1, _emaOut.condH_tf2, _emaOut.condH_tf3,
        _emaOut.condH_tf4, _emaOut.condH_tf5, _emaOut.condH_tf6,
        _emaOut.condI_tf1, _emaOut.condI_tf2, _emaOut.condI_tf3,
        _emaOut.condI_tf4, _emaOut.condI_tf5, _emaOut.condI_tf6,
        _emaOut.condJ_tf1, _emaOut.condJ_tf2, _emaOut.condJ_tf3,
        _emaOut.condJ_tf4, _emaOut.condJ_tf5, _emaOut.condJ_tf6,
        _emaOut.trigA, _emaOut.trigB, _emaOut.trigC, _emaOut.trigD, _emaOut.trigE,
        _emaOut.trigF, _emaOut.trigG, _emaOut.trigH, _emaOut.trigI, _emaOut.trigJ,
        _emaOut.trigger_price, _emaOut.trigger_label
    )


//──────────────────────────────────────────────────────────────────────────────
// 8-2. RVOL LOADER
// Only executes request.security() calls if lib_rvol_enabled is true
//──────────────────────────────────────────────────────────────────────────────

var KB_TF_Out_V2 lib_rvol_v2 = KB_TF_Out_V2.new()

if lib_rvol_enabled
    // Calculate RVOL for each timeframe
    float _rvol_1 = request.security(syminfo.tickerid, _tf_res_v2(tf1), volume / ta.sma(volume, lib_rvol_lookback), barmerge.gaps_off, barmerge.lookahead_off)
    float _rvol_2 = request.security(syminfo.tickerid, _tf_res_v2(tf2), volume / ta.sma(volume, lib_rvol_lookback), barmerge.gaps_off, barmerge.lookahead_off)
    float _rvol_3 = request.security(syminfo.tickerid, _tf_res_v2(tf3), volume / ta.sma(volume, lib_rvol_lookback), barmerge.gaps_off, barmerge.lookahead_off)
    float _rvol_4 = request.security(syminfo.tickerid, _tf_res_v2(tf4), volume / ta.sma(volume, lib_rvol_lookback), barmerge.gaps_off, barmerge.lookahead_off)
    float _rvol_5 = request.security(syminfo.tickerid, _tf_res_v2(tf5), volume / ta.sma(volume, lib_rvol_lookback), barmerge.gaps_off, barmerge.lookahead_off)
    float _rvol_6 = request.security(syminfo.tickerid, _tf_res_v2(tf6), volume / ta.sma(volume, lib_rvol_lookback), barmerge.gaps_off, barmerge.lookahead_off)

    // Chart timeframe RVOL (for triggers)
    float _rvol_chart = volume / ta.sma(volume, lib_rvol_lookback)
    float _rvol_prev = _rvol_chart[1]

    // Call library's builder function
    tfRVOL.TFModuleOutput _rvolOut = tfRVOL.buildOutput(
        _rvol_1, _rvol_2, _rvol_3, _rvol_4, _rvol_5, _rvol_6,
        lib_rvol_highTh, lib_rvol_veryHighTh, lib_rvol_extremeTh,
        _rvol_chart, _rvol_prev,
        close
    )

    // Map to normalized V2 output
    lib_rvol_v2 := KB_TF_Out_V2.new(
        _rvolOut.tf1_label, _rvolOut.tf2_label, _rvolOut.tf3_label,
        _rvolOut.tf4_label, _rvolOut.tf5_label, _rvolOut.tf6_label,
        _rvolOut.condA_tf1, _rvolOut.condA_tf2, _rvolOut.condA_tf3,
        _rvolOut.condA_tf4, _rvolOut.condA_tf5, _rvolOut.condA_tf6,
        _rvolOut.condB_tf1, _rvolOut.condB_tf2, _rvolOut.condB_tf3,
        _rvolOut.condB_tf4, _rvolOut.condB_tf5, _rvolOut.condB_tf6,
        _rvolOut.condC_tf1, _rvolOut.condC_tf2, _rvolOut.condC_tf3,
        _rvolOut.condC_tf4, _rvolOut.condC_tf5, _rvolOut.condC_tf6,
        _rvolOut.condD_tf1, _rvolOut.condD_tf2, _rvolOut.condD_tf3,
        _rvolOut.condD_tf4, _rvolOut.condD_tf5, _rvolOut.condD_tf6,
        _rvolOut.condE_tf1, _rvolOut.condE_tf2, _rvolOut.condE_tf3,
        _rvolOut.condE_tf4, _rvolOut.condE_tf5, _rvolOut.condE_tf6,
        _rvolOut.condF_tf1, _rvolOut.condF_tf2, _rvolOut.condF_tf3,
        _rvolOut.condF_tf4, _rvolOut.condF_tf5, _rvolOut.condF_tf6,
        _rvolOut.condG_tf1, _rvolOut.condG_tf2, _rvolOut.condG_tf3,
        _rvolOut.condG_tf4, _rvolOut.condG_tf5, _rvolOut.condG_tf6,
        _rvolOut.condH_tf1, _rvolOut.condH_tf2, _rvolOut.condH_tf3,
        _rvolOut.condH_tf4, _rvolOut.condH_tf5, _rvolOut.condH_tf6,
        _rvolOut.condI_tf1, _rvolOut.condI_tf2, _rvolOut.condI_tf3,
        _rvolOut.condI_tf4, _rvolOut.condI_tf5, _rvolOut.condI_tf6,
        _rvolOut.condJ_tf1, _rvolOut.condJ_tf2, _rvolOut.condJ_tf3,
        _rvolOut.condJ_tf4, _rvolOut.condJ_tf5, _rvolOut.condJ_tf6,
        _rvolOut.trigA, _rvolOut.trigB, _rvolOut.trigC, _rvolOut.trigD, _rvolOut.trigE,
        _rvolOut.trigF, _rvolOut.trigG, _rvolOut.trigH, _rvolOut.trigI, _rvolOut.trigJ,
        _rvolOut.trigger_price, _rvolOut.trigger_label
    )


//──────────────────────────────────────────────────────────────────────────────
// 8-3. UT BOT LOADER
// Only executes request.security() calls if lib_utbot_enabled is true
// NOTE: UT Bot requires var state for trailing stop
//──────────────────────────────────────────────────────────────────────────────

var KB_TF_Out_V2 lib_utbot_v2 = KB_TF_Out_V2.new()

// Var state for trailing stops (each TF needs persistent state)
var float _utbot_stop1 = na
var float _utbot_stop2 = na
var float _utbot_stop3 = na
var float _utbot_stop4 = na
var float _utbot_stop5 = na
var float _utbot_stop6 = na
var int   _utbot_dir1 = 0
var int   _utbot_dir2 = 0
var int   _utbot_dir3 = 0
var int   _utbot_dir4 = 0
var int   _utbot_dir5 = 0
var int   _utbot_dir6 = 0

if lib_utbot_enabled
    // Get source (Heikin Ashi or regular close)
    float _utbot_src = lib_utbot_useHA ? (open + high + low + close) / 4 : close

    // Fetch close and ATR for each TF
    [_utbot_c1, _utbot_a1] = request.security(syminfo.tickerid, _tf_res_v2(tf1),
        [_utbot_src, ta.atr(lib_utbot_atrlen)], barmerge.gaps_off, barmerge.lookahead_off)
    [_utbot_c2, _utbot_a2] = request.security(syminfo.tickerid, _tf_res_v2(tf2),
        [_utbot_src, ta.atr(lib_utbot_atrlen)], barmerge.gaps_off, barmerge.lookahead_off)
    [_utbot_c3, _utbot_a3] = request.security(syminfo.tickerid, _tf_res_v2(tf3),
        [_utbot_src, ta.atr(lib_utbot_atrlen)], barmerge.gaps_off, barmerge.lookahead_off)
    [_utbot_c4, _utbot_a4] = request.security(syminfo.tickerid, _tf_res_v2(tf4),
        [_utbot_src, ta.atr(lib_utbot_atrlen)], barmerge.gaps_off, barmerge.lookahead_off)
    [_utbot_c5, _utbot_a5] = request.security(syminfo.tickerid, _tf_res_v2(tf5),
        [_utbot_src, ta.atr(lib_utbot_atrlen)], barmerge.gaps_off, barmerge.lookahead_off)
    [_utbot_c6, _utbot_a6] = request.security(syminfo.tickerid, _tf_res_v2(tf6),
        [_utbot_src, ta.atr(lib_utbot_atrlen)], barmerge.gaps_off, barmerge.lookahead_off)
    // Additional security call for chart TF trigger detection
    [_utbot_c_chart, _utbot_a_chart] = request.security(syminfo.tickerid, timeframe.period,
        [_utbot_src, ta.atr(lib_utbot_atrlen)], barmerge.gaps_off, barmerge.lookahead_off)

    // Calculate trailing stops for each TF
    [s1, d1] = _utbot_stop(_utbot_c1, _utbot_a1, lib_utbot_keyval, _utbot_stop1, _utbot_dir1)
    _utbot_stop1 := s1
    _utbot_dir1  := d1

    [s2, d2] = _utbot_stop(_utbot_c2, _utbot_a2, lib_utbot_keyval, _utbot_stop2, _utbot_dir2)
    _utbot_stop2 := s2
    _utbot_dir2  := d2

    [s3, d3] = _utbot_stop(_utbot_c3, _utbot_a3, lib_utbot_keyval, _utbot_stop3, _utbot_dir3)
    _utbot_stop3 := s3
    _utbot_dir3  := d3

    [s4, d4] = _utbot_stop(_utbot_c4, _utbot_a4, lib_utbot_keyval, _utbot_stop4, _utbot_dir4)
    _utbot_stop4 := s4
    _utbot_dir4  := d4

    [s5, d5] = _utbot_stop(_utbot_c5, _utbot_a5, lib_utbot_keyval, _utbot_stop5, _utbot_dir5)
    _utbot_stop5 := s5
    _utbot_dir5  := d5

    [s6, d6] = _utbot_stop(_utbot_c6, _utbot_a6, lib_utbot_keyval, _utbot_stop6, _utbot_dir6)
    _utbot_stop6 := s6
    _utbot_dir6  := d6

    // Chart TF values for triggers
    float _utbot_p_chart = _utbot_c_chart
    float _utbot_s_chart = _utbot_stop1  // Use TF1 stop for chart (simplified)
    float _utbot_p_prev = _utbot_c_chart[1]
    float _utbot_s_prev = _utbot_stop1[1]

    // Call library's builder function
    tfUTBot.TFModuleOutput _utbotOut = tfUTBot.buildOutput(
        _utbot_c1, _utbot_stop1,
        _utbot_c2, _utbot_stop2,
        _utbot_c3, _utbot_stop3,
        _utbot_c4, _utbot_stop4,
        _utbot_c5, _utbot_stop5,
        _utbot_c6, _utbot_stop6,
        _utbot_p_chart, _utbot_s_chart, _utbot_p_prev, _utbot_s_prev,
        close
    )

    // Map to normalized V2 output
    lib_utbot_v2 := KB_TF_Out_V2.new(
        _utbotOut.tf1_label, _utbotOut.tf2_label, _utbotOut.tf3_label,
        _utbotOut.tf4_label, _utbotOut.tf5_label, _utbotOut.tf6_label,
        _utbotOut.condA_tf1, _utbotOut.condA_tf2, _utbotOut.condA_tf3,
        _utbotOut.condA_tf4, _utbotOut.condA_tf5, _utbotOut.condA_tf6,
        _utbotOut.condB_tf1, _utbotOut.condB_tf2, _utbotOut.condB_tf3,
        _utbotOut.condB_tf4, _utbotOut.condB_tf5, _utbotOut.condB_tf6,
        _utbotOut.condC_tf1, _utbotOut.condC_tf2, _utbotOut.condC_tf3,
        _utbotOut.condC_tf4, _utbotOut.condC_tf5, _utbotOut.condC_tf6,
        _utbotOut.condD_tf1, _utbotOut.condD_tf2, _utbotOut.condD_tf3,
        _utbotOut.condD_tf4, _utbotOut.condD_tf5, _utbotOut.condD_tf6,
        _utbotOut.condE_tf1, _utbotOut.condE_tf2, _utbotOut.condE_tf3,
        _utbotOut.condE_tf4, _utbotOut.condE_tf5, _utbotOut.condE_tf6,
        _utbotOut.condF_tf1, _utbotOut.condF_tf2, _utbotOut.condF_tf3,
        _utbotOut.condF_tf4, _utbotOut.condF_tf5, _utbotOut.condF_tf6,
        _utbotOut.condG_tf1, _utbotOut.condG_tf2, _utbotOut.condG_tf3,
        _utbotOut.condG_tf4, _utbotOut.condG_tf5, _utbotOut.condG_tf6,
        _utbotOut.condH_tf1, _utbotOut.condH_tf2, _utbotOut.condH_tf3,
        _utbotOut.condH_tf4, _utbotOut.condH_tf5, _utbotOut.condH_tf6,
        _utbotOut.condI_tf1, _utbotOut.condI_tf2, _utbotOut.condI_tf3,
        _utbotOut.condI_tf4, _utbotOut.condI_tf5, _utbotOut.condI_tf6,
        _utbotOut.condJ_tf1, _utbotOut.condJ_tf2, _utbotOut.condJ_tf3,
        _utbotOut.condJ_tf4, _utbotOut.condJ_tf5, _utbotOut.condJ_tf6,
        _utbotOut.trigA, _utbotOut.trigB, _utbotOut.trigC, _utbotOut.trigD, _utbotOut.trigE,
        _utbotOut.trigF, _utbotOut.trigG, _utbotOut.trigH, _utbotOut.trigI, _utbotOut.trigJ,
        _utbotOut.trigger_price, _utbotOut.trigger_label
    )


//──────────────────────────────────────────────────────────────────────────────
// 8-4. SWING 123 LOADER
// Only executes request.security() calls if lib_swing_enabled is true
//──────────────────────────────────────────────────────────────────────────────

var KB_TF_Out_V2 lib_swing_v2 = KB_TF_Out_V2.new()

if lib_swing_enabled
    // Fetch pattern flags for each TF
    [_sw_bc2_1, _sw_bc3_1, _sw_xc2_1, _sw_xc3_1, _sw_rb_1, _sw_rx_1] = request.security(syminfo.tickerid, _tf_res_v2(tf1),
        [_sw_bc2(), _sw_bc3(), _sw_xc2(), _sw_xc3(), _sw_rbull(), _sw_rbear()], barmerge.gaps_off, barmerge.lookahead_off)
    [_sw_bc2_2, _sw_bc3_2, _sw_xc2_2, _sw_xc3_2, _sw_rb_2, _sw_rx_2] = request.security(syminfo.tickerid, _tf_res_v2(tf2),
        [_sw_bc2(), _sw_bc3(), _sw_xc2(), _sw_xc3(), _sw_rbull(), _sw_rbear()], barmerge.gaps_off, barmerge.lookahead_off)
    [_sw_bc2_3, _sw_bc3_3, _sw_xc2_3, _sw_xc3_3, _sw_rb_3, _sw_rx_3] = request.security(syminfo.tickerid, _tf_res_v2(tf3),
        [_sw_bc2(), _sw_bc3(), _sw_xc2(), _sw_xc3(), _sw_rbull(), _sw_rbear()], barmerge.gaps_off, barmerge.lookahead_off)
    [_sw_bc2_4, _sw_bc3_4, _sw_xc2_4, _sw_xc3_4, _sw_rb_4, _sw_rx_4] = request.security(syminfo.tickerid, _tf_res_v2(tf4),
        [_sw_bc2(), _sw_bc3(), _sw_xc2(), _sw_xc3(), _sw_rbull(), _sw_rbear()], barmerge.gaps_off, barmerge.lookahead_off)
    [_sw_bc2_5, _sw_bc3_5, _sw_xc2_5, _sw_xc3_5, _sw_rb_5, _sw_rx_5] = request.security(syminfo.tickerid, _tf_res_v2(tf5),
        [_sw_bc2(), _sw_bc3(), _sw_xc2(), _sw_xc3(), _sw_rbull(), _sw_rbear()], barmerge.gaps_off, barmerge.lookahead_off)
    [_sw_bc2_6, _sw_bc3_6, _sw_xc2_6, _sw_xc3_6, _sw_rb_6, _sw_rx_6] = request.security(syminfo.tickerid, _tf_res_v2(tf6),
        [_sw_bc2(), _sw_bc3(), _sw_xc2(), _sw_xc3(), _sw_rbull(), _sw_rbear()], barmerge.gaps_off, barmerge.lookahead_off)

    // Chart TF patterns for triggers
    bool _sw_bc2_chart = _sw_bc2()
    bool _sw_bc3_chart = _sw_bc3()
    bool _sw_xc2_chart = _sw_xc2()
    bool _sw_xc3_chart = _sw_xc3()

    // Call library's builder function with boolean flags
    tfSwing123.TFModuleOutput _swingOut = tfSwing123.buildOutput(
        _sw_bc2_1, _sw_bc3_1, _sw_xc2_1, _sw_xc3_1, _sw_rb_1, _sw_rx_1,
        _sw_bc2_2, _sw_bc3_2, _sw_xc2_2, _sw_xc3_2, _sw_rb_2, _sw_rx_2,
        _sw_bc2_3, _sw_bc3_3, _sw_xc2_3, _sw_xc3_3, _sw_rb_3, _sw_rx_3,
        _sw_bc2_4, _sw_bc3_4, _sw_xc2_4, _sw_xc3_4, _sw_rb_4, _sw_rx_4,
        _sw_bc2_5, _sw_bc3_5, _sw_xc2_5, _sw_xc3_5, _sw_rb_5, _sw_rx_5,
        _sw_bc2_6, _sw_bc3_6, _sw_xc2_6, _sw_xc3_6, _sw_rb_6, _sw_rx_6,
        _sw_bc2_chart, _sw_bc3_chart, _sw_xc2_chart, _sw_xc3_chart,
        close
    )

    // Map to normalized V2 output
    lib_swing_v2 := KB_TF_Out_V2.new(
        _swingOut.tf1_label, _swingOut.tf2_label, _swingOut.tf3_label,
        _swingOut.tf4_label, _swingOut.tf5_label, _swingOut.tf6_label,
        _swingOut.condA_tf1, _swingOut.condA_tf2, _swingOut.condA_tf3,
        _swingOut.condA_tf4, _swingOut.condA_tf5, _swingOut.condA_tf6,
        _swingOut.condB_tf1, _swingOut.condB_tf2, _swingOut.condB_tf3,
        _swingOut.condB_tf4, _swingOut.condB_tf5, _swingOut.condB_tf6,
        _swingOut.condC_tf1, _swingOut.condC_tf2, _swingOut.condC_tf3,
        _swingOut.condC_tf4, _swingOut.condC_tf5, _swingOut.condC_tf6,
        _swingOut.condD_tf1, _swingOut.condD_tf2, _swingOut.condD_tf3,
        _swingOut.condD_tf4, _swingOut.condD_tf5, _swingOut.condD_tf6,
        _swingOut.condE_tf1, _swingOut.condE_tf2, _swingOut.condE_tf3,
        _swingOut.condE_tf4, _swingOut.condE_tf5, _swingOut.condE_tf6,
        _swingOut.condF_tf1, _swingOut.condF_tf2, _swingOut.condF_tf3,
        _swingOut.condF_tf4, _swingOut.condF_tf5, _swingOut.condF_tf6,
        _swingOut.condG_tf1, _swingOut.condG_tf2, _swingOut.condG_tf3,
        _swingOut.condG_tf4, _swingOut.condG_tf5, _swingOut.condG_tf6,
        _swingOut.condH_tf1, _swingOut.condH_tf2, _swingOut.condH_tf3,
        _swingOut.condH_tf4, _swingOut.condH_tf5, _swingOut.condH_tf6,
        _swingOut.condI_tf1, _swingOut.condI_tf2, _swingOut.condI_tf3,
        _swingOut.condI_tf4, _swingOut.condI_tf5, _swingOut.condI_tf6,
        _swingOut.condJ_tf1, _swingOut.condJ_tf2, _swingOut.condJ_tf3,
        _swingOut.condJ_tf4, _swingOut.condJ_tf5, _swingOut.condJ_tf6,
        _swingOut.trigA, _swingOut.trigB, _swingOut.trigC, _swingOut.trigD, _swingOut.trigE,
        _swingOut.trigF, _swingOut.trigG, _swingOut.trigH, _swingOut.trigI, _swingOut.trigJ,
        _swingOut.trigger_price, _swingOut.trigger_label
    )


//──────────────────────────────────────────────────────────────────────────────
// 8-5. MACD LINE LOADER
// Only executes request.security() calls if lib_macdl_enabled is true
//──────────────────────────────────────────────────────────────────────────────

var KB_TF_Out_V2 lib_macdl_v2 = KB_TF_Out_V2.new()

if lib_macdl_enabled
    // Calculate MACD components
    float _macdl_fast = ta.ema(close, lib_macdl_fast)
    float _macdl_slow = ta.ema(close, lib_macdl_slow)
    float _macdl_macd = _macdl_fast - _macdl_slow
    float _macdl_sig  = ta.ema(_macdl_macd, lib_macdl_signal)

    // Fetch MACD and Signal for each TF
    [_macdl_m1, _macdl_s1] = request.security(syminfo.tickerid, _tf_res_v2(tf1),
        [_macdl_macd, _macdl_sig], barmerge.gaps_off, barmerge.lookahead_off)
    [_macdl_m2, _macdl_s2] = request.security(syminfo.tickerid, _tf_res_v2(tf2),
        [_macdl_macd, _macdl_sig], barmerge.gaps_off, barmerge.lookahead_off)
    [_macdl_m3, _macdl_s3] = request.security(syminfo.tickerid, _tf_res_v2(tf3),
        [_macdl_macd, _macdl_sig], barmerge.gaps_off, barmerge.lookahead_off)
    [_macdl_m4, _macdl_s4] = request.security(syminfo.tickerid, _tf_res_v2(tf4),
        [_macdl_macd, _macdl_sig], barmerge.gaps_off, barmerge.lookahead_off)
    [_macdl_m5, _macdl_s5] = request.security(syminfo.tickerid, _tf_res_v2(tf5),
        [_macdl_macd, _macdl_sig], barmerge.gaps_off, barmerge.lookahead_off)
    [_macdl_m6, _macdl_s6] = request.security(syminfo.tickerid, _tf_res_v2(tf6),
        [_macdl_macd, _macdl_sig], barmerge.gaps_off, barmerge.lookahead_off)

    // Chart TF values for triggers
    float _macdl_m_chart = _macdl_macd
    float _macdl_s_chart = _macdl_sig
    float _macdl_m_prev = _macdl_macd[1]
    float _macdl_s_prev = _macdl_sig[1]

    // Call library's builder function
    tfMACDLine.TFModuleOutput _macdlOut = tfMACDLine.buildOutput(
        _macdl_m1, _macdl_s1,
        _macdl_m2, _macdl_s2,
        _macdl_m3, _macdl_s3,
        _macdl_m4, _macdl_s4,
        _macdl_m5, _macdl_s5,
        _macdl_m6, _macdl_s6,
        _macdl_m_chart, _macdl_s_chart, _macdl_m_prev, _macdl_s_prev,
        close
    )

    // Map to normalized V2 output
    lib_macdl_v2 := KB_TF_Out_V2.new(
        _macdlOut.tf1_label, _macdlOut.tf2_label, _macdlOut.tf3_label,
        _macdlOut.tf4_label, _macdlOut.tf5_label, _macdlOut.tf6_label,
        _macdlOut.condA_tf1, _macdlOut.condA_tf2, _macdlOut.condA_tf3,
        _macdlOut.condA_tf4, _macdlOut.condA_tf5, _macdlOut.condA_tf6,
        _macdlOut.condB_tf1, _macdlOut.condB_tf2, _macdlOut.condB_tf3,
        _macdlOut.condB_tf4, _macdlOut.condB_tf5, _macdlOut.condB_tf6,
        _macdlOut.condC_tf1, _macdlOut.condC_tf2, _macdlOut.condC_tf3,
        _macdlOut.condC_tf4, _macdlOut.condC_tf5, _macdlOut.condC_tf6,
        _macdlOut.condD_tf1, _macdlOut.condD_tf2, _macdlOut.condD_tf3,
        _macdlOut.condD_tf4, _macdlOut.condD_tf5, _macdlOut.condD_tf6,
        _macdlOut.condE_tf1, _macdlOut.condE_tf2, _macdlOut.condE_tf3,
        _macdlOut.condE_tf4, _macdlOut.condE_tf5, _macdlOut.condE_tf6,
        _macdlOut.condF_tf1, _macdlOut.condF_tf2, _macdlOut.condF_tf3,
        _macdlOut.condF_tf4, _macdlOut.condF_tf5, _macdlOut.condF_tf6,
        _macdlOut.condG_tf1, _macdlOut.condG_tf2, _macdlOut.condG_tf3,
        _macdlOut.condG_tf4, _macdlOut.condG_tf5, _macdlOut.condG_tf6,
        _macdlOut.condH_tf1, _macdlOut.condH_tf2, _macdlOut.condH_tf3,
        _macdlOut.condH_tf4, _macdlOut.condH_tf5, _macdlOut.condH_tf6,
        _macdlOut.condI_tf1, _macdlOut.condI_tf2, _macdlOut.condI_tf3,
        _macdlOut.condI_tf4, _macdlOut.condI_tf5, _macdlOut.condI_tf6,
        _macdlOut.condJ_tf1, _macdlOut.condJ_tf2, _macdlOut.condJ_tf3,
        _macdlOut.condJ_tf4, _macdlOut.condJ_tf5, _macdlOut.condJ_tf6,
        _macdlOut.trigA, _macdlOut.trigB, _macdlOut.trigC, _macdlOut.trigD, _macdlOut.trigE,
        _macdlOut.trigF, _macdlOut.trigG, _macdlOut.trigH, _macdlOut.trigI, _macdlOut.trigJ,
        _macdlOut.trigger_price, _macdlOut.trigger_label
    )


//──────────────────────────────────────────────────────────────────────────────
// 8-6. MACD HISTOGRAM LOADER
// Only executes request.security() calls if lib_macdh_enabled is true
//──────────────────────────────────────────────────────────────────────────────

var KB_TF_Out_V2 lib_macdh_v2 = KB_TF_Out_V2.new()

if lib_macdh_enabled
    // Calculate MACD components
    float _macdh_fast = ta.ema(close, lib_macdh_fast)
    float _macdh_slow = ta.ema(close, lib_macdh_slow)
    float _macdh_macd = _macdh_fast - _macdh_slow
    float _macdh_sig  = ta.ema(_macdh_macd, lib_macdh_signal)
    float _macdh_hist = _macdh_macd - _macdh_sig

    // Fetch Histogram and prev Histogram for each TF
    [_macdh_h1, _macdh_hp1] = request.security(syminfo.tickerid, _tf_res_v2(tf1),
        [_macdh_hist, _macdh_hist[1]], barmerge.gaps_off, barmerge.lookahead_off)
    [_macdh_h2, _macdh_hp2] = request.security(syminfo.tickerid, _tf_res_v2(tf2),
        [_macdh_hist, _macdh_hist[1]], barmerge.gaps_off, barmerge.lookahead_off)
    [_macdh_h3, _macdh_hp3] = request.security(syminfo.tickerid, _tf_res_v2(tf3),
        [_macdh_hist, _macdh_hist[1]], barmerge.gaps_off, barmerge.lookahead_off)
    [_macdh_h4, _macdh_hp4] = request.security(syminfo.tickerid, _tf_res_v2(tf4),
        [_macdh_hist, _macdh_hist[1]], barmerge.gaps_off, barmerge.lookahead_off)
    [_macdh_h5, _macdh_hp5] = request.security(syminfo.tickerid, _tf_res_v2(tf5),
        [_macdh_hist, _macdh_hist[1]], barmerge.gaps_off, barmerge.lookahead_off)
    [_macdh_h6, _macdh_hp6] = request.security(syminfo.tickerid, _tf_res_v2(tf6),
        [_macdh_hist, _macdh_hist[1]], barmerge.gaps_off, barmerge.lookahead_off)

    // Chart TF values for triggers
    float _macdh_h_chart = _macdh_hist
    float _macdh_h_prev = _macdh_hist[1]
    float _macdh_h_prev2 = _macdh_hist[2]

    // Call library's builder function
    tfMACDHistogram.TFModuleOutput _macdhOut = tfMACDHistogram.buildOutput(
        _macdh_h1, _macdh_hp1,
        _macdh_h2, _macdh_hp2,
        _macdh_h3, _macdh_hp3,
        _macdh_h4, _macdh_hp4,
        _macdh_h5, _macdh_hp5,
        _macdh_h6, _macdh_hp6,
        _macdh_h_chart, _macdh_h_prev, _macdh_h_prev2,
        close
    )

    // Map to normalized V2 output
    lib_macdh_v2 := KB_TF_Out_V2.new(
        _macdhOut.tf1_label, _macdhOut.tf2_label, _macdhOut.tf3_label,
        _macdhOut.tf4_label, _macdhOut.tf5_label, _macdhOut.tf6_label,
        _macdhOut.condA_tf1, _macdhOut.condA_tf2, _macdhOut.condA_tf3,
        _macdhOut.condA_tf4, _macdhOut.condA_tf5, _macdhOut.condA_tf6,
        _macdhOut.condB_tf1, _macdhOut.condB_tf2, _macdhOut.condB_tf3,
        _macdhOut.condB_tf4, _macdhOut.condB_tf5, _macdhOut.condB_tf6,
        _macdhOut.condC_tf1, _macdhOut.condC_tf2, _macdhOut.condC_tf3,
        _macdhOut.condC_tf4, _macdhOut.condC_tf5, _macdhOut.condC_tf6,
        _macdhOut.condD_tf1, _macdhOut.condD_tf2, _macdhOut.condD_tf3,
        _macdhOut.condD_tf4, _macdhOut.condD_tf5, _macdhOut.condD_tf6,
        _macdhOut.condE_tf1, _macdhOut.condE_tf2, _macdhOut.condE_tf3,
        _macdhOut.condE_tf4, _macdhOut.condE_tf5, _macdhOut.condE_tf6,
        _macdhOut.condF_tf1, _macdhOut.condF_tf2, _macdhOut.condF_tf3,
        _macdhOut.condF_tf4, _macdhOut.condF_tf5, _macdhOut.condF_tf6,
        _macdhOut.condG_tf1, _macdhOut.condG_tf2, _macdhOut.condG_tf3,
        _macdhOut.condG_tf4, _macdhOut.condG_tf5, _macdhOut.condG_tf6,
        _macdhOut.condH_tf1, _macdhOut.condH_tf2, _macdhOut.condH_tf3,
        _macdhOut.condH_tf4, _macdhOut.condH_tf5, _macdhOut.condH_tf6,
        _macdhOut.condI_tf1, _macdhOut.condI_tf2, _macdhOut.condI_tf3,
        _macdhOut.condI_tf4, _macdhOut.condI_tf5, _macdhOut.condI_tf6,
        _macdhOut.condJ_tf1, _macdhOut.condJ_tf2, _macdhOut.condJ_tf3,
        _macdhOut.condJ_tf4, _macdhOut.condJ_tf5, _macdhOut.condJ_tf6,
        _macdhOut.trigA, _macdhOut.trigB, _macdhOut.trigC, _macdhOut.trigD, _macdhOut.trigE,
        _macdhOut.trigF, _macdhOut.trigG, _macdhOut.trigH, _macdhOut.trigI, _macdhOut.trigJ,
        _macdhOut.trigger_price, _macdhOut.trigger_label
    )


//──────────────────────────────────────────────────────────────────────────────
// 8-7. SIMPLE MACD LOADER
// Only executes request.security() calls if lib_macds_enabled is true
//──────────────────────────────────────────────────────────────────────────────

var KB_TF_Out_V2 lib_macds_v2 = KB_TF_Out_V2.new()

if lib_macds_enabled
    // Calculate MACD components
    float _macds_fast = ta.ema(close, lib_macds_fast)
    float _macds_slow = ta.ema(close, lib_macds_slow)
    float _macds_macd = _macds_fast - _macds_slow
    float _macds_sig  = ta.ema(_macds_macd, lib_macds_signal)

    // Fetch MACD, Signal, prev MACD, prev Signal for each TF
    [_macds_m1, _macds_s1, _macds_mp1, _macds_sp1] = request.security(syminfo.tickerid, _tf_res_v2(tf1),
        [_macds_macd, _macds_sig, _macds_macd[1], _macds_sig[1]], barmerge.gaps_off, barmerge.lookahead_off)
    [_macds_m2, _macds_s2, _macds_mp2, _macds_sp2] = request.security(syminfo.tickerid, _tf_res_v2(tf2),
        [_macds_macd, _macds_sig, _macds_macd[1], _macds_sig[1]], barmerge.gaps_off, barmerge.lookahead_off)
    [_macds_m3, _macds_s3, _macds_mp3, _macds_sp3] = request.security(syminfo.tickerid, _tf_res_v2(tf3),
        [_macds_macd, _macds_sig, _macds_macd[1], _macds_sig[1]], barmerge.gaps_off, barmerge.lookahead_off)
    [_macds_m4, _macds_s4, _macds_mp4, _macds_sp4] = request.security(syminfo.tickerid, _tf_res_v2(tf4),
        [_macds_macd, _macds_sig, _macds_macd[1], _macds_sig[1]], barmerge.gaps_off, barmerge.lookahead_off)
    [_macds_m5, _macds_s5, _macds_mp5, _macds_sp5] = request.security(syminfo.tickerid, _tf_res_v2(tf5),
        [_macds_macd, _macds_sig, _macds_macd[1], _macds_sig[1]], barmerge.gaps_off, barmerge.lookahead_off)
    [_macds_m6, _macds_s6, _macds_mp6, _macds_sp6] = request.security(syminfo.tickerid, _tf_res_v2(tf6),
        [_macds_macd, _macds_sig, _macds_macd[1], _macds_sig[1]], barmerge.gaps_off, barmerge.lookahead_off)

    // Chart TF values for triggers
    float _macds_m_chart = _macds_macd
    float _macds_s_chart = _macds_sig
    float _macds_m_prev = _macds_macd[1]
    float _macds_s_prev = _macds_sig[1]

    // Call library's builder function
    tfMACDSimple.TFModuleOutput _macdsOut = tfMACDSimple.buildOutput(
        _macds_m1, _macds_s1, _macds_mp1, _macds_sp1,
        _macds_m2, _macds_s2, _macds_mp2, _macds_sp2,
        _macds_m3, _macds_s3, _macds_mp3, _macds_sp3,
        _macds_m4, _macds_s4, _macds_mp4, _macds_sp4,
        _macds_m5, _macds_s5, _macds_mp5, _macds_sp5,
        _macds_m6, _macds_s6, _macds_mp6, _macds_sp6,
        _macds_m_chart, _macds_s_chart, _macds_m_prev, _macds_s_prev,
        close
    )

    // Map to normalized V2 output
    lib_macds_v2 := KB_TF_Out_V2.new(
        _macdsOut.tf1_label, _macdsOut.tf2_label, _macdsOut.tf3_label,
        _macdsOut.tf4_label, _macdsOut.tf5_label, _macdsOut.tf6_label,
        _macdsOut.condA_tf1, _macdsOut.condA_tf2, _macdsOut.condA_tf3,
        _macdsOut.condA_tf4, _macdsOut.condA_tf5, _macdsOut.condA_tf6,
        _macdsOut.condB_tf1, _macdsOut.condB_tf2, _macdsOut.condB_tf3,
        _macdsOut.condB_tf4, _macdsOut.condB_tf5, _macdsOut.condB_tf6,
        _macdsOut.condC_tf1, _macdsOut.condC_tf2, _macdsOut.condC_tf3,
        _macdsOut.condC_tf4, _macdsOut.condC_tf5, _macdsOut.condC_tf6,
        _macdsOut.condD_tf1, _macdsOut.condD_tf2, _macdsOut.condD_tf3,
        _macdsOut.condD_tf4, _macdsOut.condD_tf5, _macdsOut.condD_tf6,
        _macdsOut.condE_tf1, _macdsOut.condE_tf2, _macdsOut.condE_tf3,
        _macdsOut.condE_tf4, _macdsOut.condE_tf5, _macdsOut.condE_tf6,
        _macdsOut.condF_tf1, _macdsOut.condF_tf2, _macdsOut.condF_tf3,
        _macdsOut.condF_tf4, _macdsOut.condF_tf5, _macdsOut.condF_tf6,
        _macdsOut.condG_tf1, _macdsOut.condG_tf2, _macdsOut.condG_tf3,
        _macdsOut.condG_tf4, _macdsOut.condG_tf5, _macdsOut.condG_tf6,
        _macdsOut.condH_tf1, _macdsOut.condH_tf2, _macdsOut.condH_tf3,
        _macdsOut.condH_tf4, _macdsOut.condH_tf5, _macdsOut.condH_tf6,
        _macdsOut.condI_tf1, _macdsOut.condI_tf2, _macdsOut.condI_tf3,
        _macdsOut.condI_tf4, _macdsOut.condI_tf5, _macdsOut.condI_tf6,
        _macdsOut.condJ_tf1, _macdsOut.condJ_tf2, _macdsOut.condJ_tf3,
        _macdsOut.condJ_tf4, _macdsOut.condJ_tf5, _macdsOut.condJ_tf6,
        _macdsOut.trigA, _macdsOut.trigB, _macdsOut.trigC, _macdsOut.trigD, _macdsOut.trigE,
        _macdsOut.trigF, _macdsOut.trigG, _macdsOut.trigH, _macdsOut.trigI, _macdsOut.trigJ,
        _macdsOut.trigger_price, _macdsOut.trigger_label
    )


//──────────────────────────────────────────────────────────────────────────────
// 8-8. TOP VWAP LOADER
// Calculates Daily, Weekly, and Monthly anchored VWAPs directly on chart TF.
// No request.security needed since all VWAPs are calculated on current chart.
//──────────────────────────────────────────────────────────────────────────────

// Output variables for VWAP zone labels
var string lib_vwap_D_zone = "na"
var string lib_vwap_W_zone = "na"
var string lib_vwap_M_zone = "na"

// VWAP values for potential plotting/export
var float _vwap_D_val = na
var float _vwap_W_val = na
var float _vwap_M_val = na
var float _vwap_D_sd = na
var float _vwap_W_sd = na
var float _vwap_M_sd = na

// VWAP zone condition booleans (for confluence engine) - Sigma-based zones
var bool vwap_D_above2s = false   // >+2σ
var bool vwap_D_1to2s   = false   // +1σ to +2σ
var bool vwap_D_0to1s   = false   // 0 to +1σ
var bool vwap_D_atV     = false   // @V
var bool vwap_D_n1to0   = false   // -1σ to 0
var bool vwap_D_n2ton1  = false   // -2σ to -1σ
var bool vwap_D_below2s = false   // <-2σ

var bool vwap_W_above2s = false
var bool vwap_W_1to2s   = false
var bool vwap_W_0to1s   = false
var bool vwap_W_atV     = false
var bool vwap_W_n1to0   = false
var bool vwap_W_n2ton1  = false
var bool vwap_W_below2s = false

var bool vwap_M_above2s = false
var bool vwap_M_1to2s   = false
var bool vwap_M_0to1s   = false
var bool vwap_M_atV     = false
var bool vwap_M_n1to0   = false
var bool vwap_M_n2ton1  = false
var bool vwap_M_below2s = false

if lib_vwap_enabled
    // Calculate anchored VWAPs directly on chart timeframe
    [_vwap_D, _sd_D] = _kb_calcVWAP()    // Daily reset
    [_vwap_W, _sd_W] = _kb_calcVWAP_W()  // Weekly reset
    [_vwap_M, _sd_M] = _kb_calcVWAP_M()  // Monthly reset

    // Store values
    _vwap_D_val := _vwap_D
    _vwap_W_val := _vwap_W
    _vwap_M_val := _vwap_M
    _vwap_D_sd := _sd_D
    _vwap_W_sd := _sd_W
    _vwap_M_sd := _sd_M

    // Determine zone labels based on current price vs each anchored VWAP
    lib_vwap_D_zone := _kb_vwapZoneLabel(close, _vwap_D, _sd_D, lib_vwap_band1, lib_vwap_band2)
    lib_vwap_W_zone := _kb_vwapZoneLabel(close, _vwap_W, _sd_W, lib_vwap_band1, lib_vwap_band2)
    lib_vwap_M_zone := _kb_vwapZoneLabel(close, _vwap_M, _sd_M, lib_vwap_band1, lib_vwap_band2)

    // Calculate condition booleans for Daily VWAP (direct sigma zone mapping)
    vwap_D_above2s := lib_vwap_D_zone == ">+2σ"
    vwap_D_1to2s   := lib_vwap_D_zone == ">+1σ"
    vwap_D_0to1s   := lib_vwap_D_zone == ">V"
    vwap_D_atV     := lib_vwap_D_zone == "@V"
    vwap_D_n1to0   := lib_vwap_D_zone == "<V"
    vwap_D_n2ton1  := lib_vwap_D_zone == "<-1σ"
    vwap_D_below2s := lib_vwap_D_zone == "<-2σ"

    // Calculate condition booleans for Weekly VWAP
    vwap_W_above2s := lib_vwap_W_zone == ">+2σ"
    vwap_W_1to2s   := lib_vwap_W_zone == ">+1σ"
    vwap_W_0to1s   := lib_vwap_W_zone == ">V"
    vwap_W_atV     := lib_vwap_W_zone == "@V"
    vwap_W_n1to0   := lib_vwap_W_zone == "<V"
    vwap_W_n2ton1  := lib_vwap_W_zone == "<-1σ"
    vwap_W_below2s := lib_vwap_W_zone == "<-2σ"

    // Calculate condition booleans for Monthly VWAP
    vwap_M_above2s := lib_vwap_M_zone == ">+2σ"
    vwap_M_1to2s   := lib_vwap_M_zone == ">+1σ"
    vwap_M_0to1s   := lib_vwap_M_zone == ">V"
    vwap_M_atV     := lib_vwap_M_zone == "@V"
    vwap_M_n1to0   := lib_vwap_M_zone == "<V"
    vwap_M_n2ton1  := lib_vwap_M_zone == "<-1σ"
    vwap_M_below2s := lib_vwap_M_zone == "<-2σ"


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// END LIBRARY LOADERS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 9. AND/OR CONFLUENCE ENGINE
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
//
// Entry Logic:
//   Entry Valid = (AND Group ALL true)
//                 AND (OR1 meets minimum)
//                 AND (OR2 meets minimum)
//                 AND (OR3 meets minimum)
//                 AND (Entry Trigger fires)
//
// Empty groups automatically pass.
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

// Helper: check if condition contributes to a group and return 1 if true, 0 if false
_chkCond(string grpAssign, string targetGrp, bool condVal) =>
    grpAssign == targetGrp and condVal ? 1 : 0

// Helper: check if condition is assigned to a group (for counting total assigned)
_isAssigned(string grpAssign, string targetGrp) =>
    grpAssign == targetGrp ? 1 : 0

//──────────────────────────────────────────────────────────────────────────────
// 9-1. COUNT AND GROUP CONDITIONS
//──────────────────────────────────────────────────────────────────────────────

int and_total = 0
int and_true = 0

// EMA Stack AND conditions (condA=SML, condB=LMS, condC=SLM, condD=MSL, condE=MLS, condF=LSM)
if lib_ema_enabled
    and_total += _isAssigned(lib_ema_TF1_SML, "AND") + _isAssigned(lib_ema_TF1_LMS, "AND") + _isAssigned(lib_ema_TF1_SLM, "AND") + _isAssigned(lib_ema_TF1_MSL, "AND") + _isAssigned(lib_ema_TF1_MLS, "AND") + _isAssigned(lib_ema_TF1_LSM, "AND")
    and_total += _isAssigned(lib_ema_TF2_SML, "AND") + _isAssigned(lib_ema_TF2_LMS, "AND") + _isAssigned(lib_ema_TF2_SLM, "AND") + _isAssigned(lib_ema_TF2_MSL, "AND") + _isAssigned(lib_ema_TF2_MLS, "AND") + _isAssigned(lib_ema_TF2_LSM, "AND")
    and_total += _isAssigned(lib_ema_TF3_SML, "AND") + _isAssigned(lib_ema_TF3_LMS, "AND") + _isAssigned(lib_ema_TF3_SLM, "AND") + _isAssigned(lib_ema_TF3_MSL, "AND") + _isAssigned(lib_ema_TF3_MLS, "AND") + _isAssigned(lib_ema_TF3_LSM, "AND")
    and_total += _isAssigned(lib_ema_TF4_SML, "AND") + _isAssigned(lib_ema_TF4_LMS, "AND") + _isAssigned(lib_ema_TF4_SLM, "AND") + _isAssigned(lib_ema_TF4_MSL, "AND") + _isAssigned(lib_ema_TF4_MLS, "AND") + _isAssigned(lib_ema_TF4_LSM, "AND")
    and_total += _isAssigned(lib_ema_TF5_SML, "AND") + _isAssigned(lib_ema_TF5_LMS, "AND") + _isAssigned(lib_ema_TF5_SLM, "AND") + _isAssigned(lib_ema_TF5_MSL, "AND") + _isAssigned(lib_ema_TF5_MLS, "AND") + _isAssigned(lib_ema_TF5_LSM, "AND")
    and_total += _isAssigned(lib_ema_TF6_SML, "AND") + _isAssigned(lib_ema_TF6_LMS, "AND") + _isAssigned(lib_ema_TF6_SLM, "AND") + _isAssigned(lib_ema_TF6_MSL, "AND") + _isAssigned(lib_ema_TF6_MLS, "AND") + _isAssigned(lib_ema_TF6_LSM, "AND")
    and_true += _chkCond(lib_ema_TF1_SML, "AND", lib_ema_v2.condA_tf1) + _chkCond(lib_ema_TF1_LMS, "AND", lib_ema_v2.condB_tf1) + _chkCond(lib_ema_TF1_SLM, "AND", lib_ema_v2.condC_tf1) + _chkCond(lib_ema_TF1_MSL, "AND", lib_ema_v2.condD_tf1) + _chkCond(lib_ema_TF1_MLS, "AND", lib_ema_v2.condE_tf1) + _chkCond(lib_ema_TF1_LSM, "AND", lib_ema_v2.condF_tf1)
    and_true += _chkCond(lib_ema_TF2_SML, "AND", lib_ema_v2.condA_tf2) + _chkCond(lib_ema_TF2_LMS, "AND", lib_ema_v2.condB_tf2) + _chkCond(lib_ema_TF2_SLM, "AND", lib_ema_v2.condC_tf2) + _chkCond(lib_ema_TF2_MSL, "AND", lib_ema_v2.condD_tf2) + _chkCond(lib_ema_TF2_MLS, "AND", lib_ema_v2.condE_tf2) + _chkCond(lib_ema_TF2_LSM, "AND", lib_ema_v2.condF_tf2)
    and_true += _chkCond(lib_ema_TF3_SML, "AND", lib_ema_v2.condA_tf3) + _chkCond(lib_ema_TF3_LMS, "AND", lib_ema_v2.condB_tf3) + _chkCond(lib_ema_TF3_SLM, "AND", lib_ema_v2.condC_tf3) + _chkCond(lib_ema_TF3_MSL, "AND", lib_ema_v2.condD_tf3) + _chkCond(lib_ema_TF3_MLS, "AND", lib_ema_v2.condE_tf3) + _chkCond(lib_ema_TF3_LSM, "AND", lib_ema_v2.condF_tf3)
    and_true += _chkCond(lib_ema_TF4_SML, "AND", lib_ema_v2.condA_tf4) + _chkCond(lib_ema_TF4_LMS, "AND", lib_ema_v2.condB_tf4) + _chkCond(lib_ema_TF4_SLM, "AND", lib_ema_v2.condC_tf4) + _chkCond(lib_ema_TF4_MSL, "AND", lib_ema_v2.condD_tf4) + _chkCond(lib_ema_TF4_MLS, "AND", lib_ema_v2.condE_tf4) + _chkCond(lib_ema_TF4_LSM, "AND", lib_ema_v2.condF_tf4)
    and_true += _chkCond(lib_ema_TF5_SML, "AND", lib_ema_v2.condA_tf5) + _chkCond(lib_ema_TF5_LMS, "AND", lib_ema_v2.condB_tf5) + _chkCond(lib_ema_TF5_SLM, "AND", lib_ema_v2.condC_tf5) + _chkCond(lib_ema_TF5_MSL, "AND", lib_ema_v2.condD_tf5) + _chkCond(lib_ema_TF5_MLS, "AND", lib_ema_v2.condE_tf5) + _chkCond(lib_ema_TF5_LSM, "AND", lib_ema_v2.condF_tf5)
    and_true += _chkCond(lib_ema_TF6_SML, "AND", lib_ema_v2.condA_tf6) + _chkCond(lib_ema_TF6_LMS, "AND", lib_ema_v2.condB_tf6) + _chkCond(lib_ema_TF6_SLM, "AND", lib_ema_v2.condC_tf6) + _chkCond(lib_ema_TF6_MSL, "AND", lib_ema_v2.condD_tf6) + _chkCond(lib_ema_TF6_MLS, "AND", lib_ema_v2.condE_tf6) + _chkCond(lib_ema_TF6_LSM, "AND", lib_ema_v2.condF_tf6)

// RVOL AND conditions (condA=extreme, condB=veryHigh, condC=elevated, condD=normal, condE=low)
if lib_rvol_enabled
    and_total += _isAssigned(lib_rvol_TF1_extreme, "AND") + _isAssigned(lib_rvol_TF1_veryHigh, "AND") + _isAssigned(lib_rvol_TF1_elevated, "AND") + _isAssigned(lib_rvol_TF1_normal, "AND") + _isAssigned(lib_rvol_TF1_low, "AND")
    and_total += _isAssigned(lib_rvol_TF2_extreme, "AND") + _isAssigned(lib_rvol_TF2_veryHigh, "AND") + _isAssigned(lib_rvol_TF2_elevated, "AND") + _isAssigned(lib_rvol_TF2_normal, "AND") + _isAssigned(lib_rvol_TF2_low, "AND")
    and_total += _isAssigned(lib_rvol_TF3_extreme, "AND") + _isAssigned(lib_rvol_TF3_veryHigh, "AND") + _isAssigned(lib_rvol_TF3_elevated, "AND") + _isAssigned(lib_rvol_TF3_normal, "AND") + _isAssigned(lib_rvol_TF3_low, "AND")
    and_total += _isAssigned(lib_rvol_TF4_extreme, "AND") + _isAssigned(lib_rvol_TF4_veryHigh, "AND") + _isAssigned(lib_rvol_TF4_elevated, "AND") + _isAssigned(lib_rvol_TF4_normal, "AND") + _isAssigned(lib_rvol_TF4_low, "AND")
    and_total += _isAssigned(lib_rvol_TF5_extreme, "AND") + _isAssigned(lib_rvol_TF5_veryHigh, "AND") + _isAssigned(lib_rvol_TF5_elevated, "AND") + _isAssigned(lib_rvol_TF5_normal, "AND") + _isAssigned(lib_rvol_TF5_low, "AND")
    and_total += _isAssigned(lib_rvol_TF6_extreme, "AND") + _isAssigned(lib_rvol_TF6_veryHigh, "AND") + _isAssigned(lib_rvol_TF6_elevated, "AND") + _isAssigned(lib_rvol_TF6_normal, "AND") + _isAssigned(lib_rvol_TF6_low, "AND")
    and_true += _chkCond(lib_rvol_TF1_extreme, "AND", lib_rvol_v2.condA_tf1) + _chkCond(lib_rvol_TF1_veryHigh, "AND", lib_rvol_v2.condB_tf1) + _chkCond(lib_rvol_TF1_elevated, "AND", lib_rvol_v2.condC_tf1) + _chkCond(lib_rvol_TF1_normal, "AND", lib_rvol_v2.condD_tf1) + _chkCond(lib_rvol_TF1_low, "AND", lib_rvol_v2.condE_tf1)
    and_true += _chkCond(lib_rvol_TF2_extreme, "AND", lib_rvol_v2.condA_tf2) + _chkCond(lib_rvol_TF2_veryHigh, "AND", lib_rvol_v2.condB_tf2) + _chkCond(lib_rvol_TF2_elevated, "AND", lib_rvol_v2.condC_tf2) + _chkCond(lib_rvol_TF2_normal, "AND", lib_rvol_v2.condD_tf2) + _chkCond(lib_rvol_TF2_low, "AND", lib_rvol_v2.condE_tf2)
    and_true += _chkCond(lib_rvol_TF3_extreme, "AND", lib_rvol_v2.condA_tf3) + _chkCond(lib_rvol_TF3_veryHigh, "AND", lib_rvol_v2.condB_tf3) + _chkCond(lib_rvol_TF3_elevated, "AND", lib_rvol_v2.condC_tf3) + _chkCond(lib_rvol_TF3_normal, "AND", lib_rvol_v2.condD_tf3) + _chkCond(lib_rvol_TF3_low, "AND", lib_rvol_v2.condE_tf3)
    and_true += _chkCond(lib_rvol_TF4_extreme, "AND", lib_rvol_v2.condA_tf4) + _chkCond(lib_rvol_TF4_veryHigh, "AND", lib_rvol_v2.condB_tf4) + _chkCond(lib_rvol_TF4_elevated, "AND", lib_rvol_v2.condC_tf4) + _chkCond(lib_rvol_TF4_normal, "AND", lib_rvol_v2.condD_tf4) + _chkCond(lib_rvol_TF4_low, "AND", lib_rvol_v2.condE_tf4)
    and_true += _chkCond(lib_rvol_TF5_extreme, "AND", lib_rvol_v2.condA_tf5) + _chkCond(lib_rvol_TF5_veryHigh, "AND", lib_rvol_v2.condB_tf5) + _chkCond(lib_rvol_TF5_elevated, "AND", lib_rvol_v2.condC_tf5) + _chkCond(lib_rvol_TF5_normal, "AND", lib_rvol_v2.condD_tf5) + _chkCond(lib_rvol_TF5_low, "AND", lib_rvol_v2.condE_tf5)
    and_true += _chkCond(lib_rvol_TF6_extreme, "AND", lib_rvol_v2.condA_tf6) + _chkCond(lib_rvol_TF6_veryHigh, "AND", lib_rvol_v2.condB_tf6) + _chkCond(lib_rvol_TF6_elevated, "AND", lib_rvol_v2.condC_tf6) + _chkCond(lib_rvol_TF6_normal, "AND", lib_rvol_v2.condD_tf6) + _chkCond(lib_rvol_TF6_low, "AND", lib_rvol_v2.condE_tf6)

// UT Bot AND conditions (condA=bull, condB=bear)
if lib_utbot_enabled
    and_total += _isAssigned(lib_utbot_TF1_bull, "AND") + _isAssigned(lib_utbot_TF1_bear, "AND")
    and_total += _isAssigned(lib_utbot_TF2_bull, "AND") + _isAssigned(lib_utbot_TF2_bear, "AND")
    and_total += _isAssigned(lib_utbot_TF3_bull, "AND") + _isAssigned(lib_utbot_TF3_bear, "AND")
    and_total += _isAssigned(lib_utbot_TF4_bull, "AND") + _isAssigned(lib_utbot_TF4_bear, "AND")
    and_total += _isAssigned(lib_utbot_TF5_bull, "AND") + _isAssigned(lib_utbot_TF5_bear, "AND")
    and_total += _isAssigned(lib_utbot_TF6_bull, "AND") + _isAssigned(lib_utbot_TF6_bear, "AND")
    and_true += _chkCond(lib_utbot_TF1_bull, "AND", lib_utbot_v2.condA_tf1) + _chkCond(lib_utbot_TF1_bear, "AND", lib_utbot_v2.condB_tf1)
    and_true += _chkCond(lib_utbot_TF2_bull, "AND", lib_utbot_v2.condA_tf2) + _chkCond(lib_utbot_TF2_bear, "AND", lib_utbot_v2.condB_tf2)
    and_true += _chkCond(lib_utbot_TF3_bull, "AND", lib_utbot_v2.condA_tf3) + _chkCond(lib_utbot_TF3_bear, "AND", lib_utbot_v2.condB_tf3)
    and_true += _chkCond(lib_utbot_TF4_bull, "AND", lib_utbot_v2.condA_tf4) + _chkCond(lib_utbot_TF4_bear, "AND", lib_utbot_v2.condB_tf4)
    and_true += _chkCond(lib_utbot_TF5_bull, "AND", lib_utbot_v2.condA_tf5) + _chkCond(lib_utbot_TF5_bear, "AND", lib_utbot_v2.condB_tf5)
    and_true += _chkCond(lib_utbot_TF6_bull, "AND", lib_utbot_v2.condA_tf6) + _chkCond(lib_utbot_TF6_bear, "AND", lib_utbot_v2.condB_tf6)

// Swing 123 AND conditions (condA=BC2, condB=BC3, condC=XC2, condD=XC3, condE=Bup, condF=Xdn)
if lib_swing_enabled
    and_total += _isAssigned(lib_swing_TF1_BC2, "AND") + _isAssigned(lib_swing_TF1_BC3, "AND") + _isAssigned(lib_swing_TF1_XC2, "AND") + _isAssigned(lib_swing_TF1_XC3, "AND") + _isAssigned(lib_swing_TF1_Bup, "AND") + _isAssigned(lib_swing_TF1_Xdn, "AND")
    and_total += _isAssigned(lib_swing_TF2_BC2, "AND") + _isAssigned(lib_swing_TF2_BC3, "AND") + _isAssigned(lib_swing_TF2_XC2, "AND") + _isAssigned(lib_swing_TF2_XC3, "AND") + _isAssigned(lib_swing_TF2_Bup, "AND") + _isAssigned(lib_swing_TF2_Xdn, "AND")
    and_total += _isAssigned(lib_swing_TF3_BC2, "AND") + _isAssigned(lib_swing_TF3_BC3, "AND") + _isAssigned(lib_swing_TF3_XC2, "AND") + _isAssigned(lib_swing_TF3_XC3, "AND") + _isAssigned(lib_swing_TF3_Bup, "AND") + _isAssigned(lib_swing_TF3_Xdn, "AND")
    and_total += _isAssigned(lib_swing_TF4_BC2, "AND") + _isAssigned(lib_swing_TF4_BC3, "AND") + _isAssigned(lib_swing_TF4_XC2, "AND") + _isAssigned(lib_swing_TF4_XC3, "AND") + _isAssigned(lib_swing_TF4_Bup, "AND") + _isAssigned(lib_swing_TF4_Xdn, "AND")
    and_total += _isAssigned(lib_swing_TF5_BC2, "AND") + _isAssigned(lib_swing_TF5_BC3, "AND") + _isAssigned(lib_swing_TF5_XC2, "AND") + _isAssigned(lib_swing_TF5_XC3, "AND") + _isAssigned(lib_swing_TF5_Bup, "AND") + _isAssigned(lib_swing_TF5_Xdn, "AND")
    and_total += _isAssigned(lib_swing_TF6_BC2, "AND") + _isAssigned(lib_swing_TF6_BC3, "AND") + _isAssigned(lib_swing_TF6_XC2, "AND") + _isAssigned(lib_swing_TF6_XC3, "AND") + _isAssigned(lib_swing_TF6_Bup, "AND") + _isAssigned(lib_swing_TF6_Xdn, "AND")
    and_true += _chkCond(lib_swing_TF1_BC2, "AND", lib_swing_v2.condA_tf1) + _chkCond(lib_swing_TF1_BC3, "AND", lib_swing_v2.condB_tf1) + _chkCond(lib_swing_TF1_XC2, "AND", lib_swing_v2.condC_tf1) + _chkCond(lib_swing_TF1_XC3, "AND", lib_swing_v2.condD_tf1) + _chkCond(lib_swing_TF1_Bup, "AND", lib_swing_v2.condE_tf1) + _chkCond(lib_swing_TF1_Xdn, "AND", lib_swing_v2.condF_tf1)
    and_true += _chkCond(lib_swing_TF2_BC2, "AND", lib_swing_v2.condA_tf2) + _chkCond(lib_swing_TF2_BC3, "AND", lib_swing_v2.condB_tf2) + _chkCond(lib_swing_TF2_XC2, "AND", lib_swing_v2.condC_tf2) + _chkCond(lib_swing_TF2_XC3, "AND", lib_swing_v2.condD_tf2) + _chkCond(lib_swing_TF2_Bup, "AND", lib_swing_v2.condE_tf2) + _chkCond(lib_swing_TF2_Xdn, "AND", lib_swing_v2.condF_tf2)
    and_true += _chkCond(lib_swing_TF3_BC2, "AND", lib_swing_v2.condA_tf3) + _chkCond(lib_swing_TF3_BC3, "AND", lib_swing_v2.condB_tf3) + _chkCond(lib_swing_TF3_XC2, "AND", lib_swing_v2.condC_tf3) + _chkCond(lib_swing_TF3_XC3, "AND", lib_swing_v2.condD_tf3) + _chkCond(lib_swing_TF3_Bup, "AND", lib_swing_v2.condE_tf3) + _chkCond(lib_swing_TF3_Xdn, "AND", lib_swing_v2.condF_tf3)
    and_true += _chkCond(lib_swing_TF4_BC2, "AND", lib_swing_v2.condA_tf4) + _chkCond(lib_swing_TF4_BC3, "AND", lib_swing_v2.condB_tf4) + _chkCond(lib_swing_TF4_XC2, "AND", lib_swing_v2.condC_tf4) + _chkCond(lib_swing_TF4_XC3, "AND", lib_swing_v2.condD_tf4) + _chkCond(lib_swing_TF4_Bup, "AND", lib_swing_v2.condE_tf4) + _chkCond(lib_swing_TF4_Xdn, "AND", lib_swing_v2.condF_tf4)
    and_true += _chkCond(lib_swing_TF5_BC2, "AND", lib_swing_v2.condA_tf5) + _chkCond(lib_swing_TF5_BC3, "AND", lib_swing_v2.condB_tf5) + _chkCond(lib_swing_TF5_XC2, "AND", lib_swing_v2.condC_tf5) + _chkCond(lib_swing_TF5_XC3, "AND", lib_swing_v2.condD_tf5) + _chkCond(lib_swing_TF5_Bup, "AND", lib_swing_v2.condE_tf5) + _chkCond(lib_swing_TF5_Xdn, "AND", lib_swing_v2.condF_tf5)
    and_true += _chkCond(lib_swing_TF6_BC2, "AND", lib_swing_v2.condA_tf6) + _chkCond(lib_swing_TF6_BC3, "AND", lib_swing_v2.condB_tf6) + _chkCond(lib_swing_TF6_XC2, "AND", lib_swing_v2.condC_tf6) + _chkCond(lib_swing_TF6_XC3, "AND", lib_swing_v2.condD_tf6) + _chkCond(lib_swing_TF6_Bup, "AND", lib_swing_v2.condE_tf6) + _chkCond(lib_swing_TF6_Xdn, "AND", lib_swing_v2.condF_tf6)

// MACD Line AND conditions (condA=aboveRising, condB=aboveFalling, condC=belowFalling, condD=belowRising)
if lib_macdl_enabled
    and_total += _isAssigned(lib_macdl_TF1_aboveRising, "AND") + _isAssigned(lib_macdl_TF1_aboveFalling, "AND") + _isAssigned(lib_macdl_TF1_belowFalling, "AND") + _isAssigned(lib_macdl_TF1_belowRising, "AND")
    and_total += _isAssigned(lib_macdl_TF2_aboveRising, "AND") + _isAssigned(lib_macdl_TF2_aboveFalling, "AND") + _isAssigned(lib_macdl_TF2_belowFalling, "AND") + _isAssigned(lib_macdl_TF2_belowRising, "AND")
    and_total += _isAssigned(lib_macdl_TF3_aboveRising, "AND") + _isAssigned(lib_macdl_TF3_aboveFalling, "AND") + _isAssigned(lib_macdl_TF3_belowFalling, "AND") + _isAssigned(lib_macdl_TF3_belowRising, "AND")
    and_total += _isAssigned(lib_macdl_TF4_aboveRising, "AND") + _isAssigned(lib_macdl_TF4_aboveFalling, "AND") + _isAssigned(lib_macdl_TF4_belowFalling, "AND") + _isAssigned(lib_macdl_TF4_belowRising, "AND")
    and_total += _isAssigned(lib_macdl_TF5_aboveRising, "AND") + _isAssigned(lib_macdl_TF5_aboveFalling, "AND") + _isAssigned(lib_macdl_TF5_belowFalling, "AND") + _isAssigned(lib_macdl_TF5_belowRising, "AND")
    and_total += _isAssigned(lib_macdl_TF6_aboveRising, "AND") + _isAssigned(lib_macdl_TF6_aboveFalling, "AND") + _isAssigned(lib_macdl_TF6_belowFalling, "AND") + _isAssigned(lib_macdl_TF6_belowRising, "AND")
    and_true += _chkCond(lib_macdl_TF1_aboveRising, "AND", lib_macdl_v2.condA_tf1) + _chkCond(lib_macdl_TF1_aboveFalling, "AND", lib_macdl_v2.condB_tf1) + _chkCond(lib_macdl_TF1_belowFalling, "AND", lib_macdl_v2.condC_tf1) + _chkCond(lib_macdl_TF1_belowRising, "AND", lib_macdl_v2.condD_tf1)
    and_true += _chkCond(lib_macdl_TF2_aboveRising, "AND", lib_macdl_v2.condA_tf2) + _chkCond(lib_macdl_TF2_aboveFalling, "AND", lib_macdl_v2.condB_tf2) + _chkCond(lib_macdl_TF2_belowFalling, "AND", lib_macdl_v2.condC_tf2) + _chkCond(lib_macdl_TF2_belowRising, "AND", lib_macdl_v2.condD_tf2)
    and_true += _chkCond(lib_macdl_TF3_aboveRising, "AND", lib_macdl_v2.condA_tf3) + _chkCond(lib_macdl_TF3_aboveFalling, "AND", lib_macdl_v2.condB_tf3) + _chkCond(lib_macdl_TF3_belowFalling, "AND", lib_macdl_v2.condC_tf3) + _chkCond(lib_macdl_TF3_belowRising, "AND", lib_macdl_v2.condD_tf3)
    and_true += _chkCond(lib_macdl_TF4_aboveRising, "AND", lib_macdl_v2.condA_tf4) + _chkCond(lib_macdl_TF4_aboveFalling, "AND", lib_macdl_v2.condB_tf4) + _chkCond(lib_macdl_TF4_belowFalling, "AND", lib_macdl_v2.condC_tf4) + _chkCond(lib_macdl_TF4_belowRising, "AND", lib_macdl_v2.condD_tf4)
    and_true += _chkCond(lib_macdl_TF5_aboveRising, "AND", lib_macdl_v2.condA_tf5) + _chkCond(lib_macdl_TF5_aboveFalling, "AND", lib_macdl_v2.condB_tf5) + _chkCond(lib_macdl_TF5_belowFalling, "AND", lib_macdl_v2.condC_tf5) + _chkCond(lib_macdl_TF5_belowRising, "AND", lib_macdl_v2.condD_tf5)
    and_true += _chkCond(lib_macdl_TF6_aboveRising, "AND", lib_macdl_v2.condA_tf6) + _chkCond(lib_macdl_TF6_aboveFalling, "AND", lib_macdl_v2.condB_tf6) + _chkCond(lib_macdl_TF6_belowFalling, "AND", lib_macdl_v2.condC_tf6) + _chkCond(lib_macdl_TF6_belowRising, "AND", lib_macdl_v2.condD_tf6)

// MACD Histogram AND conditions (condA=posRising, condB=posFalling, condC=negFalling, condD=negRising)
if lib_macdh_enabled
    and_total += _isAssigned(lib_macdh_TF1_posRising, "AND") + _isAssigned(lib_macdh_TF1_posFalling, "AND") + _isAssigned(lib_macdh_TF1_negFalling, "AND") + _isAssigned(lib_macdh_TF1_negRising, "AND")
    and_total += _isAssigned(lib_macdh_TF2_posRising, "AND") + _isAssigned(lib_macdh_TF2_posFalling, "AND") + _isAssigned(lib_macdh_TF2_negFalling, "AND") + _isAssigned(lib_macdh_TF2_negRising, "AND")
    and_total += _isAssigned(lib_macdh_TF3_posRising, "AND") + _isAssigned(lib_macdh_TF3_posFalling, "AND") + _isAssigned(lib_macdh_TF3_negFalling, "AND") + _isAssigned(lib_macdh_TF3_negRising, "AND")
    and_total += _isAssigned(lib_macdh_TF4_posRising, "AND") + _isAssigned(lib_macdh_TF4_posFalling, "AND") + _isAssigned(lib_macdh_TF4_negFalling, "AND") + _isAssigned(lib_macdh_TF4_negRising, "AND")
    and_total += _isAssigned(lib_macdh_TF5_posRising, "AND") + _isAssigned(lib_macdh_TF5_posFalling, "AND") + _isAssigned(lib_macdh_TF5_negFalling, "AND") + _isAssigned(lib_macdh_TF5_negRising, "AND")
    and_total += _isAssigned(lib_macdh_TF6_posRising, "AND") + _isAssigned(lib_macdh_TF6_posFalling, "AND") + _isAssigned(lib_macdh_TF6_negFalling, "AND") + _isAssigned(lib_macdh_TF6_negRising, "AND")
    and_true += _chkCond(lib_macdh_TF1_posRising, "AND", lib_macdh_v2.condA_tf1) + _chkCond(lib_macdh_TF1_posFalling, "AND", lib_macdh_v2.condB_tf1) + _chkCond(lib_macdh_TF1_negFalling, "AND", lib_macdh_v2.condC_tf1) + _chkCond(lib_macdh_TF1_negRising, "AND", lib_macdh_v2.condD_tf1)
    and_true += _chkCond(lib_macdh_TF2_posRising, "AND", lib_macdh_v2.condA_tf2) + _chkCond(lib_macdh_TF2_posFalling, "AND", lib_macdh_v2.condB_tf2) + _chkCond(lib_macdh_TF2_negFalling, "AND", lib_macdh_v2.condC_tf2) + _chkCond(lib_macdh_TF2_negRising, "AND", lib_macdh_v2.condD_tf2)
    and_true += _chkCond(lib_macdh_TF3_posRising, "AND", lib_macdh_v2.condA_tf3) + _chkCond(lib_macdh_TF3_posFalling, "AND", lib_macdh_v2.condB_tf3) + _chkCond(lib_macdh_TF3_negFalling, "AND", lib_macdh_v2.condC_tf3) + _chkCond(lib_macdh_TF3_negRising, "AND", lib_macdh_v2.condD_tf3)
    and_true += _chkCond(lib_macdh_TF4_posRising, "AND", lib_macdh_v2.condA_tf4) + _chkCond(lib_macdh_TF4_posFalling, "AND", lib_macdh_v2.condB_tf4) + _chkCond(lib_macdh_TF4_negFalling, "AND", lib_macdh_v2.condC_tf4) + _chkCond(lib_macdh_TF4_negRising, "AND", lib_macdh_v2.condD_tf4)
    and_true += _chkCond(lib_macdh_TF5_posRising, "AND", lib_macdh_v2.condA_tf5) + _chkCond(lib_macdh_TF5_posFalling, "AND", lib_macdh_v2.condB_tf5) + _chkCond(lib_macdh_TF5_negFalling, "AND", lib_macdh_v2.condC_tf5) + _chkCond(lib_macdh_TF5_negRising, "AND", lib_macdh_v2.condD_tf5)
    and_true += _chkCond(lib_macdh_TF6_posRising, "AND", lib_macdh_v2.condA_tf6) + _chkCond(lib_macdh_TF6_posFalling, "AND", lib_macdh_v2.condB_tf6) + _chkCond(lib_macdh_TF6_negFalling, "AND", lib_macdh_v2.condC_tf6) + _chkCond(lib_macdh_TF6_negRising, "AND", lib_macdh_v2.condD_tf6)

// Simple MACD AND conditions (condA=aboveCrossUp, condB=aboveCrossDown, condC=belowCrossDown, condD=belowCrossUp)
if lib_macds_enabled
    and_total += _isAssigned(lib_macds_TF1_aboveCrossUp, "AND") + _isAssigned(lib_macds_TF1_aboveCrossDown, "AND") + _isAssigned(lib_macds_TF1_belowCrossDown, "AND") + _isAssigned(lib_macds_TF1_belowCrossUp, "AND")
    and_total += _isAssigned(lib_macds_TF2_aboveCrossUp, "AND") + _isAssigned(lib_macds_TF2_aboveCrossDown, "AND") + _isAssigned(lib_macds_TF2_belowCrossDown, "AND") + _isAssigned(lib_macds_TF2_belowCrossUp, "AND")
    and_total += _isAssigned(lib_macds_TF3_aboveCrossUp, "AND") + _isAssigned(lib_macds_TF3_aboveCrossDown, "AND") + _isAssigned(lib_macds_TF3_belowCrossDown, "AND") + _isAssigned(lib_macds_TF3_belowCrossUp, "AND")
    and_total += _isAssigned(lib_macds_TF4_aboveCrossUp, "AND") + _isAssigned(lib_macds_TF4_aboveCrossDown, "AND") + _isAssigned(lib_macds_TF4_belowCrossDown, "AND") + _isAssigned(lib_macds_TF4_belowCrossUp, "AND")
    and_total += _isAssigned(lib_macds_TF5_aboveCrossUp, "AND") + _isAssigned(lib_macds_TF5_aboveCrossDown, "AND") + _isAssigned(lib_macds_TF5_belowCrossDown, "AND") + _isAssigned(lib_macds_TF5_belowCrossUp, "AND")
    and_total += _isAssigned(lib_macds_TF6_aboveCrossUp, "AND") + _isAssigned(lib_macds_TF6_aboveCrossDown, "AND") + _isAssigned(lib_macds_TF6_belowCrossDown, "AND") + _isAssigned(lib_macds_TF6_belowCrossUp, "AND")
    and_true += _chkCond(lib_macds_TF1_aboveCrossUp, "AND", lib_macds_v2.condA_tf1) + _chkCond(lib_macds_TF1_aboveCrossDown, "AND", lib_macds_v2.condB_tf1) + _chkCond(lib_macds_TF1_belowCrossDown, "AND", lib_macds_v2.condC_tf1) + _chkCond(lib_macds_TF1_belowCrossUp, "AND", lib_macds_v2.condD_tf1)
    and_true += _chkCond(lib_macds_TF2_aboveCrossUp, "AND", lib_macds_v2.condA_tf2) + _chkCond(lib_macds_TF2_aboveCrossDown, "AND", lib_macds_v2.condB_tf2) + _chkCond(lib_macds_TF2_belowCrossDown, "AND", lib_macds_v2.condC_tf2) + _chkCond(lib_macds_TF2_belowCrossUp, "AND", lib_macds_v2.condD_tf2)
    and_true += _chkCond(lib_macds_TF3_aboveCrossUp, "AND", lib_macds_v2.condA_tf3) + _chkCond(lib_macds_TF3_aboveCrossDown, "AND", lib_macds_v2.condB_tf3) + _chkCond(lib_macds_TF3_belowCrossDown, "AND", lib_macds_v2.condC_tf3) + _chkCond(lib_macds_TF3_belowCrossUp, "AND", lib_macds_v2.condD_tf3)
    and_true += _chkCond(lib_macds_TF4_aboveCrossUp, "AND", lib_macds_v2.condA_tf4) + _chkCond(lib_macds_TF4_aboveCrossDown, "AND", lib_macds_v2.condB_tf4) + _chkCond(lib_macds_TF4_belowCrossDown, "AND", lib_macds_v2.condC_tf4) + _chkCond(lib_macds_TF4_belowCrossUp, "AND", lib_macds_v2.condD_tf4)
    and_true += _chkCond(lib_macds_TF5_aboveCrossUp, "AND", lib_macds_v2.condA_tf5) + _chkCond(lib_macds_TF5_aboveCrossDown, "AND", lib_macds_v2.condB_tf5) + _chkCond(lib_macds_TF5_belowCrossDown, "AND", lib_macds_v2.condC_tf5) + _chkCond(lib_macds_TF5_belowCrossUp, "AND", lib_macds_v2.condD_tf5)
    and_true += _chkCond(lib_macds_TF6_aboveCrossUp, "AND", lib_macds_v2.condA_tf6) + _chkCond(lib_macds_TF6_aboveCrossDown, "AND", lib_macds_v2.condB_tf6) + _chkCond(lib_macds_TF6_belowCrossDown, "AND", lib_macds_v2.condC_tf6) + _chkCond(lib_macds_TF6_belowCrossUp, "AND", lib_macds_v2.condD_tf6)

// VWAP AND conditions (Daily, Weekly, Monthly sigma zones)
if lib_vwap_enabled
    // Daily VWAP (7 sigma zones)
    and_total += _isAssigned(lib_vwap_D_above2s, "AND") + _isAssigned(lib_vwap_D_1to2s, "AND") + _isAssigned(lib_vwap_D_0to1s, "AND") + _isAssigned(lib_vwap_D_atV, "AND") + _isAssigned(lib_vwap_D_n1to0, "AND") + _isAssigned(lib_vwap_D_n2ton1, "AND") + _isAssigned(lib_vwap_D_below2s, "AND")
    and_true += _chkCond(lib_vwap_D_above2s, "AND", vwap_D_above2s) + _chkCond(lib_vwap_D_1to2s, "AND", vwap_D_1to2s) + _chkCond(lib_vwap_D_0to1s, "AND", vwap_D_0to1s) + _chkCond(lib_vwap_D_atV, "AND", vwap_D_atV) + _chkCond(lib_vwap_D_n1to0, "AND", vwap_D_n1to0) + _chkCond(lib_vwap_D_n2ton1, "AND", vwap_D_n2ton1) + _chkCond(lib_vwap_D_below2s, "AND", vwap_D_below2s)
    // Weekly VWAP
    and_total += _isAssigned(lib_vwap_W_above2s, "AND") + _isAssigned(lib_vwap_W_1to2s, "AND") + _isAssigned(lib_vwap_W_0to1s, "AND") + _isAssigned(lib_vwap_W_atV, "AND") + _isAssigned(lib_vwap_W_n1to0, "AND") + _isAssigned(lib_vwap_W_n2ton1, "AND") + _isAssigned(lib_vwap_W_below2s, "AND")
    and_true += _chkCond(lib_vwap_W_above2s, "AND", vwap_W_above2s) + _chkCond(lib_vwap_W_1to2s, "AND", vwap_W_1to2s) + _chkCond(lib_vwap_W_0to1s, "AND", vwap_W_0to1s) + _chkCond(lib_vwap_W_atV, "AND", vwap_W_atV) + _chkCond(lib_vwap_W_n1to0, "AND", vwap_W_n1to0) + _chkCond(lib_vwap_W_n2ton1, "AND", vwap_W_n2ton1) + _chkCond(lib_vwap_W_below2s, "AND", vwap_W_below2s)
    // Monthly VWAP
    and_total += _isAssigned(lib_vwap_M_above2s, "AND") + _isAssigned(lib_vwap_M_1to2s, "AND") + _isAssigned(lib_vwap_M_0to1s, "AND") + _isAssigned(lib_vwap_M_atV, "AND") + _isAssigned(lib_vwap_M_n1to0, "AND") + _isAssigned(lib_vwap_M_n2ton1, "AND") + _isAssigned(lib_vwap_M_below2s, "AND")
    and_true += _chkCond(lib_vwap_M_above2s, "AND", vwap_M_above2s) + _chkCond(lib_vwap_M_1to2s, "AND", vwap_M_1to2s) + _chkCond(lib_vwap_M_0to1s, "AND", vwap_M_0to1s) + _chkCond(lib_vwap_M_atV, "AND", vwap_M_atV) + _chkCond(lib_vwap_M_n1to0, "AND", vwap_M_n1to0) + _chkCond(lib_vwap_M_n2ton1, "AND", vwap_M_n2ton1) + _chkCond(lib_vwap_M_below2s, "AND", vwap_M_below2s)


//──────────────────────────────────────────────────────────────────────────────
// 9-2. COUNT OR1 GROUP CONDITIONS (abbreviated - same pattern as AND)
//──────────────────────────────────────────────────────────────────────────────

int or1_total = 0
int or1_true = 0

// EMA Stack OR1
if lib_ema_enabled
    or1_total += _isAssigned(lib_ema_TF1_SML, "OR1") + _isAssigned(lib_ema_TF1_LMS, "OR1") + _isAssigned(lib_ema_TF1_SLM, "OR1") + _isAssigned(lib_ema_TF1_MSL, "OR1") + _isAssigned(lib_ema_TF1_MLS, "OR1") + _isAssigned(lib_ema_TF1_LSM, "OR1") + _isAssigned(lib_ema_TF2_SML, "OR1") + _isAssigned(lib_ema_TF2_LMS, "OR1") + _isAssigned(lib_ema_TF2_SLM, "OR1") + _isAssigned(lib_ema_TF2_MSL, "OR1") + _isAssigned(lib_ema_TF2_MLS, "OR1") + _isAssigned(lib_ema_TF2_LSM, "OR1") + _isAssigned(lib_ema_TF3_SML, "OR1") + _isAssigned(lib_ema_TF3_LMS, "OR1") + _isAssigned(lib_ema_TF3_SLM, "OR1") + _isAssigned(lib_ema_TF3_MSL, "OR1") + _isAssigned(lib_ema_TF3_MLS, "OR1") + _isAssigned(lib_ema_TF3_LSM, "OR1") + _isAssigned(lib_ema_TF4_SML, "OR1") + _isAssigned(lib_ema_TF4_LMS, "OR1") + _isAssigned(lib_ema_TF4_SLM, "OR1") + _isAssigned(lib_ema_TF4_MSL, "OR1") + _isAssigned(lib_ema_TF4_MLS, "OR1") + _isAssigned(lib_ema_TF4_LSM, "OR1") + _isAssigned(lib_ema_TF5_SML, "OR1") + _isAssigned(lib_ema_TF5_LMS, "OR1") + _isAssigned(lib_ema_TF5_SLM, "OR1") + _isAssigned(lib_ema_TF5_MSL, "OR1") + _isAssigned(lib_ema_TF5_MLS, "OR1") + _isAssigned(lib_ema_TF5_LSM, "OR1") + _isAssigned(lib_ema_TF6_SML, "OR1") + _isAssigned(lib_ema_TF6_LMS, "OR1") + _isAssigned(lib_ema_TF6_SLM, "OR1") + _isAssigned(lib_ema_TF6_MSL, "OR1") + _isAssigned(lib_ema_TF6_MLS, "OR1") + _isAssigned(lib_ema_TF6_LSM, "OR1")
    or1_true += _chkCond(lib_ema_TF1_SML, "OR1", lib_ema_v2.condA_tf1) + _chkCond(lib_ema_TF1_LMS, "OR1", lib_ema_v2.condB_tf1) + _chkCond(lib_ema_TF1_SLM, "OR1", lib_ema_v2.condC_tf1) + _chkCond(lib_ema_TF1_MSL, "OR1", lib_ema_v2.condD_tf1) + _chkCond(lib_ema_TF1_MLS, "OR1", lib_ema_v2.condE_tf1) + _chkCond(lib_ema_TF1_LSM, "OR1", lib_ema_v2.condF_tf1) + _chkCond(lib_ema_TF2_SML, "OR1", lib_ema_v2.condA_tf2) + _chkCond(lib_ema_TF2_LMS, "OR1", lib_ema_v2.condB_tf2) + _chkCond(lib_ema_TF2_SLM, "OR1", lib_ema_v2.condC_tf2) + _chkCond(lib_ema_TF2_MSL, "OR1", lib_ema_v2.condD_tf2) + _chkCond(lib_ema_TF2_MLS, "OR1", lib_ema_v2.condE_tf2) + _chkCond(lib_ema_TF2_LSM, "OR1", lib_ema_v2.condF_tf2) + _chkCond(lib_ema_TF3_SML, "OR1", lib_ema_v2.condA_tf3) + _chkCond(lib_ema_TF3_LMS, "OR1", lib_ema_v2.condB_tf3) + _chkCond(lib_ema_TF3_SLM, "OR1", lib_ema_v2.condC_tf3) + _chkCond(lib_ema_TF3_MSL, "OR1", lib_ema_v2.condD_tf3) + _chkCond(lib_ema_TF3_MLS, "OR1", lib_ema_v2.condE_tf3) + _chkCond(lib_ema_TF3_LSM, "OR1", lib_ema_v2.condF_tf3) + _chkCond(lib_ema_TF4_SML, "OR1", lib_ema_v2.condA_tf4) + _chkCond(lib_ema_TF4_LMS, "OR1", lib_ema_v2.condB_tf4) + _chkCond(lib_ema_TF4_SLM, "OR1", lib_ema_v2.condC_tf4) + _chkCond(lib_ema_TF4_MSL, "OR1", lib_ema_v2.condD_tf4) + _chkCond(lib_ema_TF4_MLS, "OR1", lib_ema_v2.condE_tf4) + _chkCond(lib_ema_TF4_LSM, "OR1", lib_ema_v2.condF_tf4) + _chkCond(lib_ema_TF5_SML, "OR1", lib_ema_v2.condA_tf5) + _chkCond(lib_ema_TF5_LMS, "OR1", lib_ema_v2.condB_tf5) + _chkCond(lib_ema_TF5_SLM, "OR1", lib_ema_v2.condC_tf5) + _chkCond(lib_ema_TF5_MSL, "OR1", lib_ema_v2.condD_tf5) + _chkCond(lib_ema_TF5_MLS, "OR1", lib_ema_v2.condE_tf5) + _chkCond(lib_ema_TF5_LSM, "OR1", lib_ema_v2.condF_tf5) + _chkCond(lib_ema_TF6_SML, "OR1", lib_ema_v2.condA_tf6) + _chkCond(lib_ema_TF6_LMS, "OR1", lib_ema_v2.condB_tf6) + _chkCond(lib_ema_TF6_SLM, "OR1", lib_ema_v2.condC_tf6) + _chkCond(lib_ema_TF6_MSL, "OR1", lib_ema_v2.condD_tf6) + _chkCond(lib_ema_TF6_MLS, "OR1", lib_ema_v2.condE_tf6) + _chkCond(lib_ema_TF6_LSM, "OR1", lib_ema_v2.condF_tf6)

// Other libraries OR1 (RVOL, UT Bot, Swing, MACD variants, VWAP) - same pattern
if lib_rvol_enabled
    or1_total += _isAssigned(lib_rvol_TF1_extreme, "OR1") + _isAssigned(lib_rvol_TF1_veryHigh, "OR1") + _isAssigned(lib_rvol_TF1_elevated, "OR1") + _isAssigned(lib_rvol_TF1_normal, "OR1") + _isAssigned(lib_rvol_TF1_low, "OR1") + _isAssigned(lib_rvol_TF2_extreme, "OR1") + _isAssigned(lib_rvol_TF2_veryHigh, "OR1") + _isAssigned(lib_rvol_TF2_elevated, "OR1") + _isAssigned(lib_rvol_TF2_normal, "OR1") + _isAssigned(lib_rvol_TF2_low, "OR1") + _isAssigned(lib_rvol_TF3_extreme, "OR1") + _isAssigned(lib_rvol_TF3_veryHigh, "OR1") + _isAssigned(lib_rvol_TF3_elevated, "OR1") + _isAssigned(lib_rvol_TF3_normal, "OR1") + _isAssigned(lib_rvol_TF3_low, "OR1") + _isAssigned(lib_rvol_TF4_extreme, "OR1") + _isAssigned(lib_rvol_TF4_veryHigh, "OR1") + _isAssigned(lib_rvol_TF4_elevated, "OR1") + _isAssigned(lib_rvol_TF4_normal, "OR1") + _isAssigned(lib_rvol_TF4_low, "OR1") + _isAssigned(lib_rvol_TF5_extreme, "OR1") + _isAssigned(lib_rvol_TF5_veryHigh, "OR1") + _isAssigned(lib_rvol_TF5_elevated, "OR1") + _isAssigned(lib_rvol_TF5_normal, "OR1") + _isAssigned(lib_rvol_TF5_low, "OR1") + _isAssigned(lib_rvol_TF6_extreme, "OR1") + _isAssigned(lib_rvol_TF6_veryHigh, "OR1") + _isAssigned(lib_rvol_TF6_elevated, "OR1") + _isAssigned(lib_rvol_TF6_normal, "OR1") + _isAssigned(lib_rvol_TF6_low, "OR1")
    or1_true += _chkCond(lib_rvol_TF1_extreme, "OR1", lib_rvol_v2.condA_tf1) + _chkCond(lib_rvol_TF1_veryHigh, "OR1", lib_rvol_v2.condB_tf1) + _chkCond(lib_rvol_TF1_elevated, "OR1", lib_rvol_v2.condC_tf1) + _chkCond(lib_rvol_TF1_normal, "OR1", lib_rvol_v2.condD_tf1) + _chkCond(lib_rvol_TF1_low, "OR1", lib_rvol_v2.condE_tf1) + _chkCond(lib_rvol_TF2_extreme, "OR1", lib_rvol_v2.condA_tf2) + _chkCond(lib_rvol_TF2_veryHigh, "OR1", lib_rvol_v2.condB_tf2) + _chkCond(lib_rvol_TF2_elevated, "OR1", lib_rvol_v2.condC_tf2) + _chkCond(lib_rvol_TF2_normal, "OR1", lib_rvol_v2.condD_tf2) + _chkCond(lib_rvol_TF2_low, "OR1", lib_rvol_v2.condE_tf2) + _chkCond(lib_rvol_TF3_extreme, "OR1", lib_rvol_v2.condA_tf3) + _chkCond(lib_rvol_TF3_veryHigh, "OR1", lib_rvol_v2.condB_tf3) + _chkCond(lib_rvol_TF3_elevated, "OR1", lib_rvol_v2.condC_tf3) + _chkCond(lib_rvol_TF3_normal, "OR1", lib_rvol_v2.condD_tf3) + _chkCond(lib_rvol_TF3_low, "OR1", lib_rvol_v2.condE_tf3) + _chkCond(lib_rvol_TF4_extreme, "OR1", lib_rvol_v2.condA_tf4) + _chkCond(lib_rvol_TF4_veryHigh, "OR1", lib_rvol_v2.condB_tf4) + _chkCond(lib_rvol_TF4_elevated, "OR1", lib_rvol_v2.condC_tf4) + _chkCond(lib_rvol_TF4_normal, "OR1", lib_rvol_v2.condD_tf4) + _chkCond(lib_rvol_TF4_low, "OR1", lib_rvol_v2.condE_tf4) + _chkCond(lib_rvol_TF5_extreme, "OR1", lib_rvol_v2.condA_tf5) + _chkCond(lib_rvol_TF5_veryHigh, "OR1", lib_rvol_v2.condB_tf5) + _chkCond(lib_rvol_TF5_elevated, "OR1", lib_rvol_v2.condC_tf5) + _chkCond(lib_rvol_TF5_normal, "OR1", lib_rvol_v2.condD_tf5) + _chkCond(lib_rvol_TF5_low, "OR1", lib_rvol_v2.condE_tf5) + _chkCond(lib_rvol_TF6_extreme, "OR1", lib_rvol_v2.condA_tf6) + _chkCond(lib_rvol_TF6_veryHigh, "OR1", lib_rvol_v2.condB_tf6) + _chkCond(lib_rvol_TF6_elevated, "OR1", lib_rvol_v2.condC_tf6) + _chkCond(lib_rvol_TF6_normal, "OR1", lib_rvol_v2.condD_tf6) + _chkCond(lib_rvol_TF6_low, "OR1", lib_rvol_v2.condE_tf6)

if lib_utbot_enabled
    or1_total += _isAssigned(lib_utbot_TF1_bull, "OR1") + _isAssigned(lib_utbot_TF1_bear, "OR1") + _isAssigned(lib_utbot_TF2_bull, "OR1") + _isAssigned(lib_utbot_TF2_bear, "OR1") + _isAssigned(lib_utbot_TF3_bull, "OR1") + _isAssigned(lib_utbot_TF3_bear, "OR1") + _isAssigned(lib_utbot_TF4_bull, "OR1") + _isAssigned(lib_utbot_TF4_bear, "OR1") + _isAssigned(lib_utbot_TF5_bull, "OR1") + _isAssigned(lib_utbot_TF5_bear, "OR1") + _isAssigned(lib_utbot_TF6_bull, "OR1") + _isAssigned(lib_utbot_TF6_bear, "OR1")
    or1_true += _chkCond(lib_utbot_TF1_bull, "OR1", lib_utbot_v2.condA_tf1) + _chkCond(lib_utbot_TF1_bear, "OR1", lib_utbot_v2.condB_tf1) + _chkCond(lib_utbot_TF2_bull, "OR1", lib_utbot_v2.condA_tf2) + _chkCond(lib_utbot_TF2_bear, "OR1", lib_utbot_v2.condB_tf2) + _chkCond(lib_utbot_TF3_bull, "OR1", lib_utbot_v2.condA_tf3) + _chkCond(lib_utbot_TF3_bear, "OR1", lib_utbot_v2.condB_tf3) + _chkCond(lib_utbot_TF4_bull, "OR1", lib_utbot_v2.condA_tf4) + _chkCond(lib_utbot_TF4_bear, "OR1", lib_utbot_v2.condB_tf4) + _chkCond(lib_utbot_TF5_bull, "OR1", lib_utbot_v2.condA_tf5) + _chkCond(lib_utbot_TF5_bear, "OR1", lib_utbot_v2.condB_tf5) + _chkCond(lib_utbot_TF6_bull, "OR1", lib_utbot_v2.condA_tf6) + _chkCond(lib_utbot_TF6_bear, "OR1", lib_utbot_v2.condB_tf6)

if lib_swing_enabled
    or1_total += _isAssigned(lib_swing_TF1_BC2, "OR1") + _isAssigned(lib_swing_TF1_BC3, "OR1") + _isAssigned(lib_swing_TF1_XC2, "OR1") + _isAssigned(lib_swing_TF1_XC3, "OR1") + _isAssigned(lib_swing_TF1_Bup, "OR1") + _isAssigned(lib_swing_TF1_Xdn, "OR1") + _isAssigned(lib_swing_TF2_BC2, "OR1") + _isAssigned(lib_swing_TF2_BC3, "OR1") + _isAssigned(lib_swing_TF2_XC2, "OR1") + _isAssigned(lib_swing_TF2_XC3, "OR1") + _isAssigned(lib_swing_TF2_Bup, "OR1") + _isAssigned(lib_swing_TF2_Xdn, "OR1") + _isAssigned(lib_swing_TF3_BC2, "OR1") + _isAssigned(lib_swing_TF3_BC3, "OR1") + _isAssigned(lib_swing_TF3_XC2, "OR1") + _isAssigned(lib_swing_TF3_XC3, "OR1") + _isAssigned(lib_swing_TF3_Bup, "OR1") + _isAssigned(lib_swing_TF3_Xdn, "OR1") + _isAssigned(lib_swing_TF4_BC2, "OR1") + _isAssigned(lib_swing_TF4_BC3, "OR1") + _isAssigned(lib_swing_TF4_XC2, "OR1") + _isAssigned(lib_swing_TF4_XC3, "OR1") + _isAssigned(lib_swing_TF4_Bup, "OR1") + _isAssigned(lib_swing_TF4_Xdn, "OR1") + _isAssigned(lib_swing_TF5_BC2, "OR1") + _isAssigned(lib_swing_TF5_BC3, "OR1") + _isAssigned(lib_swing_TF5_XC2, "OR1") + _isAssigned(lib_swing_TF5_XC3, "OR1") + _isAssigned(lib_swing_TF5_Bup, "OR1") + _isAssigned(lib_swing_TF5_Xdn, "OR1") + _isAssigned(lib_swing_TF6_BC2, "OR1") + _isAssigned(lib_swing_TF6_BC3, "OR1") + _isAssigned(lib_swing_TF6_XC2, "OR1") + _isAssigned(lib_swing_TF6_XC3, "OR1") + _isAssigned(lib_swing_TF6_Bup, "OR1") + _isAssigned(lib_swing_TF6_Xdn, "OR1")
    or1_true += _chkCond(lib_swing_TF1_BC2, "OR1", lib_swing_v2.condA_tf1) + _chkCond(lib_swing_TF1_BC3, "OR1", lib_swing_v2.condB_tf1) + _chkCond(lib_swing_TF1_XC2, "OR1", lib_swing_v2.condC_tf1) + _chkCond(lib_swing_TF1_XC3, "OR1", lib_swing_v2.condD_tf1) + _chkCond(lib_swing_TF1_Bup, "OR1", lib_swing_v2.condE_tf1) + _chkCond(lib_swing_TF1_Xdn, "OR1", lib_swing_v2.condF_tf1) + _chkCond(lib_swing_TF2_BC2, "OR1", lib_swing_v2.condA_tf2) + _chkCond(lib_swing_TF2_BC3, "OR1", lib_swing_v2.condB_tf2) + _chkCond(lib_swing_TF2_XC2, "OR1", lib_swing_v2.condC_tf2) + _chkCond(lib_swing_TF2_XC3, "OR1", lib_swing_v2.condD_tf2) + _chkCond(lib_swing_TF2_Bup, "OR1", lib_swing_v2.condE_tf2) + _chkCond(lib_swing_TF2_Xdn, "OR1", lib_swing_v2.condF_tf2) + _chkCond(lib_swing_TF3_BC2, "OR1", lib_swing_v2.condA_tf3) + _chkCond(lib_swing_TF3_BC3, "OR1", lib_swing_v2.condB_tf3) + _chkCond(lib_swing_TF3_XC2, "OR1", lib_swing_v2.condC_tf3) + _chkCond(lib_swing_TF3_XC3, "OR1", lib_swing_v2.condD_tf3) + _chkCond(lib_swing_TF3_Bup, "OR1", lib_swing_v2.condE_tf3) + _chkCond(lib_swing_TF3_Xdn, "OR1", lib_swing_v2.condF_tf3) + _chkCond(lib_swing_TF4_BC2, "OR1", lib_swing_v2.condA_tf4) + _chkCond(lib_swing_TF4_BC3, "OR1", lib_swing_v2.condB_tf4) + _chkCond(lib_swing_TF4_XC2, "OR1", lib_swing_v2.condC_tf4) + _chkCond(lib_swing_TF4_XC3, "OR1", lib_swing_v2.condD_tf4) + _chkCond(lib_swing_TF4_Bup, "OR1", lib_swing_v2.condE_tf4) + _chkCond(lib_swing_TF4_Xdn, "OR1", lib_swing_v2.condF_tf4) + _chkCond(lib_swing_TF5_BC2, "OR1", lib_swing_v2.condA_tf5) + _chkCond(lib_swing_TF5_BC3, "OR1", lib_swing_v2.condB_tf5) + _chkCond(lib_swing_TF5_XC2, "OR1", lib_swing_v2.condC_tf5) + _chkCond(lib_swing_TF5_XC3, "OR1", lib_swing_v2.condD_tf5) + _chkCond(lib_swing_TF5_Bup, "OR1", lib_swing_v2.condE_tf5) + _chkCond(lib_swing_TF5_Xdn, "OR1", lib_swing_v2.condF_tf5) + _chkCond(lib_swing_TF6_BC2, "OR1", lib_swing_v2.condA_tf6) + _chkCond(lib_swing_TF6_BC3, "OR1", lib_swing_v2.condB_tf6) + _chkCond(lib_swing_TF6_XC2, "OR1", lib_swing_v2.condC_tf6) + _chkCond(lib_swing_TF6_XC3, "OR1", lib_swing_v2.condD_tf6) + _chkCond(lib_swing_TF6_Bup, "OR1", lib_swing_v2.condE_tf6) + _chkCond(lib_swing_TF6_Xdn, "OR1", lib_swing_v2.condF_tf6)

if lib_macdl_enabled
    or1_total += _isAssigned(lib_macdl_TF1_aboveRising, "OR1") + _isAssigned(lib_macdl_TF1_aboveFalling, "OR1") + _isAssigned(lib_macdl_TF1_belowFalling, "OR1") + _isAssigned(lib_macdl_TF1_belowRising, "OR1") + _isAssigned(lib_macdl_TF2_aboveRising, "OR1") + _isAssigned(lib_macdl_TF2_aboveFalling, "OR1") + _isAssigned(lib_macdl_TF2_belowFalling, "OR1") + _isAssigned(lib_macdl_TF2_belowRising, "OR1") + _isAssigned(lib_macdl_TF3_aboveRising, "OR1") + _isAssigned(lib_macdl_TF3_aboveFalling, "OR1") + _isAssigned(lib_macdl_TF3_belowFalling, "OR1") + _isAssigned(lib_macdl_TF3_belowRising, "OR1") + _isAssigned(lib_macdl_TF4_aboveRising, "OR1") + _isAssigned(lib_macdl_TF4_aboveFalling, "OR1") + _isAssigned(lib_macdl_TF4_belowFalling, "OR1") + _isAssigned(lib_macdl_TF4_belowRising, "OR1") + _isAssigned(lib_macdl_TF5_aboveRising, "OR1") + _isAssigned(lib_macdl_TF5_aboveFalling, "OR1") + _isAssigned(lib_macdl_TF5_belowFalling, "OR1") + _isAssigned(lib_macdl_TF5_belowRising, "OR1") + _isAssigned(lib_macdl_TF6_aboveRising, "OR1") + _isAssigned(lib_macdl_TF6_aboveFalling, "OR1") + _isAssigned(lib_macdl_TF6_belowFalling, "OR1") + _isAssigned(lib_macdl_TF6_belowRising, "OR1")
    or1_true += _chkCond(lib_macdl_TF1_aboveRising, "OR1", lib_macdl_v2.condA_tf1) + _chkCond(lib_macdl_TF1_aboveFalling, "OR1", lib_macdl_v2.condB_tf1) + _chkCond(lib_macdl_TF1_belowFalling, "OR1", lib_macdl_v2.condC_tf1) + _chkCond(lib_macdl_TF1_belowRising, "OR1", lib_macdl_v2.condD_tf1) + _chkCond(lib_macdl_TF2_aboveRising, "OR1", lib_macdl_v2.condA_tf2) + _chkCond(lib_macdl_TF2_aboveFalling, "OR1", lib_macdl_v2.condB_tf2) + _chkCond(lib_macdl_TF2_belowFalling, "OR1", lib_macdl_v2.condC_tf2) + _chkCond(lib_macdl_TF2_belowRising, "OR1", lib_macdl_v2.condD_tf2) + _chkCond(lib_macdl_TF3_aboveRising, "OR1", lib_macdl_v2.condA_tf3) + _chkCond(lib_macdl_TF3_aboveFalling, "OR1", lib_macdl_v2.condB_tf3) + _chkCond(lib_macdl_TF3_belowFalling, "OR1", lib_macdl_v2.condC_tf3) + _chkCond(lib_macdl_TF3_belowRising, "OR1", lib_macdl_v2.condD_tf3) + _chkCond(lib_macdl_TF4_aboveRising, "OR1", lib_macdl_v2.condA_tf4) + _chkCond(lib_macdl_TF4_aboveFalling, "OR1", lib_macdl_v2.condB_tf4) + _chkCond(lib_macdl_TF4_belowFalling, "OR1", lib_macdl_v2.condC_tf4) + _chkCond(lib_macdl_TF4_belowRising, "OR1", lib_macdl_v2.condD_tf4) + _chkCond(lib_macdl_TF5_aboveRising, "OR1", lib_macdl_v2.condA_tf5) + _chkCond(lib_macdl_TF5_aboveFalling, "OR1", lib_macdl_v2.condB_tf5) + _chkCond(lib_macdl_TF5_belowFalling, "OR1", lib_macdl_v2.condC_tf5) + _chkCond(lib_macdl_TF5_belowRising, "OR1", lib_macdl_v2.condD_tf5) + _chkCond(lib_macdl_TF6_aboveRising, "OR1", lib_macdl_v2.condA_tf6) + _chkCond(lib_macdl_TF6_aboveFalling, "OR1", lib_macdl_v2.condB_tf6) + _chkCond(lib_macdl_TF6_belowFalling, "OR1", lib_macdl_v2.condC_tf6) + _chkCond(lib_macdl_TF6_belowRising, "OR1", lib_macdl_v2.condD_tf6)

if lib_macdh_enabled
    or1_total += _isAssigned(lib_macdh_TF1_posRising, "OR1") + _isAssigned(lib_macdh_TF1_posFalling, "OR1") + _isAssigned(lib_macdh_TF1_negFalling, "OR1") + _isAssigned(lib_macdh_TF1_negRising, "OR1") + _isAssigned(lib_macdh_TF2_posRising, "OR1") + _isAssigned(lib_macdh_TF2_posFalling, "OR1") + _isAssigned(lib_macdh_TF2_negFalling, "OR1") + _isAssigned(lib_macdh_TF2_negRising, "OR1") + _isAssigned(lib_macdh_TF3_posRising, "OR1") + _isAssigned(lib_macdh_TF3_posFalling, "OR1") + _isAssigned(lib_macdh_TF3_negFalling, "OR1") + _isAssigned(lib_macdh_TF3_negRising, "OR1") + _isAssigned(lib_macdh_TF4_posRising, "OR1") + _isAssigned(lib_macdh_TF4_posFalling, "OR1") + _isAssigned(lib_macdh_TF4_negFalling, "OR1") + _isAssigned(lib_macdh_TF4_negRising, "OR1") + _isAssigned(lib_macdh_TF5_posRising, "OR1") + _isAssigned(lib_macdh_TF5_posFalling, "OR1") + _isAssigned(lib_macdh_TF5_negFalling, "OR1") + _isAssigned(lib_macdh_TF5_negRising, "OR1") + _isAssigned(lib_macdh_TF6_posRising, "OR1") + _isAssigned(lib_macdh_TF6_posFalling, "OR1") + _isAssigned(lib_macdh_TF6_negFalling, "OR1") + _isAssigned(lib_macdh_TF6_negRising, "OR1")
    or1_true += _chkCond(lib_macdh_TF1_posRising, "OR1", lib_macdh_v2.condA_tf1) + _chkCond(lib_macdh_TF1_posFalling, "OR1", lib_macdh_v2.condB_tf1) + _chkCond(lib_macdh_TF1_negFalling, "OR1", lib_macdh_v2.condC_tf1) + _chkCond(lib_macdh_TF1_negRising, "OR1", lib_macdh_v2.condD_tf1) + _chkCond(lib_macdh_TF2_posRising, "OR1", lib_macdh_v2.condA_tf2) + _chkCond(lib_macdh_TF2_posFalling, "OR1", lib_macdh_v2.condB_tf2) + _chkCond(lib_macdh_TF2_negFalling, "OR1", lib_macdh_v2.condC_tf2) + _chkCond(lib_macdh_TF2_negRising, "OR1", lib_macdh_v2.condD_tf2) + _chkCond(lib_macdh_TF3_posRising, "OR1", lib_macdh_v2.condA_tf3) + _chkCond(lib_macdh_TF3_posFalling, "OR1", lib_macdh_v2.condB_tf3) + _chkCond(lib_macdh_TF3_negFalling, "OR1", lib_macdh_v2.condC_tf3) + _chkCond(lib_macdh_TF3_negRising, "OR1", lib_macdh_v2.condD_tf3) + _chkCond(lib_macdh_TF4_posRising, "OR1", lib_macdh_v2.condA_tf4) + _chkCond(lib_macdh_TF4_posFalling, "OR1", lib_macdh_v2.condB_tf4) + _chkCond(lib_macdh_TF4_negFalling, "OR1", lib_macdh_v2.condC_tf4) + _chkCond(lib_macdh_TF4_negRising, "OR1", lib_macdh_v2.condD_tf4) + _chkCond(lib_macdh_TF5_posRising, "OR1", lib_macdh_v2.condA_tf5) + _chkCond(lib_macdh_TF5_posFalling, "OR1", lib_macdh_v2.condB_tf5) + _chkCond(lib_macdh_TF5_negFalling, "OR1", lib_macdh_v2.condC_tf5) + _chkCond(lib_macdh_TF5_negRising, "OR1", lib_macdh_v2.condD_tf5) + _chkCond(lib_macdh_TF6_posRising, "OR1", lib_macdh_v2.condA_tf6) + _chkCond(lib_macdh_TF6_posFalling, "OR1", lib_macdh_v2.condB_tf6) + _chkCond(lib_macdh_TF6_negFalling, "OR1", lib_macdh_v2.condC_tf6) + _chkCond(lib_macdh_TF6_negRising, "OR1", lib_macdh_v2.condD_tf6)

if lib_macds_enabled
    or1_total += _isAssigned(lib_macds_TF1_aboveCrossUp, "OR1") + _isAssigned(lib_macds_TF1_aboveCrossDown, "OR1") + _isAssigned(lib_macds_TF1_belowCrossDown, "OR1") + _isAssigned(lib_macds_TF1_belowCrossUp, "OR1") + _isAssigned(lib_macds_TF2_aboveCrossUp, "OR1") + _isAssigned(lib_macds_TF2_aboveCrossDown, "OR1") + _isAssigned(lib_macds_TF2_belowCrossDown, "OR1") + _isAssigned(lib_macds_TF2_belowCrossUp, "OR1") + _isAssigned(lib_macds_TF3_aboveCrossUp, "OR1") + _isAssigned(lib_macds_TF3_aboveCrossDown, "OR1") + _isAssigned(lib_macds_TF3_belowCrossDown, "OR1") + _isAssigned(lib_macds_TF3_belowCrossUp, "OR1") + _isAssigned(lib_macds_TF4_aboveCrossUp, "OR1") + _isAssigned(lib_macds_TF4_aboveCrossDown, "OR1") + _isAssigned(lib_macds_TF4_belowCrossDown, "OR1") + _isAssigned(lib_macds_TF4_belowCrossUp, "OR1") + _isAssigned(lib_macds_TF5_aboveCrossUp, "OR1") + _isAssigned(lib_macds_TF5_aboveCrossDown, "OR1") + _isAssigned(lib_macds_TF5_belowCrossDown, "OR1") + _isAssigned(lib_macds_TF5_belowCrossUp, "OR1") + _isAssigned(lib_macds_TF6_aboveCrossUp, "OR1") + _isAssigned(lib_macds_TF6_aboveCrossDown, "OR1") + _isAssigned(lib_macds_TF6_belowCrossDown, "OR1") + _isAssigned(lib_macds_TF6_belowCrossUp, "OR1")
    or1_true += _chkCond(lib_macds_TF1_aboveCrossUp, "OR1", lib_macds_v2.condA_tf1) + _chkCond(lib_macds_TF1_aboveCrossDown, "OR1", lib_macds_v2.condB_tf1) + _chkCond(lib_macds_TF1_belowCrossDown, "OR1", lib_macds_v2.condC_tf1) + _chkCond(lib_macds_TF1_belowCrossUp, "OR1", lib_macds_v2.condD_tf1) + _chkCond(lib_macds_TF2_aboveCrossUp, "OR1", lib_macds_v2.condA_tf2) + _chkCond(lib_macds_TF2_aboveCrossDown, "OR1", lib_macds_v2.condB_tf2) + _chkCond(lib_macds_TF2_belowCrossDown, "OR1", lib_macds_v2.condC_tf2) + _chkCond(lib_macds_TF2_belowCrossUp, "OR1", lib_macds_v2.condD_tf2) + _chkCond(lib_macds_TF3_aboveCrossUp, "OR1", lib_macds_v2.condA_tf3) + _chkCond(lib_macds_TF3_aboveCrossDown, "OR1", lib_macds_v2.condB_tf3) + _chkCond(lib_macds_TF3_belowCrossDown, "OR1", lib_macds_v2.condC_tf3) + _chkCond(lib_macds_TF3_belowCrossUp, "OR1", lib_macds_v2.condD_tf3) + _chkCond(lib_macds_TF4_aboveCrossUp, "OR1", lib_macds_v2.condA_tf4) + _chkCond(lib_macds_TF4_aboveCrossDown, "OR1", lib_macds_v2.condB_tf4) + _chkCond(lib_macds_TF4_belowCrossDown, "OR1", lib_macds_v2.condC_tf4) + _chkCond(lib_macds_TF4_belowCrossUp, "OR1", lib_macds_v2.condD_tf4) + _chkCond(lib_macds_TF5_aboveCrossUp, "OR1", lib_macds_v2.condA_tf5) + _chkCond(lib_macds_TF5_aboveCrossDown, "OR1", lib_macds_v2.condB_tf5) + _chkCond(lib_macds_TF5_belowCrossDown, "OR1", lib_macds_v2.condC_tf5) + _chkCond(lib_macds_TF5_belowCrossUp, "OR1", lib_macds_v2.condD_tf5) + _chkCond(lib_macds_TF6_aboveCrossUp, "OR1", lib_macds_v2.condA_tf6) + _chkCond(lib_macds_TF6_aboveCrossDown, "OR1", lib_macds_v2.condB_tf6) + _chkCond(lib_macds_TF6_belowCrossDown, "OR1", lib_macds_v2.condC_tf6) + _chkCond(lib_macds_TF6_belowCrossUp, "OR1", lib_macds_v2.condD_tf6)

if lib_vwap_enabled
    or1_total += _isAssigned(lib_vwap_D_above2s, "OR1") + _isAssigned(lib_vwap_D_1to2s, "OR1") + _isAssigned(lib_vwap_D_0to1s, "OR1") + _isAssigned(lib_vwap_D_atV, "OR1") + _isAssigned(lib_vwap_D_n1to0, "OR1") + _isAssigned(lib_vwap_D_n2ton1, "OR1") + _isAssigned(lib_vwap_D_below2s, "OR1") + _isAssigned(lib_vwap_W_above2s, "OR1") + _isAssigned(lib_vwap_W_1to2s, "OR1") + _isAssigned(lib_vwap_W_0to1s, "OR1") + _isAssigned(lib_vwap_W_atV, "OR1") + _isAssigned(lib_vwap_W_n1to0, "OR1") + _isAssigned(lib_vwap_W_n2ton1, "OR1") + _isAssigned(lib_vwap_W_below2s, "OR1") + _isAssigned(lib_vwap_M_above2s, "OR1") + _isAssigned(lib_vwap_M_1to2s, "OR1") + _isAssigned(lib_vwap_M_0to1s, "OR1") + _isAssigned(lib_vwap_M_atV, "OR1") + _isAssigned(lib_vwap_M_n1to0, "OR1") + _isAssigned(lib_vwap_M_n2ton1, "OR1") + _isAssigned(lib_vwap_M_below2s, "OR1")
    or1_true += _chkCond(lib_vwap_D_above2s, "OR1", vwap_D_above2s) + _chkCond(lib_vwap_D_1to2s, "OR1", vwap_D_1to2s) + _chkCond(lib_vwap_D_0to1s, "OR1", vwap_D_0to1s) + _chkCond(lib_vwap_D_atV, "OR1", vwap_D_atV) + _chkCond(lib_vwap_D_n1to0, "OR1", vwap_D_n1to0) + _chkCond(lib_vwap_D_n2ton1, "OR1", vwap_D_n2ton1) + _chkCond(lib_vwap_D_below2s, "OR1", vwap_D_below2s) + _chkCond(lib_vwap_W_above2s, "OR1", vwap_W_above2s) + _chkCond(lib_vwap_W_1to2s, "OR1", vwap_W_1to2s) + _chkCond(lib_vwap_W_0to1s, "OR1", vwap_W_0to1s) + _chkCond(lib_vwap_W_atV, "OR1", vwap_W_atV) + _chkCond(lib_vwap_W_n1to0, "OR1", vwap_W_n1to0) + _chkCond(lib_vwap_W_n2ton1, "OR1", vwap_W_n2ton1) + _chkCond(lib_vwap_W_below2s, "OR1", vwap_W_below2s) + _chkCond(lib_vwap_M_above2s, "OR1", vwap_M_above2s) + _chkCond(lib_vwap_M_1to2s, "OR1", vwap_M_1to2s) + _chkCond(lib_vwap_M_0to1s, "OR1", vwap_M_0to1s) + _chkCond(lib_vwap_M_atV, "OR1", vwap_M_atV) + _chkCond(lib_vwap_M_n1to0, "OR1", vwap_M_n1to0) + _chkCond(lib_vwap_M_n2ton1, "OR1", vwap_M_n2ton1) + _chkCond(lib_vwap_M_below2s, "OR1", vwap_M_below2s)


//──────────────────────────────────────────────────────────────────────────────
// 9-3. COUNT OR2/OR3 GROUPS (abbreviated for script size limit)
// Note: Full implementation deferred - VWAP only for now
//──────────────────────────────────────────────────────────────────────────────

int or2_total = 0, int or2_true = 0
int or3_total = 0, int or3_true = 0

// VWAP OR2/OR3 (sigma-based zones) - primary use case
if lib_vwap_enabled
    or2_total += _isAssigned(lib_vwap_D_above2s, "OR2") + _isAssigned(lib_vwap_D_1to2s, "OR2") + _isAssigned(lib_vwap_D_0to1s, "OR2") + _isAssigned(lib_vwap_D_atV, "OR2") + _isAssigned(lib_vwap_D_n1to0, "OR2") + _isAssigned(lib_vwap_D_n2ton1, "OR2") + _isAssigned(lib_vwap_D_below2s, "OR2") + _isAssigned(lib_vwap_W_above2s, "OR2") + _isAssigned(lib_vwap_W_1to2s, "OR2") + _isAssigned(lib_vwap_W_0to1s, "OR2") + _isAssigned(lib_vwap_W_atV, "OR2") + _isAssigned(lib_vwap_W_n1to0, "OR2") + _isAssigned(lib_vwap_W_n2ton1, "OR2") + _isAssigned(lib_vwap_W_below2s, "OR2") + _isAssigned(lib_vwap_M_above2s, "OR2") + _isAssigned(lib_vwap_M_1to2s, "OR2") + _isAssigned(lib_vwap_M_0to1s, "OR2") + _isAssigned(lib_vwap_M_atV, "OR2") + _isAssigned(lib_vwap_M_n1to0, "OR2") + _isAssigned(lib_vwap_M_n2ton1, "OR2") + _isAssigned(lib_vwap_M_below2s, "OR2")
    or2_true += _chkCond(lib_vwap_D_above2s, "OR2", vwap_D_above2s) + _chkCond(lib_vwap_D_1to2s, "OR2", vwap_D_1to2s) + _chkCond(lib_vwap_D_0to1s, "OR2", vwap_D_0to1s) + _chkCond(lib_vwap_D_atV, "OR2", vwap_D_atV) + _chkCond(lib_vwap_D_n1to0, "OR2", vwap_D_n1to0) + _chkCond(lib_vwap_D_n2ton1, "OR2", vwap_D_n2ton1) + _chkCond(lib_vwap_D_below2s, "OR2", vwap_D_below2s) + _chkCond(lib_vwap_W_above2s, "OR2", vwap_W_above2s) + _chkCond(lib_vwap_W_1to2s, "OR2", vwap_W_1to2s) + _chkCond(lib_vwap_W_0to1s, "OR2", vwap_W_0to1s) + _chkCond(lib_vwap_W_atV, "OR2", vwap_W_atV) + _chkCond(lib_vwap_W_n1to0, "OR2", vwap_W_n1to0) + _chkCond(lib_vwap_W_n2ton1, "OR2", vwap_W_n2ton1) + _chkCond(lib_vwap_W_below2s, "OR2", vwap_W_below2s) + _chkCond(lib_vwap_M_above2s, "OR2", vwap_M_above2s) + _chkCond(lib_vwap_M_1to2s, "OR2", vwap_M_1to2s) + _chkCond(lib_vwap_M_0to1s, "OR2", vwap_M_0to1s) + _chkCond(lib_vwap_M_atV, "OR2", vwap_M_atV) + _chkCond(lib_vwap_M_n1to0, "OR2", vwap_M_n1to0) + _chkCond(lib_vwap_M_n2ton1, "OR2", vwap_M_n2ton1) + _chkCond(lib_vwap_M_below2s, "OR2", vwap_M_below2s)
    or3_total += _isAssigned(lib_vwap_D_above2s, "OR3") + _isAssigned(lib_vwap_D_1to2s, "OR3") + _isAssigned(lib_vwap_D_0to1s, "OR3") + _isAssigned(lib_vwap_D_atV, "OR3") + _isAssigned(lib_vwap_D_n1to0, "OR3") + _isAssigned(lib_vwap_D_n2ton1, "OR3") + _isAssigned(lib_vwap_D_below2s, "OR3") + _isAssigned(lib_vwap_W_above2s, "OR3") + _isAssigned(lib_vwap_W_1to2s, "OR3") + _isAssigned(lib_vwap_W_0to1s, "OR3") + _isAssigned(lib_vwap_W_atV, "OR3") + _isAssigned(lib_vwap_W_n1to0, "OR3") + _isAssigned(lib_vwap_W_n2ton1, "OR3") + _isAssigned(lib_vwap_W_below2s, "OR3") + _isAssigned(lib_vwap_M_above2s, "OR3") + _isAssigned(lib_vwap_M_1to2s, "OR3") + _isAssigned(lib_vwap_M_0to1s, "OR3") + _isAssigned(lib_vwap_M_atV, "OR3") + _isAssigned(lib_vwap_M_n1to0, "OR3") + _isAssigned(lib_vwap_M_n2ton1, "OR3") + _isAssigned(lib_vwap_M_below2s, "OR3")
    or3_true += _chkCond(lib_vwap_D_above2s, "OR3", vwap_D_above2s) + _chkCond(lib_vwap_D_1to2s, "OR3", vwap_D_1to2s) + _chkCond(lib_vwap_D_0to1s, "OR3", vwap_D_0to1s) + _chkCond(lib_vwap_D_atV, "OR3", vwap_D_atV) + _chkCond(lib_vwap_D_n1to0, "OR3", vwap_D_n1to0) + _chkCond(lib_vwap_D_n2ton1, "OR3", vwap_D_n2ton1) + _chkCond(lib_vwap_D_below2s, "OR3", vwap_D_below2s) + _chkCond(lib_vwap_W_above2s, "OR3", vwap_W_above2s) + _chkCond(lib_vwap_W_1to2s, "OR3", vwap_W_1to2s) + _chkCond(lib_vwap_W_0to1s, "OR3", vwap_W_0to1s) + _chkCond(lib_vwap_W_atV, "OR3", vwap_W_atV) + _chkCond(lib_vwap_W_n1to0, "OR3", vwap_W_n1to0) + _chkCond(lib_vwap_W_n2ton1, "OR3", vwap_W_n2ton1) + _chkCond(lib_vwap_W_below2s, "OR3", vwap_W_below2s) + _chkCond(lib_vwap_M_above2s, "OR3", vwap_M_above2s) + _chkCond(lib_vwap_M_1to2s, "OR3", vwap_M_1to2s) + _chkCond(lib_vwap_M_0to1s, "OR3", vwap_M_0to1s) + _chkCond(lib_vwap_M_atV, "OR3", vwap_M_atV) + _chkCond(lib_vwap_M_n1to0, "OR3", vwap_M_n1to0) + _chkCond(lib_vwap_M_n2ton1, "OR3", vwap_M_n2ton1) + _chkCond(lib_vwap_M_below2s, "OR3", vwap_M_below2s)


//──────────────────────────────────────────────────────────────────────────────
// 9-4. GROUP PASS/FAIL EVALUATION
//──────────────────────────────────────────────────────────────────────────────

// AND Group: ALL must be true, empty = pass
bool and_pass = (and_total == 0) or (and_true == and_total)

// OR Groups: at least N must be true, empty = pass
bool or1_pass = (or1_total == 0) or (or1_true >= conf_or1_min)
bool or2_pass = (or2_total == 0) or (or2_true >= conf_or2_min)
bool or3_pass = (or3_total == 0) or (or3_true >= conf_or3_min)

// Overall confluence status (without trigger)
bool confluenceValid = and_pass and or1_pass and or2_pass and or3_pass

// Confluence status string for display
string confluenceStatus = confluenceValid ? "READY" : "WAIT"
string andStatus = and_total == 0 ? "n/a" : (and_pass ? str.tostring(and_true) + "/" + str.tostring(and_total) : str.tostring(and_true) + "/" + str.tostring(and_total) + " FAIL")
string or1Status = or1_total == 0 ? "n/a" : str.tostring(or1_true) + "/" + str.tostring(or1_total) + (or1_pass ? "" : " FAIL")
string or2Status = or2_total == 0 ? "n/a" : str.tostring(or2_true) + "/" + str.tostring(or2_total) + (or2_pass ? "" : " FAIL")
string or3Status = or3_total == 0 ? "n/a" : str.tostring(or3_true) + "/" + str.tostring(or3_total) + (or3_pass ? "" : " FAIL")


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 10. CENTRALIZED TRIGGER ROUTING
// Maps dropdown selection to actual library trigger signals
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

// Helper function to evaluate a trigger selection against all library outputs
_evalTrigger(string triggerSel) =>
    bool fired = false

    // EMA Stack Triggers (trigA-F: S>M, S<M, S>L, S<L, M>L, M<L crosses)
    if lib_ema_enabled
        if triggerSel == "EMA: S > M Cross"
            fired := lib_ema_v2.trigA
        else if triggerSel == "EMA: S < M Cross"
            fired := lib_ema_v2.trigB
        else if triggerSel == "EMA: S > L Cross"
            fired := lib_ema_v2.trigC
        else if triggerSel == "EMA: S < L Cross"
            fired := lib_ema_v2.trigD
        else if triggerSel == "EMA: M > L Cross"
            fired := lib_ema_v2.trigE
        else if triggerSel == "EMA: M < L Cross"
            fired := lib_ema_v2.trigF

    // UT Bot Triggers (trigA-B: Buy, Sell)
    if lib_utbot_enabled
        if triggerSel == "UT Bot: Buy"
            fired := lib_utbot_v2.trigA
        else if triggerSel == "UT Bot: Sell"
            fired := lib_utbot_v2.trigB

    // RVOL Triggers (trigA-C: Spike, Extreme, Fade)
    if lib_rvol_enabled
        if triggerSel == "RVOL: Volume Spike"
            fired := lib_rvol_v2.trigA
        else if triggerSel == "RVOL: Volume Extreme"
            fired := lib_rvol_v2.trigB
        else if triggerSel == "RVOL: Volume Fade"
            fired := lib_rvol_v2.trigC

    // Swing 123 Triggers (trigA-D: BC2, BC3, XC2, XC3)
    if lib_swing_enabled
        if triggerSel == "Swing: BC2"
            fired := lib_swing_v2.trigA
        else if triggerSel == "Swing: BC3"
            fired := lib_swing_v2.trigB
        else if triggerSel == "Swing: XC2"
            fired := lib_swing_v2.trigC
        else if triggerSel == "Swing: XC3"
            fired := lib_swing_v2.trigD

    // MACD Line Triggers (trigA-D: Bullish Cross, Bearish Cross, Zero Up, Zero Down)
    if lib_macdl_enabled
        if triggerSel == "MACD Line: Bullish Cross"
            fired := lib_macdl_v2.trigA
        else if triggerSel == "MACD Line: Bearish Cross"
            fired := lib_macdl_v2.trigB
        else if triggerSel == "MACD Line: Zero Cross Up"
            fired := lib_macdl_v2.trigC
        else if triggerSel == "MACD Line: Zero Cross Down"
            fired := lib_macdl_v2.trigD

    // MACD Histogram Triggers (trigA-D: Flip Bullish, Flip Bearish, Shift Up, Shift Down)
    if lib_macdh_enabled
        if triggerSel == "MACD Hist: Flip Bullish"
            fired := lib_macdh_v2.trigA
        else if triggerSel == "MACD Hist: Flip Bearish"
            fired := lib_macdh_v2.trigB
        else if triggerSel == "MACD Hist: Shift Up"
            fired := lib_macdh_v2.trigC
        else if triggerSel == "MACD Hist: Shift Down"
            fired := lib_macdh_v2.trigD

    // Simple MACD Triggers (trigA-B: Bullish Cross, Bearish Cross)
    if lib_macds_enabled
        if triggerSel == "Simple MACD: Bullish Cross"
            fired := lib_macds_v2.trigA
        else if triggerSel == "Simple MACD: Bearish Cross"
            fired := lib_macds_v2.trigB

    fired

// Evaluate selected entry and exit triggers
bool entryTriggerFired = entryTrigger != "None" and not str.startswith(entryTrigger, "─") ? _evalTrigger(entryTrigger) : false
bool exitTriggerFired  = exitTrigger  != "None" and not str.startswith(exitTrigger, "─")  ? _evalTrigger(exitTrigger)  : false

// Combined entry/exit signals (trigger + confluence)
bool validEntry = entryTriggerFired and confluenceValid
bool validExit  = exitTriggerFired  // Exit doesn't require confluence

// Raw trigger markers (when enabled)
plotshape(showRawEntryMarks and entryTriggerFired ? low : na, title = "Raw Entry Trigger",
    style = shape.triangleup, location = location.belowbar, color = color.new(color.blue, 50), size = size.tiny)
plotshape(showRawExitMarks and exitTriggerFired ? high : na, title = "Raw Exit Trigger",
    style = shape.triangledown, location = location.abovebar, color = color.new(color.orange, 50), size = size.tiny)


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 10. POSITION ENGINE
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Tracks position state and produces actual position entry/exit signals.
// v3.0: Direction-specific (Long OR Short based on positionDirection setting)
// Entry requires: validEntry (trigger + confluence) AND not already in position
// Exit requires: validExit (trigger) AND currently in position

//──────────────────────────────────────────────────────────────────────────────
// 10.1 Position State Machine
//──────────────────────────────────────────────────────────────────────────────

// Position state: false = flat, true = in position
var bool _kb_inPosition = false

// Output signals from Position Engine
bool positionEntry = false
bool positionExit  = false

// Entry logic: only enter if not already in position
if validEntry and not _kb_inPosition
    positionEntry := true
    _kb_inPosition := true

// Exit logic: only exit if currently in position
if validExit and _kb_inPosition
    positionExit := true
    _kb_inPosition := false

//──────────────────────────────────────────────────────────────────────────────
// 10.2 Position Quantity Calculator
//──────────────────────────────────────────────────────────────────────────────

// Calculate position size based on Risk Mode
_kb_calcQty(float price) =>
    float baseQty = defShares
    if riskMode == "Fixed $ Risk"
        baseQty := defRisk / (price * 0.01)
    else if riskMode == "Percentage Risk"
        baseQty := (acctSize * defRiskPct * 0.01) / (price * 0.01)
    baseQty

float positionQty = _kb_calcQty(close)


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 11. BACKTEST ENGINE
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// Tracks trade performance and calculates KPIs.
// Uses positionEntry/positionExit signals from Position Engine.

//──────────────────────────────────────────────────────────────────────────────
// 11.0 Backtest Filters
//──────────────────────────────────────────────────────────────────────────────

// Window filter
bool _bt_windowOk = true
if backWindow == "Fixed Bars"
    _bt_windowOk := bar_index >= (last_bar_index - backBars)
else if backWindow == "Date Range"
    _bt_windowOk := time >= backStartDate and (not backUseEnd or time <= backEndDate)

// Session filter
bool _bt_sessionOk = not na(time(timeframe.period, backSession))

// Day of week filter (dayofweek: 1=Sunday, 2=Monday, ..., 7=Saturday)
int _bt_dow = dayofweek
bool _bt_dowOk = (_bt_dow == 2 and backUseDOW_M) or (_bt_dow == 3 and backUseDOW_T) or (_bt_dow == 4 and backUseDOW_W) or (_bt_dow == 5 and backUseDOW_Th) or (_bt_dow == 6 and backUseDOW_F) or (_bt_dow == 7 and backUseDOW_Sa) or (_bt_dow == 1 and backUseDOW_Su)

// Combined filter
bool _kb_btFilterPass = _bt_windowOk and _bt_sessionOk and _bt_dowOk

//──────────────────────────────────────────────────────────────────────────────
// 11.1 Backtest State Variables
//──────────────────────────────────────────────────────────────────────────────

var bool   bt_positionActive = false
var string bt_positionSide   = "NONE"
var float  bt_entryPrice     = na
var float  bt_exitPrice      = na
var float  bt_qty            = 0.0
var float  bt_realizedPNL    = 0.0

var float  bt_lastTradePNL   = 0.0
var int    bt_totalTrades    = 0
var int    bt_winCount       = 0
var int    bt_lossCount      = 0

// Stats for Profit Factor + Drawdown
var float  bt_grossWin       = 0.0
var float  bt_grossLoss      = 0.0
var float  bt_maxDrawdown    = 0.0
var float  bt_peakEquity     = 0.0

//──────────────────────────────────────────────────────────────────────────────
// 11.2 Entry Logic (gated by backtest filters)
//──────────────────────────────────────────────────────────────────────────────

bool _btEntry = positionEntry and _kb_btFilterPass
float _entryFill = close

if _btEntry and not bt_positionActive
    bt_positionActive := true
    bt_positionSide   := isLongDirection ? "LONG" : "SHORT"
    bt_entryPrice     := _entryFill
    bt_qty            := _kb_calcQty(_entryFill)

//──────────────────────────────────────────────────────────────────────────────
// 11.3 Exit Logic
//──────────────────────────────────────────────────────────────────────────────

bool _btExit = positionExit
float _exitFill = close

if bt_positionActive and _btExit
    bt_exitPrice := _exitFill

    // Calculate PNL based on direction
    if bt_positionSide == "LONG"
        bt_lastTradePNL := (bt_exitPrice - bt_entryPrice) * bt_qty
    else
        bt_lastTradePNL := (bt_entryPrice - bt_exitPrice) * bt_qty

    bt_realizedPNL += bt_lastTradePNL
    bt_totalTrades += 1
    bt_winCount    += bt_lastTradePNL > 0 ? 1 : 0
    bt_lossCount   += bt_lastTradePNL < 0 ? 1 : 0

    // Profit Factor components
    if bt_lastTradePNL > 0
        bt_grossWin += bt_lastTradePNL
    else if bt_lastTradePNL < 0
        bt_grossLoss += bt_lastTradePNL

    // Max Drawdown tracking
    float _eq = bt_realizedPNL
    if _eq > bt_peakEquity
        bt_peakEquity := _eq
    float _dd = bt_peakEquity != 0.0 ? (bt_peakEquity - _eq) / math.abs(bt_peakEquity) : 0.0
    if _dd > bt_maxDrawdown
        bt_maxDrawdown := _dd

    // Reset position state
    bt_positionActive := false
    bt_positionSide   := "NONE"
    bt_qty            := 0


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 12. CHART SIGNALS & LABELS
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

//──────────────────────────────────────────────────────────────────────────────
// 12.1 Position Signal Marks
//──────────────────────────────────────────────────────────────────────────────
// Triangle up for entries, XCross for exits (following v2.0 pattern)

// Entry mark - Green triangle up (Long) or Red triangle down (Short)
plotshape(positionEntry and isLongDirection ? close : na, title = "Position Long Entry",
    style = shape.triangleup, location = location.absolute, color = color.green, size = size.normal)
plotshape(positionEntry and isShortDirection ? close : na, title = "Position Short Entry",
    style = shape.triangledown, location = location.absolute, color = color.red, size = size.normal)

// Exit mark - XCross (Green for Long exit, Red for Short exit)
plotshape(positionExit and isLongDirection ? close : na, title = "Position Long Exit",
    style = shape.xcross, location = location.absolute, color = color.green, size = size.normal)
plotshape(positionExit and isShortDirection ? close : na, title = "Position Short Exit",
    style = shape.xcross, location = location.absolute, color = color.red, size = size.normal)

//──────────────────────────────────────────────────────────────────────────────
// 12.2 Position Labels with Metadata
//──────────────────────────────────────────────────────────────────────────────

// Helper: Build position label text
_kb_buildPosLabel(string tradeType, float qty, float riskAmt) =>
    string txt = tradeType
    if lbl_qty
        txt := txt + "\nQty: " + str.tostring(qty, "#.##")
    if lbl_risk
        txt := txt + "\n$Risk: " + str.tostring(riskAmt, "#.##")
    txt

// Calculate dollar risk for label
float _lbl_dollarRisk = riskMode == "Fixed $ Risk" ? defRisk : riskMode == "Percentage Risk" ? (acctSize * defRiskPct * 0.01) : (close * 0.01 * defShares)

// Entry Labels
if barstate.islast == false and positionEntry and isLongDirection
    string _posLbl = _kb_buildPosLabel("LONG", positionQty, _lbl_dollarRisk)
    label.new(bar_index, low, _posLbl,
        style = label.style_label_up, color = color.green, textcolor = color.white, size = size.normal)

if barstate.islast == false and positionEntry and isShortDirection
    string _posLbl = _kb_buildPosLabel("SHORT", positionQty, _lbl_dollarRisk)
    label.new(bar_index, high, _posLbl,
        style = label.style_label_down, color = color.red, textcolor = color.white, size = size.normal)

// Exit Labels (with optional PNL display)
if barstate.islast == false and positionExit and isLongDirection
    string _exitLbl = "EXIT"
    if lbl_pnl
        string _pnlSign = bt_lastTradePNL >= 0 ? "+" : ""
        _exitLbl := _exitLbl + "\n" + _pnlSign + "$" + str.tostring(bt_lastTradePNL, "#.##")
    color _exitColor = bt_lastTradePNL >= 0 ? color.new(color.green, 50) : color.new(color.red, 50)
    label.new(bar_index, high, _exitLbl,
        style = label.style_label_down, color = _exitColor, textcolor = color.white, size = size.normal)

if barstate.islast == false and positionExit and isShortDirection
    string _exitLbl = "EXIT"
    if lbl_pnl
        string _pnlSign = bt_lastTradePNL >= 0 ? "+" : ""
        _exitLbl := _exitLbl + "\n" + _pnlSign + "$" + str.tostring(bt_lastTradePNL, "#.##")
    color _exitColor = bt_lastTradePNL >= 0 ? color.new(color.green, 50) : color.new(color.red, 50)
    label.new(bar_index, low, _exitLbl,
        style = label.style_label_up, color = _exitColor, textcolor = color.white, size = size.normal)


//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// 11. TABLE RENDERERS (Module-Based v2.0 Pattern)
// Top Table: 2-column × 5-row modules (header + 4 label/value rows)
// Side Table: Library conditions per timeframe with color coding
//━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

//──────────────────────────────────────────────────────────────────────────────
// 11-1. COLOR THEME (Theme-Aware)
//──────────────────────────────────────────────────────────────────────────────

// Top table colors
color _kb_headBg      = useDarkTheme ? color.new(color.blue, 40)   : color.new(color.blue, 70)   // Calculation modules
color _kb_confHeadBg  = useDarkTheme ? color.new(color.purple, 40) : color.new(color.purple, 70) // Confluence interpreter modules
color _kb_labBg       = useDarkTheme ? color.new(color.gray, 75)   : color.new(color.gray, 90)
color _kb_valBg       = useDarkTheme ? color.new(color.gray, 55)   : color.new(color.gray, 85)
color _kb_headTxt     = useDarkTheme ? color.white : color.new(color.black, 0)
color _kb_labTxt      = useDarkTheme ? color.white : color.new(color.black, 20)
color _kb_valTxt      = useDarkTheme ? color.white : color.new(color.black, 0)

// Side table colors
int _kb_sideTrans     = useDarkTheme ? 75 : 85
int _kb_sideTransOff  = useDarkTheme ? 85 : 90
color _kb_sideTxtCol  = useDarkTheme ? color.white : color.new(color.black, 0)
color _kb_sideHeadBg  = useDarkTheme ? color.new(color.gray, 65) : color.new(color.gray, 85)
color _kb_sideLabelBg = useDarkTheme ? color.new(color.gray, 75) : color.new(color.gray, 88)

// Side table cell color helper (v3.0: direction-specific)
// Green = condition assigned AND true (contributing)
// Yellow = condition assigned but NOT true (waiting)
// Gray = condition not assigned (not monitored)
f_sideTF_color(bool condTrue, bool isAssigned) =>
    color bg = color.new(color.gray, _kb_sideTransOff)  // Default: not assigned
    if isAssigned
        if condTrue
            bg := color.new(color.green, _kb_sideTrans)   // Condition TRUE (contributing)
        else
            bg := color.new(color.yellow, _kb_sideTrans)  // Condition assigned but FALSE (waiting)
    bg


//──────────────────────────────────────────────────────────────────────────────
// 11-2. TOP TABLE RENDERER (Module-Based Pattern)
//──────────────────────────────────────────────────────────────────────────────

// Module enable flags
bool useConfluence = true  // Always show confluence module in v3.0
bool useSizer      = showSizer
bool useBacktest   = showBack
bool useTopVWAP    = lib_vwap_enabled

// Count active modules for column allocation
int activeCount = 0
activeCount += useConfluence ? 1 : 0
activeCount += useSizer      ? 1 : 0
activeCount += useBacktest   ? 1 : 0
activeCount += useTopVWAP    ? 1 : 0

// Column assignment (modules shift left automatically)
int colConfluence = na
int colSizer      = na
int colBack       = na
int colTopVWAP    = na

int cursor = 0
if useConfluence
    colConfluence := cursor
    cursor += 1
if useSizer
    colSizer := cursor
    cursor += 1
if useBacktest
    colBack := cursor
    cursor += 1
if useTopVWAP
    colTopVWAP := cursor
    cursor += 1

// Each module uses 2 columns → multiply by 2
f_colStart(int block) => block * 2

// Initialize Top Table (10 columns max = 5 modules × 2, 5 rows)
var table kbTopTable = na
if enableTopTable and na(kbTopTable)
    kbTopTable := table.new(position.top_center, 10, 5, frame_width = 1, bgcolor = color.new(color.gray, 85))

// Standard module renderer (2 columns × 5 rows: header + 4 label/value pairs)
renderModule(int block, string title, string r1name, string r1val, string r2name, string r2val, string r3name, string r3val, string r4name, string r4val) =>
    int c = f_colStart(block)
    table.cell(kbTopTable, c,   0, title,  text_color=_kb_headTxt, bgcolor=_kb_headBg)
    table.cell(kbTopTable, c+1, 0, "",     text_color=_kb_headTxt, bgcolor=_kb_headBg)
    table.cell(kbTopTable, c,   1, r1name, text_color=_kb_labTxt,  bgcolor=_kb_labBg)
    table.cell(kbTopTable, c+1, 1, r1val,  text_color=_kb_valTxt,  bgcolor=_kb_valBg)
    table.cell(kbTopTable, c,   2, r2name, text_color=_kb_labTxt,  bgcolor=_kb_labBg)
    table.cell(kbTopTable, c+1, 2, r2val,  text_color=_kb_valTxt,  bgcolor=_kb_valBg)
    table.cell(kbTopTable, c,   3, r3name, text_color=_kb_labTxt,  bgcolor=_kb_labBg)
    table.cell(kbTopTable, c+1, 3, r3val,  text_color=_kb_valTxt,  bgcolor=_kb_valBg)
    table.cell(kbTopTable, c,   4, r4name, text_color=_kb_labTxt,  bgcolor=_kb_labBg)
    table.cell(kbTopTable, c+1, 4, r4val,  text_color=_kb_valTxt,  bgcolor=_kb_valBg)

// Confluence module renderer (purple header for interpreter modules)
renderModuleConf(int block, string title, string r1name, string r1val, string r2name, string r2val, string r3name, string r3val, string r4name, string r4val) =>
    int c = f_colStart(block)
    table.cell(kbTopTable, c,   0, title,  text_color=_kb_headTxt, bgcolor=_kb_confHeadBg)
    table.cell(kbTopTable, c+1, 0, "",     text_color=_kb_headTxt, bgcolor=_kb_confHeadBg)
    table.cell(kbTopTable, c,   1, r1name, text_color=_kb_labTxt,  bgcolor=_kb_labBg)
    table.cell(kbTopTable, c+1, 1, r1val,  text_color=_kb_valTxt,  bgcolor=_kb_valBg)
    table.cell(kbTopTable, c,   2, r2name, text_color=_kb_labTxt,  bgcolor=_kb_labBg)
    table.cell(kbTopTable, c+1, 2, r2val,  text_color=_kb_valTxt,  bgcolor=_kb_valBg)
    table.cell(kbTopTable, c,   3, r3name, text_color=_kb_labTxt,  bgcolor=_kb_labBg)
    table.cell(kbTopTable, c+1, 3, r3val,  text_color=_kb_valTxt,  bgcolor=_kb_valBg)
    table.cell(kbTopTable, c,   4, r4name, text_color=_kb_labTxt,  bgcolor=_kb_labBg)
    table.cell(kbTopTable, c+1, 4, r4val,  text_color=_kb_valTxt,  bgcolor=_kb_valBg)

// VWAP module renderer (with per-cell color coding)
// Color coding: Green = assigned+true, Yellow = assigned+false, Gray = unassigned
renderModuleVWAP(int block, string title, string r1val, string r2val, string r3val, string r4val, color c1, color c2, color c3) =>
    int c = f_colStart(block)
    table.cell(kbTopTable, c,   0, title,    text_color=_kb_headTxt, bgcolor=_kb_confHeadBg)
    table.cell(kbTopTable, c+1, 0, "",       text_color=_kb_headTxt, bgcolor=_kb_confHeadBg)
    table.cell(kbTopTable, c,   1, "Daily",  text_color=_kb_labTxt,  bgcolor=_kb_labBg)
    table.cell(kbTopTable, c+1, 1, r1val,    text_color=color.white, bgcolor=c1)
    table.cell(kbTopTable, c,   2, "Weekly", text_color=_kb_labTxt,  bgcolor=_kb_labBg)
    table.cell(kbTopTable, c+1, 2, r2val,    text_color=color.white, bgcolor=c2)
    table.cell(kbTopTable, c,   3, "Monthly",text_color=_kb_labTxt,  bgcolor=_kb_labBg)
    table.cell(kbTopTable, c+1, 3, r3val,    text_color=color.white, bgcolor=c3)
    table.cell(kbTopTable, c,   4, "Status", text_color=_kb_labTxt,  bgcolor=_kb_labBg)
    table.cell(kbTopTable, c+1, 4, r4val,    text_color=_kb_valTxt,  bgcolor=_kb_valBg)

// Helper to check if any VWAP zone for an anchor is assigned to a group
_vwapZoneAssigned(string anchor) =>
    bool assigned = false
    if anchor == "D"
        assigned := lib_vwap_D_above2s != "None" or lib_vwap_D_1to2s != "None" or lib_vwap_D_0to1s != "None" or lib_vwap_D_atV != "None" or lib_vwap_D_n1to0 != "None" or lib_vwap_D_n2ton1 != "None" or lib_vwap_D_below2s != "None"
    else if anchor == "W"
        assigned := lib_vwap_W_above2s != "None" or lib_vwap_W_1to2s != "None" or lib_vwap_W_0to1s != "None" or lib_vwap_W_atV != "None" or lib_vwap_W_n1to0 != "None" or lib_vwap_W_n2ton1 != "None" or lib_vwap_W_below2s != "None"
    else if anchor == "M"
        assigned := lib_vwap_M_above2s != "None" or lib_vwap_M_1to2s != "None" or lib_vwap_M_0to1s != "None" or lib_vwap_M_atV != "None" or lib_vwap_M_n1to0 != "None" or lib_vwap_M_n2ton1 != "None" or lib_vwap_M_below2s != "None"
    assigned

// Helper to check if current zone is the assigned zone (for color coding)
// Zone labels from _kb_vwapZoneLabel: ">+2σ", ">+1σ", ">V", "@V", "<V", "<-1σ", "<-2σ"
_vwapCurrentZoneIsAssigned(string anchor, string zone) =>
    bool isAssigned = false
    if anchor == "D"
        if zone == ">+2σ" and lib_vwap_D_above2s != "None"
            isAssigned := true
        else if zone == ">+1σ" and lib_vwap_D_1to2s != "None"
            isAssigned := true
        else if zone == ">V" and lib_vwap_D_0to1s != "None"
            isAssigned := true
        else if zone == "@V" and lib_vwap_D_atV != "None"
            isAssigned := true
        else if zone == "<V" and lib_vwap_D_n1to0 != "None"
            isAssigned := true
        else if zone == "<-1σ" and lib_vwap_D_n2ton1 != "None"
            isAssigned := true
        else if zone == "<-2σ" and lib_vwap_D_below2s != "None"
            isAssigned := true
    else if anchor == "W"
        if zone == ">+2σ" and lib_vwap_W_above2s != "None"
            isAssigned := true
        else if zone == ">+1σ" and lib_vwap_W_1to2s != "None"
            isAssigned := true
        else if zone == ">V" and lib_vwap_W_0to1s != "None"
            isAssigned := true
        else if zone == "@V" and lib_vwap_W_atV != "None"
            isAssigned := true
        else if zone == "<V" and lib_vwap_W_n1to0 != "None"
            isAssigned := true
        else if zone == "<-1σ" and lib_vwap_W_n2ton1 != "None"
            isAssigned := true
        else if zone == "<-2σ" and lib_vwap_W_below2s != "None"
            isAssigned := true
    else if anchor == "M"
        if zone == ">+2σ" and lib_vwap_M_above2s != "None"
            isAssigned := true
        else if zone == ">+1σ" and lib_vwap_M_1to2s != "None"
            isAssigned := true
        else if zone == ">V" and lib_vwap_M_0to1s != "None"
            isAssigned := true
        else if zone == "@V" and lib_vwap_M_atV != "None"
            isAssigned := true
        else if zone == "<V" and lib_vwap_M_n1to0 != "None"
            isAssigned := true
        else if zone == "<-1σ" and lib_vwap_M_n2ton1 != "None"
            isAssigned := true
        else if zone == "<-2σ" and lib_vwap_M_below2s != "None"
            isAssigned := true
    isAssigned

// Get color for VWAP zone cell
// Green = current zone is assigned and true, Yellow = assigned zone not current, Gray = no assignments
_vwapZoneColor(string anchor, string currentZone) =>
    color cellColor = color.new(color.gray, 50)  // Default: unassigned
    bool hasAnyAssignment = _vwapZoneAssigned(anchor)
    if hasAnyAssignment
        bool currentIsAssigned = _vwapCurrentZoneIsAssigned(anchor, currentZone)
        if currentIsAssigned
            cellColor := color.new(color.green, 30)  // Current zone IS the assigned zone
        else
            cellColor := color.new(color.yellow, 50) // Has assignment but current zone is not it
    cellColor

// Prepare module data
// CONFLUENCE MODULE (v3.0 - AND/OR system)
string conf_title  = "Confluence"
string conf_status = confluenceValid ? "VALID" : "WAIT"
string conf_and    = and_total == 0 ? "n/a" : str.tostring(and_true) + "/" + str.tostring(and_total)
string conf_or1    = or1_total == 0 ? "n/a" : str.tostring(or1_true) + "/" + str.tostring(or1_total)
string conf_or2    = or2_total == 0 ? "n/a" : str.tostring(or2_true) + "/" + str.tostring(or2_total)
string conf_or3    = or3_total == 0 ? "n/a" : str.tostring(or3_true) + "/" + str.tostring(or3_total)

// POSITION SIZING MODULE
string sizer_title = sizerName == "" ? "Position Sizing" : sizerName
float s_slPrice    = na
if sl_method == "ATR"
    s_slPrice := close - ta.atr(sl_atrPer) * sl_atrMult
else if sl_method == "Fixed Dollar"
    s_slPrice := close - sl_fixed
else if sl_method == "Percentage"
    s_slPrice := close * (1 - sl_pct * 0.01)
else if sl_method == "Candle Wicks"
    s_slPrice := low[sl_lookback] - sl_pad
string s_SL   = str.tostring(s_slPrice, format.mintick)
string s_RISK = riskMode == "Share Qty" ? "Shares" : riskMode == "Fixed $ Risk" ? "$" + str.tostring(defRisk) : str.tostring(defRiskPct) + "%"
float ps_qty  = defShares
string s_QTY  = str.tostring(ps_qty)

// BACKTEST KPIs MODULE
string back_title = backName == "" ? "Backtest KPIs" : backName
// Calculate Win Rate
float _bt_winRate = bt_totalTrades > 0 ? (bt_winCount / bt_totalTrades) * 100 : 0.0
string bt_wr = bt_totalTrades > 0 ? str.tostring(_bt_winRate, "#.#") + "%" : "—"
// Calculate Profit Factor
float _bt_profitFactor = bt_grossLoss != 0.0 ? math.abs(bt_grossWin / bt_grossLoss) : (bt_grossWin > 0 ? 999.0 : 0.0)
string bt_pf = bt_totalTrades > 0 ? str.tostring(_bt_profitFactor, "#.##") : "—"
// Max Drawdown
string bt_dd = bt_totalTrades > 0 ? str.tostring(bt_maxDrawdown * 100, "#.#") + "%" : "—"
// Total Trades (wins/losses)
string bt_tr = bt_totalTrades > 0 ? str.tostring(bt_totalTrades) + " (" + str.tostring(bt_winCount) + "W/" + str.tostring(bt_lossCount) + "L)" : "—"

// VWAP MODULE
string vwap_title = lib_vwap_name == "" ? "VWAP" : lib_vwap_name
string vwap_status = "—"

// Render modules
if enableTopTable and barstate.islast
    if useConfluence
        renderModuleConf(colConfluence, conf_title, "Status", conf_status, "AND", conf_and, "OR1", conf_or1, "OR2/OR3", conf_or2 + " / " + conf_or3)
    if useSizer
        renderModule(colSizer, sizer_title, "SL Method", sl_method, "SL Price", s_SL, "Risk", s_RISK, "Qty", s_QTY)
    if useBacktest
        renderModule(colBack, back_title, "WR", bt_wr, "PF", bt_pf, "Drawdown", bt_dd, "Trades", bt_tr)
    if useTopVWAP
        color vwap_D_color = _vwapZoneColor("D", lib_vwap_D_zone)
        color vwap_W_color = _vwapZoneColor("W", lib_vwap_W_zone)
        color vwap_M_color = _vwapZoneColor("M", lib_vwap_M_zone)
        renderModuleVWAP(colTopVWAP, vwap_title, lib_vwap_D_zone, lib_vwap_W_zone, lib_vwap_M_zone, vwap_status, vwap_D_color, vwap_W_color, vwap_M_color)


//──────────────────────────────────────────────────────────────────────────────
// 11-3. SIDE TABLE RENDERER (with TF Formatting and Color Coding)
//──────────────────────────────────────────────────────────────────────────────

// Use TimeUtils library for readable TF formatting
tf_fmt(string tf) => tu.tu_fmt(tf)

// Count enabled side libraries
int sideLibCount = 0
sideLibCount += lib_ema_enabled ? 1 : 0
sideLibCount += lib_rvol_enabled ? 1 : 0
sideLibCount += lib_utbot_enabled ? 1 : 0
sideLibCount += lib_swing_enabled ? 1 : 0
sideLibCount += lib_macdl_enabled ? 1 : 0
sideLibCount += lib_macdh_enabled ? 1 : 0
sideLibCount += lib_macds_enabled ? 1 : 0

// Initialize Side Table (7 columns: 1 label + 6 TFs, 11 rows: 1 header + 10 libs max)
var table _kb_sideTable = na
if enableSideTable and na(_kb_sideTable)
    _kb_sideTable := table.new(position.middle_right, 7, 11, frame_width = 1, bgcolor = color.new(color.gray, 85))

if barstate.islast and enableSideTable and sideLibCount > 0
    // Header row with formatted TF labels
    table.cell(_kb_sideTable, 0, 0, "Interpreter", bgcolor = _kb_sideHeadBg, text_color = _kb_sideTxtCol, text_halign = text.align_left)
    table.cell(_kb_sideTable, 1, 0, tf1_enabled ? tf_fmt(tf1) : "—", bgcolor = _kb_sideHeadBg, text_color = _kb_sideTxtCol, text_halign = text.align_center)
    table.cell(_kb_sideTable, 2, 0, tf2_enabled ? tf_fmt(tf2) : "—", bgcolor = _kb_sideHeadBg, text_color = _kb_sideTxtCol, text_halign = text.align_center)
    table.cell(_kb_sideTable, 3, 0, tf3_enabled ? tf_fmt(tf3) : "—", bgcolor = _kb_sideHeadBg, text_color = _kb_sideTxtCol, text_halign = text.align_center)
    table.cell(_kb_sideTable, 4, 0, tf4_enabled ? tf_fmt(tf4) : "—", bgcolor = _kb_sideHeadBg, text_color = _kb_sideTxtCol, text_halign = text.align_center)
    table.cell(_kb_sideTable, 5, 0, tf5_enabled ? tf_fmt(tf5) : "—", bgcolor = _kb_sideHeadBg, text_color = _kb_sideTxtCol, text_halign = text.align_center)
    table.cell(_kb_sideTable, 6, 0, tf6_enabled ? tf_fmt(tf6) : "—", bgcolor = _kb_sideHeadBg, text_color = _kb_sideTxtCol, text_halign = text.align_center)

    int row = 1

    // EMA Stack row with color coding
    if lib_ema_enabled
        string emaName = lib_ema_name != "" ? lib_ema_name : "EMA Stack"
        // Check if ANY condition from this library on each TF is assigned AND true
        // Using actual variable names: lib_ema_TF1_SML (A), lib_ema_TF1_LMS (B), lib_ema_TF1_SLM (C), lib_ema_TF1_MSL (D), lib_ema_TF1_MLS (E), lib_ema_TF1_LSM (F)
        bool ema_tf1_assigned = lib_ema_TF1_SML != "None" or lib_ema_TF1_LMS != "None" or lib_ema_TF1_SLM != "None" or lib_ema_TF1_MSL != "None" or lib_ema_TF1_MLS != "None" or lib_ema_TF1_LSM != "None"
        bool ema_tf1_true = (lib_ema_TF1_SML != "None" and lib_ema_v2.condA_tf1) or (lib_ema_TF1_LMS != "None" and lib_ema_v2.condB_tf1) or (lib_ema_TF1_SLM != "None" and lib_ema_v2.condC_tf1) or (lib_ema_TF1_MSL != "None" and lib_ema_v2.condD_tf1) or (lib_ema_TF1_MLS != "None" and lib_ema_v2.condE_tf1) or (lib_ema_TF1_LSM != "None" and lib_ema_v2.condF_tf1)
        bool ema_tf2_assigned = lib_ema_TF2_SML != "None" or lib_ema_TF2_LMS != "None" or lib_ema_TF2_SLM != "None" or lib_ema_TF2_MSL != "None" or lib_ema_TF2_MLS != "None" or lib_ema_TF2_LSM != "None"
        bool ema_tf2_true = (lib_ema_TF2_SML != "None" and lib_ema_v2.condA_tf2) or (lib_ema_TF2_LMS != "None" and lib_ema_v2.condB_tf2) or (lib_ema_TF2_SLM != "None" and lib_ema_v2.condC_tf2) or (lib_ema_TF2_MSL != "None" and lib_ema_v2.condD_tf2) or (lib_ema_TF2_MLS != "None" and lib_ema_v2.condE_tf2) or (lib_ema_TF2_LSM != "None" and lib_ema_v2.condF_tf2)
        bool ema_tf3_assigned = lib_ema_TF3_SML != "None" or lib_ema_TF3_LMS != "None" or lib_ema_TF3_SLM != "None" or lib_ema_TF3_MSL != "None" or lib_ema_TF3_MLS != "None" or lib_ema_TF3_LSM != "None"
        bool ema_tf3_true = (lib_ema_TF3_SML != "None" and lib_ema_v2.condA_tf3) or (lib_ema_TF3_LMS != "None" and lib_ema_v2.condB_tf3) or (lib_ema_TF3_SLM != "None" and lib_ema_v2.condC_tf3) or (lib_ema_TF3_MSL != "None" and lib_ema_v2.condD_tf3) or (lib_ema_TF3_MLS != "None" and lib_ema_v2.condE_tf3) or (lib_ema_TF3_LSM != "None" and lib_ema_v2.condF_tf3)
        bool ema_tf4_assigned = lib_ema_TF4_SML != "None" or lib_ema_TF4_LMS != "None" or lib_ema_TF4_SLM != "None" or lib_ema_TF4_MSL != "None" or lib_ema_TF4_MLS != "None" or lib_ema_TF4_LSM != "None"
        bool ema_tf4_true = (lib_ema_TF4_SML != "None" and lib_ema_v2.condA_tf4) or (lib_ema_TF4_LMS != "None" and lib_ema_v2.condB_tf4) or (lib_ema_TF4_SLM != "None" and lib_ema_v2.condC_tf4) or (lib_ema_TF4_MSL != "None" and lib_ema_v2.condD_tf4) or (lib_ema_TF4_MLS != "None" and lib_ema_v2.condE_tf4) or (lib_ema_TF4_LSM != "None" and lib_ema_v2.condF_tf4)
        bool ema_tf5_assigned = lib_ema_TF5_SML != "None" or lib_ema_TF5_LMS != "None" or lib_ema_TF5_SLM != "None" or lib_ema_TF5_MSL != "None" or lib_ema_TF5_MLS != "None" or lib_ema_TF5_LSM != "None"
        bool ema_tf5_true = (lib_ema_TF5_SML != "None" and lib_ema_v2.condA_tf5) or (lib_ema_TF5_LMS != "None" and lib_ema_v2.condB_tf5) or (lib_ema_TF5_SLM != "None" and lib_ema_v2.condC_tf5) or (lib_ema_TF5_MSL != "None" and lib_ema_v2.condD_tf5) or (lib_ema_TF5_MLS != "None" and lib_ema_v2.condE_tf5) or (lib_ema_TF5_LSM != "None" and lib_ema_v2.condF_tf5)
        bool ema_tf6_assigned = lib_ema_TF6_SML != "None" or lib_ema_TF6_LMS != "None" or lib_ema_TF6_SLM != "None" or lib_ema_TF6_MSL != "None" or lib_ema_TF6_MLS != "None" or lib_ema_TF6_LSM != "None"
        bool ema_tf6_true = (lib_ema_TF6_SML != "None" and lib_ema_v2.condA_tf6) or (lib_ema_TF6_LMS != "None" and lib_ema_v2.condB_tf6) or (lib_ema_TF6_SLM != "None" and lib_ema_v2.condC_tf6) or (lib_ema_TF6_MSL != "None" and lib_ema_v2.condD_tf6) or (lib_ema_TF6_MLS != "None" and lib_ema_v2.condE_tf6) or (lib_ema_TF6_LSM != "None" and lib_ema_v2.condF_tf6)

        table.cell(_kb_sideTable, 0, row, emaName, bgcolor = _kb_sideLabelBg, text_color = _kb_sideTxtCol, text_halign = text.align_left)
        table.cell(_kb_sideTable, 1, row, lib_ema_v2.tf1_label, bgcolor = f_sideTF_color(ema_tf1_true, ema_tf1_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 2, row, lib_ema_v2.tf2_label, bgcolor = f_sideTF_color(ema_tf2_true, ema_tf2_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 3, row, lib_ema_v2.tf3_label, bgcolor = f_sideTF_color(ema_tf3_true, ema_tf3_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 4, row, lib_ema_v2.tf4_label, bgcolor = f_sideTF_color(ema_tf4_true, ema_tf4_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 5, row, lib_ema_v2.tf5_label, bgcolor = f_sideTF_color(ema_tf5_true, ema_tf5_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 6, row, lib_ema_v2.tf6_label, bgcolor = f_sideTF_color(ema_tf6_true, ema_tf6_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        row += 1

    // RVOL row with color coding
    if lib_rvol_enabled
        string rvolName = lib_rvol_name != "" ? lib_rvol_name : "RVOL"
        // RVOL conditions: extreme(A), veryHigh(B), elevated(C), normal(D), low(E)
        bool rvol_tf1_assigned = lib_rvol_TF1_extreme != "None" or lib_rvol_TF1_veryHigh != "None" or lib_rvol_TF1_elevated != "None" or lib_rvol_TF1_normal != "None" or lib_rvol_TF1_low != "None"
        bool rvol_tf1_true = (lib_rvol_TF1_extreme != "None" and lib_rvol_v2.condA_tf1) or (lib_rvol_TF1_veryHigh != "None" and lib_rvol_v2.condB_tf1) or (lib_rvol_TF1_elevated != "None" and lib_rvol_v2.condC_tf1) or (lib_rvol_TF1_normal != "None" and lib_rvol_v2.condD_tf1) or (lib_rvol_TF1_low != "None" and lib_rvol_v2.condE_tf1)
        bool rvol_tf2_assigned = lib_rvol_TF2_extreme != "None" or lib_rvol_TF2_veryHigh != "None" or lib_rvol_TF2_elevated != "None" or lib_rvol_TF2_normal != "None" or lib_rvol_TF2_low != "None"
        bool rvol_tf2_true = (lib_rvol_TF2_extreme != "None" and lib_rvol_v2.condA_tf2) or (lib_rvol_TF2_veryHigh != "None" and lib_rvol_v2.condB_tf2) or (lib_rvol_TF2_elevated != "None" and lib_rvol_v2.condC_tf2) or (lib_rvol_TF2_normal != "None" and lib_rvol_v2.condD_tf2) or (lib_rvol_TF2_low != "None" and lib_rvol_v2.condE_tf2)
        bool rvol_tf3_assigned = lib_rvol_TF3_extreme != "None" or lib_rvol_TF3_veryHigh != "None" or lib_rvol_TF3_elevated != "None" or lib_rvol_TF3_normal != "None" or lib_rvol_TF3_low != "None"
        bool rvol_tf3_true = (lib_rvol_TF3_extreme != "None" and lib_rvol_v2.condA_tf3) or (lib_rvol_TF3_veryHigh != "None" and lib_rvol_v2.condB_tf3) or (lib_rvol_TF3_elevated != "None" and lib_rvol_v2.condC_tf3) or (lib_rvol_TF3_normal != "None" and lib_rvol_v2.condD_tf3) or (lib_rvol_TF3_low != "None" and lib_rvol_v2.condE_tf3)
        bool rvol_tf4_assigned = lib_rvol_TF4_extreme != "None" or lib_rvol_TF4_veryHigh != "None" or lib_rvol_TF4_elevated != "None" or lib_rvol_TF4_normal != "None" or lib_rvol_TF4_low != "None"
        bool rvol_tf4_true = (lib_rvol_TF4_extreme != "None" and lib_rvol_v2.condA_tf4) or (lib_rvol_TF4_veryHigh != "None" and lib_rvol_v2.condB_tf4) or (lib_rvol_TF4_elevated != "None" and lib_rvol_v2.condC_tf4) or (lib_rvol_TF4_normal != "None" and lib_rvol_v2.condD_tf4) or (lib_rvol_TF4_low != "None" and lib_rvol_v2.condE_tf4)
        bool rvol_tf5_assigned = lib_rvol_TF5_extreme != "None" or lib_rvol_TF5_veryHigh != "None" or lib_rvol_TF5_elevated != "None" or lib_rvol_TF5_normal != "None" or lib_rvol_TF5_low != "None"
        bool rvol_tf5_true = (lib_rvol_TF5_extreme != "None" and lib_rvol_v2.condA_tf5) or (lib_rvol_TF5_veryHigh != "None" and lib_rvol_v2.condB_tf5) or (lib_rvol_TF5_elevated != "None" and lib_rvol_v2.condC_tf5) or (lib_rvol_TF5_normal != "None" and lib_rvol_v2.condD_tf5) or (lib_rvol_TF5_low != "None" and lib_rvol_v2.condE_tf5)
        bool rvol_tf6_assigned = lib_rvol_TF6_extreme != "None" or lib_rvol_TF6_veryHigh != "None" or lib_rvol_TF6_elevated != "None" or lib_rvol_TF6_normal != "None" or lib_rvol_TF6_low != "None"
        bool rvol_tf6_true = (lib_rvol_TF6_extreme != "None" and lib_rvol_v2.condA_tf6) or (lib_rvol_TF6_veryHigh != "None" and lib_rvol_v2.condB_tf6) or (lib_rvol_TF6_elevated != "None" and lib_rvol_v2.condC_tf6) or (lib_rvol_TF6_normal != "None" and lib_rvol_v2.condD_tf6) or (lib_rvol_TF6_low != "None" and lib_rvol_v2.condE_tf6)
        table.cell(_kb_sideTable, 0, row, rvolName, bgcolor = _kb_sideLabelBg, text_color = _kb_sideTxtCol, text_halign = text.align_left)
        table.cell(_kb_sideTable, 1, row, lib_rvol_v2.tf1_label, bgcolor = f_sideTF_color(rvol_tf1_true, rvol_tf1_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 2, row, lib_rvol_v2.tf2_label, bgcolor = f_sideTF_color(rvol_tf2_true, rvol_tf2_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 3, row, lib_rvol_v2.tf3_label, bgcolor = f_sideTF_color(rvol_tf3_true, rvol_tf3_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 4, row, lib_rvol_v2.tf4_label, bgcolor = f_sideTF_color(rvol_tf4_true, rvol_tf4_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 5, row, lib_rvol_v2.tf5_label, bgcolor = f_sideTF_color(rvol_tf5_true, rvol_tf5_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 6, row, lib_rvol_v2.tf6_label, bgcolor = f_sideTF_color(rvol_tf6_true, rvol_tf6_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        row += 1

    // UT Bot row with color coding
    if lib_utbot_enabled
        string utbotName = lib_utbot_name != "" ? lib_utbot_name : "UT Bot"
        // UT Bot conditions: bull(A), bear(B)
        bool utbot_tf1_assigned = lib_utbot_TF1_bull != "None" or lib_utbot_TF1_bear != "None"
        bool utbot_tf1_true = (lib_utbot_TF1_bull != "None" and lib_utbot_v2.condA_tf1) or (lib_utbot_TF1_bear != "None" and lib_utbot_v2.condB_tf1)
        bool utbot_tf2_assigned = lib_utbot_TF2_bull != "None" or lib_utbot_TF2_bear != "None"
        bool utbot_tf2_true = (lib_utbot_TF2_bull != "None" and lib_utbot_v2.condA_tf2) or (lib_utbot_TF2_bear != "None" and lib_utbot_v2.condB_tf2)
        bool utbot_tf3_assigned = lib_utbot_TF3_bull != "None" or lib_utbot_TF3_bear != "None"
        bool utbot_tf3_true = (lib_utbot_TF3_bull != "None" and lib_utbot_v2.condA_tf3) or (lib_utbot_TF3_bear != "None" and lib_utbot_v2.condB_tf3)
        bool utbot_tf4_assigned = lib_utbot_TF4_bull != "None" or lib_utbot_TF4_bear != "None"
        bool utbot_tf4_true = (lib_utbot_TF4_bull != "None" and lib_utbot_v2.condA_tf4) or (lib_utbot_TF4_bear != "None" and lib_utbot_v2.condB_tf4)
        bool utbot_tf5_assigned = lib_utbot_TF5_bull != "None" or lib_utbot_TF5_bear != "None"
        bool utbot_tf5_true = (lib_utbot_TF5_bull != "None" and lib_utbot_v2.condA_tf5) or (lib_utbot_TF5_bear != "None" and lib_utbot_v2.condB_tf5)
        bool utbot_tf6_assigned = lib_utbot_TF6_bull != "None" or lib_utbot_TF6_bear != "None"
        bool utbot_tf6_true = (lib_utbot_TF6_bull != "None" and lib_utbot_v2.condA_tf6) or (lib_utbot_TF6_bear != "None" and lib_utbot_v2.condB_tf6)
        table.cell(_kb_sideTable, 0, row, utbotName, bgcolor = _kb_sideLabelBg, text_color = _kb_sideTxtCol, text_halign = text.align_left)
        table.cell(_kb_sideTable, 1, row, lib_utbot_v2.tf1_label, bgcolor = f_sideTF_color(utbot_tf1_true, utbot_tf1_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 2, row, lib_utbot_v2.tf2_label, bgcolor = f_sideTF_color(utbot_tf2_true, utbot_tf2_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 3, row, lib_utbot_v2.tf3_label, bgcolor = f_sideTF_color(utbot_tf3_true, utbot_tf3_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 4, row, lib_utbot_v2.tf4_label, bgcolor = f_sideTF_color(utbot_tf4_true, utbot_tf4_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 5, row, lib_utbot_v2.tf5_label, bgcolor = f_sideTF_color(utbot_tf5_true, utbot_tf5_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 6, row, lib_utbot_v2.tf6_label, bgcolor = f_sideTF_color(utbot_tf6_true, utbot_tf6_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        row += 1

    // Swing 123 row with color coding
    if lib_swing_enabled
        string swingName = lib_swing_name != "" ? lib_swing_name : "Swing 123"
        // Swing conditions: BC2(A), BC3(B), XC2(C), XC3(D), Bup(E), Xdn(F)
        bool swing_tf1_assigned = lib_swing_TF1_BC2 != "None" or lib_swing_TF1_BC3 != "None" or lib_swing_TF1_XC2 != "None" or lib_swing_TF1_XC3 != "None" or lib_swing_TF1_Bup != "None" or lib_swing_TF1_Xdn != "None"
        bool swing_tf1_true = (lib_swing_TF1_BC2 != "None" and lib_swing_v2.condA_tf1) or (lib_swing_TF1_BC3 != "None" and lib_swing_v2.condB_tf1) or (lib_swing_TF1_XC2 != "None" and lib_swing_v2.condC_tf1) or (lib_swing_TF1_XC3 != "None" and lib_swing_v2.condD_tf1) or (lib_swing_TF1_Bup != "None" and lib_swing_v2.condE_tf1) or (lib_swing_TF1_Xdn != "None" and lib_swing_v2.condF_tf1)
        bool swing_tf2_assigned = lib_swing_TF2_BC2 != "None" or lib_swing_TF2_BC3 != "None" or lib_swing_TF2_XC2 != "None" or lib_swing_TF2_XC3 != "None" or lib_swing_TF2_Bup != "None" or lib_swing_TF2_Xdn != "None"
        bool swing_tf2_true = (lib_swing_TF2_BC2 != "None" and lib_swing_v2.condA_tf2) or (lib_swing_TF2_BC3 != "None" and lib_swing_v2.condB_tf2) or (lib_swing_TF2_XC2 != "None" and lib_swing_v2.condC_tf2) or (lib_swing_TF2_XC3 != "None" and lib_swing_v2.condD_tf2) or (lib_swing_TF2_Bup != "None" and lib_swing_v2.condE_tf2) or (lib_swing_TF2_Xdn != "None" and lib_swing_v2.condF_tf2)
        bool swing_tf3_assigned = lib_swing_TF3_BC2 != "None" or lib_swing_TF3_BC3 != "None" or lib_swing_TF3_XC2 != "None" or lib_swing_TF3_XC3 != "None" or lib_swing_TF3_Bup != "None" or lib_swing_TF3_Xdn != "None"
        bool swing_tf3_true = (lib_swing_TF3_BC2 != "None" and lib_swing_v2.condA_tf3) or (lib_swing_TF3_BC3 != "None" and lib_swing_v2.condB_tf3) or (lib_swing_TF3_XC2 != "None" and lib_swing_v2.condC_tf3) or (lib_swing_TF3_XC3 != "None" and lib_swing_v2.condD_tf3) or (lib_swing_TF3_Bup != "None" and lib_swing_v2.condE_tf3) or (lib_swing_TF3_Xdn != "None" and lib_swing_v2.condF_tf3)
        bool swing_tf4_assigned = lib_swing_TF4_BC2 != "None" or lib_swing_TF4_BC3 != "None" or lib_swing_TF4_XC2 != "None" or lib_swing_TF4_XC3 != "None" or lib_swing_TF4_Bup != "None" or lib_swing_TF4_Xdn != "None"
        bool swing_tf4_true = (lib_swing_TF4_BC2 != "None" and lib_swing_v2.condA_tf4) or (lib_swing_TF4_BC3 != "None" and lib_swing_v2.condB_tf4) or (lib_swing_TF4_XC2 != "None" and lib_swing_v2.condC_tf4) or (lib_swing_TF4_XC3 != "None" and lib_swing_v2.condD_tf4) or (lib_swing_TF4_Bup != "None" and lib_swing_v2.condE_tf4) or (lib_swing_TF4_Xdn != "None" and lib_swing_v2.condF_tf4)
        bool swing_tf5_assigned = lib_swing_TF5_BC2 != "None" or lib_swing_TF5_BC3 != "None" or lib_swing_TF5_XC2 != "None" or lib_swing_TF5_XC3 != "None" or lib_swing_TF5_Bup != "None" or lib_swing_TF5_Xdn != "None"
        bool swing_tf5_true = (lib_swing_TF5_BC2 != "None" and lib_swing_v2.condA_tf5) or (lib_swing_TF5_BC3 != "None" and lib_swing_v2.condB_tf5) or (lib_swing_TF5_XC2 != "None" and lib_swing_v2.condC_tf5) or (lib_swing_TF5_XC3 != "None" and lib_swing_v2.condD_tf5) or (lib_swing_TF5_Bup != "None" and lib_swing_v2.condE_tf5) or (lib_swing_TF5_Xdn != "None" and lib_swing_v2.condF_tf5)
        bool swing_tf6_assigned = lib_swing_TF6_BC2 != "None" or lib_swing_TF6_BC3 != "None" or lib_swing_TF6_XC2 != "None" or lib_swing_TF6_XC3 != "None" or lib_swing_TF6_Bup != "None" or lib_swing_TF6_Xdn != "None"
        bool swing_tf6_true = (lib_swing_TF6_BC2 != "None" and lib_swing_v2.condA_tf6) or (lib_swing_TF6_BC3 != "None" and lib_swing_v2.condB_tf6) or (lib_swing_TF6_XC2 != "None" and lib_swing_v2.condC_tf6) or (lib_swing_TF6_XC3 != "None" and lib_swing_v2.condD_tf6) or (lib_swing_TF6_Bup != "None" and lib_swing_v2.condE_tf6) or (lib_swing_TF6_Xdn != "None" and lib_swing_v2.condF_tf6)
        table.cell(_kb_sideTable, 0, row, swingName, bgcolor = _kb_sideLabelBg, text_color = _kb_sideTxtCol, text_halign = text.align_left)
        table.cell(_kb_sideTable, 1, row, lib_swing_v2.tf1_label, bgcolor = f_sideTF_color(swing_tf1_true, swing_tf1_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 2, row, lib_swing_v2.tf2_label, bgcolor = f_sideTF_color(swing_tf2_true, swing_tf2_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 3, row, lib_swing_v2.tf3_label, bgcolor = f_sideTF_color(swing_tf3_true, swing_tf3_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 4, row, lib_swing_v2.tf4_label, bgcolor = f_sideTF_color(swing_tf4_true, swing_tf4_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 5, row, lib_swing_v2.tf5_label, bgcolor = f_sideTF_color(swing_tf5_true, swing_tf5_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 6, row, lib_swing_v2.tf6_label, bgcolor = f_sideTF_color(swing_tf6_true, swing_tf6_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        row += 1

    // MACD Line row with color coding
    if lib_macdl_enabled
        string macdlName = lib_macdl_name != "" ? lib_macdl_name : "MACD Line"
        // MACD Line conditions: aboveRising(A), aboveFalling(B), belowFalling(C), belowRising(D)
        bool macdl_tf1_assigned = lib_macdl_TF1_aboveRising != "None" or lib_macdl_TF1_aboveFalling != "None" or lib_macdl_TF1_belowFalling != "None" or lib_macdl_TF1_belowRising != "None"
        bool macdl_tf1_true = (lib_macdl_TF1_aboveRising != "None" and lib_macdl_v2.condA_tf1) or (lib_macdl_TF1_aboveFalling != "None" and lib_macdl_v2.condB_tf1) or (lib_macdl_TF1_belowFalling != "None" and lib_macdl_v2.condC_tf1) or (lib_macdl_TF1_belowRising != "None" and lib_macdl_v2.condD_tf1)
        bool macdl_tf2_assigned = lib_macdl_TF2_aboveRising != "None" or lib_macdl_TF2_aboveFalling != "None" or lib_macdl_TF2_belowFalling != "None" or lib_macdl_TF2_belowRising != "None"
        bool macdl_tf2_true = (lib_macdl_TF2_aboveRising != "None" and lib_macdl_v2.condA_tf2) or (lib_macdl_TF2_aboveFalling != "None" and lib_macdl_v2.condB_tf2) or (lib_macdl_TF2_belowFalling != "None" and lib_macdl_v2.condC_tf2) or (lib_macdl_TF2_belowRising != "None" and lib_macdl_v2.condD_tf2)
        bool macdl_tf3_assigned = lib_macdl_TF3_aboveRising != "None" or lib_macdl_TF3_aboveFalling != "None" or lib_macdl_TF3_belowFalling != "None" or lib_macdl_TF3_belowRising != "None"
        bool macdl_tf3_true = (lib_macdl_TF3_aboveRising != "None" and lib_macdl_v2.condA_tf3) or (lib_macdl_TF3_aboveFalling != "None" and lib_macdl_v2.condB_tf3) or (lib_macdl_TF3_belowFalling != "None" and lib_macdl_v2.condC_tf3) or (lib_macdl_TF3_belowRising != "None" and lib_macdl_v2.condD_tf3)
        bool macdl_tf4_assigned = lib_macdl_TF4_aboveRising != "None" or lib_macdl_TF4_aboveFalling != "None" or lib_macdl_TF4_belowFalling != "None" or lib_macdl_TF4_belowRising != "None"
        bool macdl_tf4_true = (lib_macdl_TF4_aboveRising != "None" and lib_macdl_v2.condA_tf4) or (lib_macdl_TF4_aboveFalling != "None" and lib_macdl_v2.condB_tf4) or (lib_macdl_TF4_belowFalling != "None" and lib_macdl_v2.condC_tf4) or (lib_macdl_TF4_belowRising != "None" and lib_macdl_v2.condD_tf4)
        bool macdl_tf5_assigned = lib_macdl_TF5_aboveRising != "None" or lib_macdl_TF5_aboveFalling != "None" or lib_macdl_TF5_belowFalling != "None" or lib_macdl_TF5_belowRising != "None"
        bool macdl_tf5_true = (lib_macdl_TF5_aboveRising != "None" and lib_macdl_v2.condA_tf5) or (lib_macdl_TF5_aboveFalling != "None" and lib_macdl_v2.condB_tf5) or (lib_macdl_TF5_belowFalling != "None" and lib_macdl_v2.condC_tf5) or (lib_macdl_TF5_belowRising != "None" and lib_macdl_v2.condD_tf5)
        bool macdl_tf6_assigned = lib_macdl_TF6_aboveRising != "None" or lib_macdl_TF6_aboveFalling != "None" or lib_macdl_TF6_belowFalling != "None" or lib_macdl_TF6_belowRising != "None"
        bool macdl_tf6_true = (lib_macdl_TF6_aboveRising != "None" and lib_macdl_v2.condA_tf6) or (lib_macdl_TF6_aboveFalling != "None" and lib_macdl_v2.condB_tf6) or (lib_macdl_TF6_belowFalling != "None" and lib_macdl_v2.condC_tf6) or (lib_macdl_TF6_belowRising != "None" and lib_macdl_v2.condD_tf6)
        table.cell(_kb_sideTable, 0, row, macdlName, bgcolor = _kb_sideLabelBg, text_color = _kb_sideTxtCol, text_halign = text.align_left)
        table.cell(_kb_sideTable, 1, row, lib_macdl_v2.tf1_label, bgcolor = f_sideTF_color(macdl_tf1_true, macdl_tf1_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 2, row, lib_macdl_v2.tf2_label, bgcolor = f_sideTF_color(macdl_tf2_true, macdl_tf2_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 3, row, lib_macdl_v2.tf3_label, bgcolor = f_sideTF_color(macdl_tf3_true, macdl_tf3_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 4, row, lib_macdl_v2.tf4_label, bgcolor = f_sideTF_color(macdl_tf4_true, macdl_tf4_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 5, row, lib_macdl_v2.tf5_label, bgcolor = f_sideTF_color(macdl_tf5_true, macdl_tf5_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 6, row, lib_macdl_v2.tf6_label, bgcolor = f_sideTF_color(macdl_tf6_true, macdl_tf6_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        row += 1

    // MACD Histogram row with color coding
    if lib_macdh_enabled
        string macdhName = lib_macdh_name != "" ? lib_macdh_name : "MACD Hist"
        // MACD Hist conditions: posRising(A), posFalling(B), negFalling(C), negRising(D)
        bool macdh_tf1_assigned = lib_macdh_TF1_posRising != "None" or lib_macdh_TF1_posFalling != "None" or lib_macdh_TF1_negFalling != "None" or lib_macdh_TF1_negRising != "None"
        bool macdh_tf1_true = (lib_macdh_TF1_posRising != "None" and lib_macdh_v2.condA_tf1) or (lib_macdh_TF1_posFalling != "None" and lib_macdh_v2.condB_tf1) or (lib_macdh_TF1_negFalling != "None" and lib_macdh_v2.condC_tf1) or (lib_macdh_TF1_negRising != "None" and lib_macdh_v2.condD_tf1)
        bool macdh_tf2_assigned = lib_macdh_TF2_posRising != "None" or lib_macdh_TF2_posFalling != "None" or lib_macdh_TF2_negFalling != "None" or lib_macdh_TF2_negRising != "None"
        bool macdh_tf2_true = (lib_macdh_TF2_posRising != "None" and lib_macdh_v2.condA_tf2) or (lib_macdh_TF2_posFalling != "None" and lib_macdh_v2.condB_tf2) or (lib_macdh_TF2_negFalling != "None" and lib_macdh_v2.condC_tf2) or (lib_macdh_TF2_negRising != "None" and lib_macdh_v2.condD_tf2)
        bool macdh_tf3_assigned = lib_macdh_TF3_posRising != "None" or lib_macdh_TF3_posFalling != "None" or lib_macdh_TF3_negFalling != "None" or lib_macdh_TF3_negRising != "None"
        bool macdh_tf3_true = (lib_macdh_TF3_posRising != "None" and lib_macdh_v2.condA_tf3) or (lib_macdh_TF3_posFalling != "None" and lib_macdh_v2.condB_tf3) or (lib_macdh_TF3_negFalling != "None" and lib_macdh_v2.condC_tf3) or (lib_macdh_TF3_negRising != "None" and lib_macdh_v2.condD_tf3)
        bool macdh_tf4_assigned = lib_macdh_TF4_posRising != "None" or lib_macdh_TF4_posFalling != "None" or lib_macdh_TF4_negFalling != "None" or lib_macdh_TF4_negRising != "None"
        bool macdh_tf4_true = (lib_macdh_TF4_posRising != "None" and lib_macdh_v2.condA_tf4) or (lib_macdh_TF4_posFalling != "None" and lib_macdh_v2.condB_tf4) or (lib_macdh_TF4_negFalling != "None" and lib_macdh_v2.condC_tf4) or (lib_macdh_TF4_negRising != "None" and lib_macdh_v2.condD_tf4)
        bool macdh_tf5_assigned = lib_macdh_TF5_posRising != "None" or lib_macdh_TF5_posFalling != "None" or lib_macdh_TF5_negFalling != "None" or lib_macdh_TF5_negRising != "None"
        bool macdh_tf5_true = (lib_macdh_TF5_posRising != "None" and lib_macdh_v2.condA_tf5) or (lib_macdh_TF5_posFalling != "None" and lib_macdh_v2.condB_tf5) or (lib_macdh_TF5_negFalling != "None" and lib_macdh_v2.condC_tf5) or (lib_macdh_TF5_negRising != "None" and lib_macdh_v2.condD_tf5)
        bool macdh_tf6_assigned = lib_macdh_TF6_posRising != "None" or lib_macdh_TF6_posFalling != "None" or lib_macdh_TF6_negFalling != "None" or lib_macdh_TF6_negRising != "None"
        bool macdh_tf6_true = (lib_macdh_TF6_posRising != "None" and lib_macdh_v2.condA_tf6) or (lib_macdh_TF6_posFalling != "None" and lib_macdh_v2.condB_tf6) or (lib_macdh_TF6_negFalling != "None" and lib_macdh_v2.condC_tf6) or (lib_macdh_TF6_negRising != "None" and lib_macdh_v2.condD_tf6)
        table.cell(_kb_sideTable, 0, row, macdhName, bgcolor = _kb_sideLabelBg, text_color = _kb_sideTxtCol, text_halign = text.align_left)
        table.cell(_kb_sideTable, 1, row, lib_macdh_v2.tf1_label, bgcolor = f_sideTF_color(macdh_tf1_true, macdh_tf1_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 2, row, lib_macdh_v2.tf2_label, bgcolor = f_sideTF_color(macdh_tf2_true, macdh_tf2_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 3, row, lib_macdh_v2.tf3_label, bgcolor = f_sideTF_color(macdh_tf3_true, macdh_tf3_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 4, row, lib_macdh_v2.tf4_label, bgcolor = f_sideTF_color(macdh_tf4_true, macdh_tf4_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 5, row, lib_macdh_v2.tf5_label, bgcolor = f_sideTF_color(macdh_tf5_true, macdh_tf5_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 6, row, lib_macdh_v2.tf6_label, bgcolor = f_sideTF_color(macdh_tf6_true, macdh_tf6_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        row += 1

    // Simple MACD row with color coding
    if lib_macds_enabled
        string macdsName = lib_macds_name != "" ? lib_macds_name : "Simple MACD"
        // Simple MACD conditions: aboveCrossUp(A), aboveCrossDown(B), belowCrossDown(C), belowCrossUp(D)
        bool macds_tf1_assigned = lib_macds_TF1_aboveCrossUp != "None" or lib_macds_TF1_aboveCrossDown != "None" or lib_macds_TF1_belowCrossDown != "None" or lib_macds_TF1_belowCrossUp != "None"
        bool macds_tf1_true = (lib_macds_TF1_aboveCrossUp != "None" and lib_macds_v2.condA_tf1) or (lib_macds_TF1_aboveCrossDown != "None" and lib_macds_v2.condB_tf1) or (lib_macds_TF1_belowCrossDown != "None" and lib_macds_v2.condC_tf1) or (lib_macds_TF1_belowCrossUp != "None" and lib_macds_v2.condD_tf1)
        bool macds_tf2_assigned = lib_macds_TF2_aboveCrossUp != "None" or lib_macds_TF2_aboveCrossDown != "None" or lib_macds_TF2_belowCrossDown != "None" or lib_macds_TF2_belowCrossUp != "None"
        bool macds_tf2_true = (lib_macds_TF2_aboveCrossUp != "None" and lib_macds_v2.condA_tf2) or (lib_macds_TF2_aboveCrossDown != "None" and lib_macds_v2.condB_tf2) or (lib_macds_TF2_belowCrossDown != "None" and lib_macds_v2.condC_tf2) or (lib_macds_TF2_belowCrossUp != "None" and lib_macds_v2.condD_tf2)
        bool macds_tf3_assigned = lib_macds_TF3_aboveCrossUp != "None" or lib_macds_TF3_aboveCrossDown != "None" or lib_macds_TF3_belowCrossDown != "None" or lib_macds_TF3_belowCrossUp != "None"
        bool macds_tf3_true = (lib_macds_TF3_aboveCrossUp != "None" and lib_macds_v2.condA_tf3) or (lib_macds_TF3_aboveCrossDown != "None" and lib_macds_v2.condB_tf3) or (lib_macds_TF3_belowCrossDown != "None" and lib_macds_v2.condC_tf3) or (lib_macds_TF3_belowCrossUp != "None" and lib_macds_v2.condD_tf3)
        bool macds_tf4_assigned = lib_macds_TF4_aboveCrossUp != "None" or lib_macds_TF4_aboveCrossDown != "None" or lib_macds_TF4_belowCrossDown != "None" or lib_macds_TF4_belowCrossUp != "None"
        bool macds_tf4_true = (lib_macds_TF4_aboveCrossUp != "None" and lib_macds_v2.condA_tf4) or (lib_macds_TF4_aboveCrossDown != "None" and lib_macds_v2.condB_tf4) or (lib_macds_TF4_belowCrossDown != "None" and lib_macds_v2.condC_tf4) or (lib_macds_TF4_belowCrossUp != "None" and lib_macds_v2.condD_tf4)
        bool macds_tf5_assigned = lib_macds_TF5_aboveCrossUp != "None" or lib_macds_TF5_aboveCrossDown != "None" or lib_macds_TF5_belowCrossDown != "None" or lib_macds_TF5_belowCrossUp != "None"
        bool macds_tf5_true = (lib_macds_TF5_aboveCrossUp != "None" and lib_macds_v2.condA_tf5) or (lib_macds_TF5_aboveCrossDown != "None" and lib_macds_v2.condB_tf5) or (lib_macds_TF5_belowCrossDown != "None" and lib_macds_v2.condC_tf5) or (lib_macds_TF5_belowCrossUp != "None" and lib_macds_v2.condD_tf5)
        bool macds_tf6_assigned = lib_macds_TF6_aboveCrossUp != "None" or lib_macds_TF6_aboveCrossDown != "None" or lib_macds_TF6_belowCrossDown != "None" or lib_macds_TF6_belowCrossUp != "None"
        bool macds_tf6_true = (lib_macds_TF6_aboveCrossUp != "None" and lib_macds_v2.condA_tf6) or (lib_macds_TF6_aboveCrossDown != "None" and lib_macds_v2.condB_tf6) or (lib_macds_TF6_belowCrossDown != "None" and lib_macds_v2.condC_tf6) or (lib_macds_TF6_belowCrossUp != "None" and lib_macds_v2.condD_tf6)
        table.cell(_kb_sideTable, 0, row, macdsName, bgcolor = _kb_sideLabelBg, text_color = _kb_sideTxtCol, text_halign = text.align_left)
        table.cell(_kb_sideTable, 1, row, lib_macds_v2.tf1_label, bgcolor = f_sideTF_color(macds_tf1_true, macds_tf1_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 2, row, lib_macds_v2.tf2_label, bgcolor = f_sideTF_color(macds_tf2_true, macds_tf2_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 3, row, lib_macds_v2.tf3_label, bgcolor = f_sideTF_color(macds_tf3_true, macds_tf3_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 4, row, lib_macds_v2.tf4_label, bgcolor = f_sideTF_color(macds_tf4_true, macds_tf4_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 5, row, lib_macds_v2.tf5_label, bgcolor = f_sideTF_color(macds_tf5_true, macds_tf5_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
        table.cell(_kb_sideTable, 6, row, lib_macds_v2.tf6_label, bgcolor = f_sideTF_color(macds_tf6_true, macds_tf6_assigned), text_color = _kb_sideTxtCol, text_halign = text.align_center)
